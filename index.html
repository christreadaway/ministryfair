<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ministry Fair</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Crimson Pro', Georgia, serif;
      background: linear-gradient(145deg, #faf8f5 0%, #f5f0e8 100%);
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #8B2635 0%, #6B1D29 100%);
      color: white;
      padding: 24px 20px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(107, 29, 41, 0.3);
    }
    .header h1 {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .header p {
      margin-top: 8px;
      font-size: 15px;
      opacity: 0.9;
    }
    .content {
      padding: 24px 20px;
      max-width: 500px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 28px 24px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    .welcome-text {
      font-size: 17px;
      line-height: 1.7;
      color: #4a4a4a;
      margin-bottom: 24px;
    }
    .form { display: flex; flex-direction: column; gap: 18px; }
    .input-row { display: flex; gap: 12px; }
    .input-group { display: flex; flex-direction: column; gap: 6px; flex: 1; }
    .label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .input, .select {
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid #e8e4de;
      border-radius: 10px;
      outline: none;
      font-family: 'Inter', -apple-system, sans-serif;
      width: 100%;
    }
    .input:focus, .select:focus { border-color: #8B2635; }
    .select { background: white; cursor: pointer; }
    .btn {
      background: linear-gradient(135deg, #8B2635 0%, #6B1D29 100%);
      color: white;
      border: none;
      padding: 16px 24px;
      font-size: 17px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Crimson Pro', Georgia, serif;
      letter-spacing: 0.3px;
      box-shadow: 0 4px 14px rgba(139, 38, 53, 0.35);
      width: 100%;
      margin-top: 8px;
    }
    .btn:disabled { opacity: 0.7; cursor: wait; }
    .btn-secondary {
      background: white;
      color: #8B2635;
      border: 2px solid #8B2635;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Crimson Pro', Georgia, serif;
      width: 100%;
    }
    .btn-green { background: linear-gradient(135deg, #4a9c6d 0%, #3d8259 100%); box-shadow: 0 4px 14px rgba(74, 156, 109, 0.35); }
    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, #f0f7ff 0%, #e8f2ff 100%);
      border-radius: 10px;
      border: 1px solid #d0e3ff;
    }
    .checkbox-group input[type="checkbox"] {
      margin-top: 3px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .checkbox-group label {
      font-size: 14px;
      color: #444;
      line-height: 1.5;
      cursor: pointer;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .consent-text {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      margin-top: 16px;
      margin-bottom: 4px;
      text-align: center;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .google-signin-section {
      text-align: center;
      margin-bottom: 8px;
    }
    .google-signin-section #g_id_signin,
    .google-signin-section #g_id_signin_admin {
      display: flex;
      justify-content: center;
    }
    .divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 13px;
      color: #999;
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      border-top: 1px solid #e8e4de;
    }
    .profile-badge {
      background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .profile-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #8B2635;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .profile-name { font-size: 17px; font-weight: 600; color: #333; }
    .profile-email { font-size: 13px; color: #666; }
    .profile-phone { font-size: 13px; color: #666; }
    .logout-link {
      background: none;
      border: none;
      color: #8B2635;
      font-size: 13px;
      cursor: pointer;
      padding: 4px 8px;
      font-family: 'Inter', -apple-system, sans-serif;
      text-decoration: underline;
    }
    .logout-link:hover {
      color: #6B1D29;
    }
    .search-box { margin-bottom: 20px; }
    .section-title { font-size: 22px; font-weight: 600; color: #333; margin: 0 0 20px; }
    .ministry-card {
      background: white;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .ministry-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    .ministry-card.interested {
      border-color: #4a9c6d;
      background: linear-gradient(135deg, #f0f9f4 0%, #e8f5ed 100%);
    }
    .ministry-icon {
      font-size: 32px;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #faf8f5;
      border-radius: 12px;
      flex-shrink: 0;
    }
    .ministry-info { flex: 1; }
    .ministry-name { font-size: 18px; font-weight: 600; color: #333; margin: 0; }
    .ministry-desc { font-size: 14px; color: #666; margin: 4px 0 0; line-height: 1.5; }
    .badge {
      background: #4a9c6d;
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 20px;
      font-family: 'Inter', -apple-system, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .success-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4a9c6d 0%, #3d8259 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 24px;
      box-shadow: 0 8px 24px rgba(74, 156, 109, 0.35);
    }
    .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
    .hidden { display: none !important; }
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 16px;
    }
    .checkbox-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: #faf8f5;
      border-radius: 8px;
      cursor: pointer;
    }
    .checkbox-option:hover {
      background: #f0ebe3;
    }
    .checkbox-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .checkbox-option label {
      font-size: 15px;
      color: #333;
      cursor: pointer;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .organizer-box {
      background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      text-align: left;
    }
    .organizer-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .organizer-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    .organizer-contact {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }
    .organizer-contact a {
      color: #8B2635;
      text-decoration: none;
    }
    .organizer-contact a:hover {
      text-decoration: underline;
    }
    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 16px;
    }
    .btn-remove {
      background: white;
      color: #c53030;
      border: 2px solid #c53030;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Crimson Pro', Georgia, serif;
      width: 100%;
    }
    .btn-remove:hover {
      background: #fff5f5;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal.hidden {
      display: none !important;
    }
    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      position: relative;
      background: white;
      border-radius: 16px;
      padding: 28px 24px;
      max-width: 340px;
      margin: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      text-align: center;
    }
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
    }
    .modal-text {
      font-size: 15px;
      color: #666;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
    }
    .modal-buttons button {
      flex: 1;
    }

    /* ======================================== */
    /* TOP NAVIGATION BAR                       */
    /* ======================================== */
    .top-nav {
      background: white;
      border-bottom: 1px solid #e8e4de;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-brand {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .role-badge {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'Inter', sans-serif;
    }
    .role-badge.role-admin {
      background: #8B2635;
      color: white;
    }
    .role-badge.role-ministry_lead {
      background: #4a9c6d;
      color: white;
    }
    .role-badge.role-parishioner {
      background: #e8e4de;
      color: #666;
    }
    .nav-user-info {
      text-align: right;
      font-family: 'Inter', sans-serif;
    }
    .nav-user-name {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .nav-user-email {
      font-size: 11px;
      color: #888;
    }
    .nav-btn {
      background: none;
      border: 1px solid #e8e4de;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      font-family: 'Inter', sans-serif;
    }
    .nav-btn:hover {
      background: #f5f0e8;
    }

    /* ======================================== */
    /* START WIZARD                             */
    /* ======================================== */
    .wizard-hero {
      text-align: center;
      padding: 48px 20px 24px;
    }
    .wizard-hero-icon {
      font-size: 56px;
      margin-bottom: 16px;
    }
    .wizard-hero-title {
      font-size: 30px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .wizard-hero-sub {
      font-size: 16px;
      color: #666;
      line-height: 1.6;
    }
    .step-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 16px 20px;
    }
    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e8e4de;
      transition: all 0.3s;
    }
    .step-dot.active {
      background: #8B2635;
      transform: scale(1.3);
    }
    .step-dot.done {
      background: #4a9c6d;
    }
    .step-line {
      width: 24px;
      height: 2px;
      background: #e8e4de;
    }
    .step-line.done {
      background: #4a9c6d;
    }
    .wizard-step {
      display: none;
    }
    .wizard-step.active {
      display: block;
    }
    .wizard-nav {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .wizard-nav .btn,
    .wizard-nav .btn-secondary {
      flex: 1;
    }
    .signed-in-as {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, #f0f9f4 0%, #e8f5ed 100%);
      border: 1px solid #b7e4c7;
      border-radius: 12px;
      margin-top: 16px;
    }
    .signed-in-as .profile-icon {
      background: #4a9c6d;
      width: 40px;
      height: 40px;
      font-size: 16px;
    }
    .signed-in-check {
      color: #4a9c6d;
      font-size: 20px;
      font-weight: bold;
      margin-left: auto;
    }
    .color-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .color-swatch {
      aspect-ratio: 1;
      border-radius: 10px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    .color-swatch:hover {
      transform: scale(1.1);
    }
    .color-swatch.selected {
      border-color: #333;
      transform: scale(1.15);
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .header-preview {
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      color: white;
      margin-top: 20px;
      transition: background 0.3s;
    }
    .header-preview h3 {
      font-size: 20px;
      font-weight: 600;
    }
    .header-preview p {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
    }
    .info-box {
      background: #f0f7ff;
      border: 1px solid #d0e3ff;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
    }
    .info-box h4 {
      font-size: 15px;
      font-weight: 600;
      color: #2b6cb0;
      margin-bottom: 12px;
      font-family: 'Inter', sans-serif;
    }
    .info-box ol {
      padding-left: 20px;
      font-size: 14px;
      color: #444;
      line-height: 2;
      font-family: 'Inter', sans-serif;
    }
    .info-box a {
      color: #8B2635;
      font-weight: 500;
    }
    .sheet-preview {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      font-family: 'Inter', sans-serif;
      margin-top: 12px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e8e4de;
    }
    .sheet-preview th {
      background: #f5f0e8;
      padding: 8px 6px;
      text-align: left;
      font-weight: 600;
      color: #555;
      white-space: nowrap;
    }
    .sheet-preview td {
      padding: 7px 6px;
      border-top: 1px solid #f0ebe3;
      color: #666;
      white-space: nowrap;
    }
    .sheet-preview tr:nth-child(even) td {
      background: #faf8f5;
    }
    .sheet-scroll {
      overflow-x: auto;
      margin: 12px 0;
      border-radius: 8px;
    }
    .btn-download {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: white;
      color: #2b6cb0;
      border: 2px solid #d0e3ff;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      width: 100%;
      justify-content: center;
      margin-bottom: 12px;
    }
    .btn-download:hover {
      background: #f0f7ff;
      border-color: #2b6cb0;
    }
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #8B2635;
      color: white;
      font-size: 14px;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      flex-shrink: 0;
    }
    .setup-step {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 16px 0;
      border-bottom: 1px solid #f0ebe3;
    }
    .setup-step:last-child {
      border-bottom: none;
    }
    .setup-step-content {
      flex: 1;
    }
    .setup-step-title {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      font-family: 'Inter', sans-serif;
    }
    .setup-step-desc {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      font-family: 'Inter', sans-serif;
    }
    /* File upload area */
    .upload-area {
      border: 2px dashed #d0d0d0;
      border-radius: 14px;
      padding: 32px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #faf8f5;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: #8B2635;
      background: #fef7f8;
    }
    .upload-area-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    .upload-area-text {
      font-size: 15px;
      color: #555;
      font-family: 'Inter', sans-serif;
    }
    .upload-area-hint {
      font-size: 12px;
      color: #999;
      margin-top: 6px;
      font-family: 'Inter', sans-serif;
    }
    .upload-area input[type="file"] {
      display: none;
    }
    .upload-filename {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: #f0f9f4;
      border: 1px solid #b7e4c7;
      border-radius: 10px;
      margin-top: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      color: #2d6a4f;
    }
    .upload-filename .remove-file {
      margin-left: auto;
      background: none;
      border: none;
      color: #c53030;
      cursor: pointer;
      font-size: 18px;
    }
    /* AI analysis states */
    .analysis-progress {
      text-align: center;
      padding: 24px;
    }
    .analysis-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #e8e4de;
      border-top-color: #8B2635;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .analysis-status-text {
      font-size: 14px;
      color: #666;
      font-family: 'Inter', sans-serif;
    }
    /* Mapping results */
    .mapping-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      margin: 12px 0;
    }
    .mapping-table th {
      text-align: left;
      padding: 10px 8px;
      background: #f5f0e8;
      font-weight: 600;
      color: #555;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .mapping-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f0ebe3;
      color: #333;
    }
    .mapping-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .mapping-status.mapped {
      background: #f0f9f4;
      color: #2d6a4f;
    }
    .mapping-status.missing {
      background: #fff5f5;
      color: #c53030;
    }
    .mapping-status.optional {
      background: #fefce8;
      color: #92400e;
    }
    .mapping-summary {
      padding: 16px;
      border-radius: 10px;
      margin: 16px 0;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    .mapping-summary.good {
      background: #f0f9f4;
      border: 1px solid #b7e4c7;
      color: #2d6a4f;
    }
    .mapping-summary.warn {
      background: #fefce8;
      border: 1px solid #fde68a;
      color: #92400e;
    }
    .mapping-summary h4 {
      font-size: 15px;
      margin-bottom: 6px;
    }
    .mapping-summary ul {
      margin-top: 8px;
      padding-left: 18px;
      line-height: 1.8;
    }
    .data-preview-scroll {
      overflow-x: auto;
      margin: 12px 0;
      border-radius: 8px;
    }
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      margin-top: 12px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
    }
    .connection-status.success {
      background: #f0f9f4;
      color: #2d6a4f;
      border: 1px solid #b7e4c7;
    }
    .connection-status.error {
      background: #fff5f5;
      color: #c53030;
      border: 1px solid #feb2b2;
    }
    .connection-status.testing {
      background: #f0f7ff;
      color: #2b6cb0;
      border: 1px solid #bee3f8;
    }
    .admin-list {
      margin-top: 16px;
    }
    .admin-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: #faf8f5;
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .admin-item .profile-icon {
      width: 36px;
      height: 36px;
      font-size: 14px;
    }
    .admin-item-details { flex: 1; }
    .admin-item-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    .admin-item-email {
      font-size: 12px;
      color: #666;
    }
    .admin-item-tag {
      font-size: 10px;
      font-weight: 700;
      color: #8B2635;
      text-transform: uppercase;
      font-family: 'Inter', sans-serif;
    }
    .admin-remove-btn {
      background: none;
      border: none;
      color: #c53030;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
    }
    .add-admin-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .add-admin-row .input { flex: 1; }
    .btn-sm {
      background: #8B2635;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }
    .summary-list {
      margin-top: 16px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid #f0ebe3;
    }
    .summary-row:last-child { border-bottom: none; }
    .summary-label {
      font-size: 13px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'Inter', sans-serif;
    }
    .summary-value {
      font-size: 15px;
      color: #333;
      font-weight: 500;
      text-align: right;
      max-width: 60%;
      word-break: break-all;
    }
    .launch-area {
      text-align: center;
      margin-top: 32px;
    }
    .launch-area .success-icon {
      width: 64px;
      height: 64px;
      font-size: 32px;
    }

    /* ======================================== */
    /* SETTINGS                                 */
    /* ======================================== */
    .settings-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      color: #8B2635;
      cursor: pointer;
      font-size: 15px;
      font-family: 'Crimson Pro', Georgia, serif;
      padding: 0;
      margin-bottom: 20px;
    }
    .settings-section {
      margin-bottom: 28px;
    }
    .settings-section-title {
      font-size: 12px;
      font-weight: 700;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      font-family: 'Inter', sans-serif;
    }
    .settings-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #f5f0e8;
      cursor: pointer;
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-item:hover { background: #faf8f5; }
    .settings-item-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .settings-item-label {
      font-size: 15px;
      color: #333;
    }
    .settings-item-desc {
      font-size: 12px;
      color: #999;
      font-family: 'Inter', sans-serif;
    }
    .settings-item-value {
      font-size: 14px;
      color: #888;
      font-family: 'Inter', sans-serif;
    }
    .settings-item-arrow {
      color: #ccc;
      margin-left: 8px;
    }
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
      flex-shrink: 0;
    }
    .toggle-switch.on {
      background: #4a9c6d;
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch.on::after {
      transform: translateX(20px);
    }
    .template-card {
      background: #faf8f5;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 10px;
    }
    .template-card h4 {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      font-family: 'Inter', sans-serif;
    }
    .template-card p {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      font-family: 'Inter', sans-serif;
    }
    .template-card textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      border: 1px solid #e8e4de;
      border-radius: 8px;
      margin-top: 8px;
      resize: vertical;
      outline: none;
    }
    .template-card textarea:focus {
      border-color: #8B2635;
    }

    /* ======================================== */
    /* THEME TOGGLE                             */
    /* ======================================== */
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: white;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      z-index: 999;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .theme-toggle:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }

    /* ======================================== */
    /* DOMAIN DETECTION                         */
    /* ======================================== */
    .detection-card {
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
      text-align: center;
    }
    .detection-card.detecting {
      background: linear-gradient(135deg, #f0f7ff 0%, #e8f2ff 100%);
      border: 1px solid #d0e3ff;
    }
    .detection-card.found {
      background: linear-gradient(135deg, #f0f9f4 0%, #e8f5ed 100%);
      border: 1px solid #b7e4c7;
    }
    .detection-card.not-found {
      background: #faf8f5;
      border: 1px solid #e8e4de;
    }
    .detection-icon {
      font-size: 36px;
      margin-bottom: 10px;
    }
    .detection-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }
    .detection-detail {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
      font-family: 'Inter', sans-serif;
    }
    .detection-org-name {
      font-size: 20px;
      font-weight: 600;
      color: #2d6a4f;
      margin: 8px 0 4px;
    }
    .detection-meta {
      font-size: 13px;
      color: #888;
      font-family: 'Inter', sans-serif;
    }
    .detection-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .detection-actions button { flex: 1; }
    .detection-spinner-sm {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid #bee3f8;
      border-top-color: #2b6cb0;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    /* Dark mode overrides for detection */
    body.dark .detection-card.detecting {
      background: linear-gradient(135deg, #1a2030 0%, #1a2535 100%);
      border-color: #2a3a50;
    }
    body.dark .detection-card.found {
      background: linear-gradient(135deg, #1a2a20 0%, #1e2e24 100%);
      border-color: #2a5a3a;
    }
    body.dark .detection-card.not-found {
      background: #1e1e1e;
      border-color: #3a3a3a;
    }
    body.dark .detection-title { color: #e0e0e0; }
    body.dark .detection-detail { color: #a0a0a0; }
    body.dark .detection-org-name { color: #6fbc8f; }
    body.dark .detection-meta { color: #707070; }
    body.dark .detection-spinner-sm {
      border-color: #2a3a50;
      border-top-color: #7db3e0;
    }

    /* ======================================== */
    /* DARK MODE                                */
    /* ======================================== */
    body.dark {
      background: linear-gradient(145deg, #141414 0%, #1a1a1a 100%);
      color: #e0e0e0;
    }
    body.dark .theme-toggle {
      background: #2a2a2a;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
    }

    /* Header - keep gradient from config, just soften the shadow */
    body.dark .header {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    /* Cards */
    body.dark .card {
      background: #242424;
      box-shadow: 0 2px 16px rgba(0,0,0,0.3);
    }

    /* Text colors */
    body.dark .welcome-text { color: #b0b0b0; }
    body.dark .section-title { color: #e8e8e8; }
    body.dark .label { color: #d0d0d0; }
    body.dark .consent-text { color: #808080; }
    body.dark .divider { color: #606060; }
    body.dark .divider::before,
    body.dark .divider::after { border-top-color: #3a3a3a; }

    /* Inputs */
    body.dark .input,
    body.dark .select {
      background: #1a1a1a;
      border-color: #3a3a3a;
      color: #e8e8e8;
    }
    body.dark .input::placeholder { color: #606060; }
    body.dark .input:focus,
    body.dark .select:focus { border-color: #8B2635; }
    body.dark .select option { background: #242424; color: #e8e8e8; }

    /* Buttons */
    body.dark .btn-secondary {
      background: #242424;
      border-color: #8B2635;
      color: #e0a0a8;
    }
    body.dark .btn-remove {
      background: #242424;
      color: #f87171;
      border-color: #f87171;
    }
    body.dark .btn-remove:hover { background: #2a1a1a; }
    body.dark .btn:disabled { opacity: 0.5; }

    /* Profile badge */
    body.dark .profile-badge {
      background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);
    }
    body.dark .profile-name { color: #e8e8e8; }
    body.dark .profile-email,
    body.dark .profile-phone { color: #909090; }
    body.dark .logout-link { color: #e0a0a8; }
    body.dark .logout-link:hover { color: #f0c0c8; }

    /* Checkbox group */
    body.dark .checkbox-group {
      background: linear-gradient(135deg, #1a2030 0%, #1a2535 100%);
      border-color: #2a3a50;
    }
    body.dark .checkbox-group label { color: #b0b0b0; }

    /* Ministry cards */
    body.dark .ministry-card {
      background: #242424;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
    }
    body.dark .ministry-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }
    body.dark .ministry-card.interested {
      border-color: #4a9c6d;
      background: linear-gradient(135deg, #1a2a20 0%, #1e2e24 100%);
    }
    body.dark .ministry-icon {
      background: #1e1e1e;
    }
    body.dark .ministry-name { color: #e8e8e8; }
    body.dark .ministry-desc { color: #909090; }

    /* Search */
    body.dark .no-results { color: #808080; }

    /* Detail view */
    body.dark .checkbox-option {
      background: #1e1e1e;
    }
    body.dark .checkbox-option:hover { background: #2a2a2a; }
    body.dark .checkbox-option label { color: #d0d0d0; }

    /* Organizer box */
    body.dark .organizer-box {
      background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);
    }
    body.dark .organizer-title { color: #d0d0d0; }
    body.dark .organizer-name { color: #e8e8e8; }
    body.dark .organizer-contact { color: #909090; }
    body.dark .organizer-contact a { color: #e0a0a8; }

    /* Modal */
    body.dark .modal-backdrop { background: rgba(0, 0, 0, 0.7); }
    body.dark .modal-content {
      background: #2a2a2a;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    body.dark .modal-title { color: #e8e8e8; }
    body.dark .modal-text { color: #a0a0a0; }

    /* Loading */
    body.dark .loading { color: #808080; }

    /* Top nav */
    body.dark .top-nav {
      background: #1e1e1e;
      border-bottom-color: #333333;
    }
    body.dark .nav-brand { color: #e8e8e8; }
    body.dark .nav-user-name { color: #e0e0e0; }
    body.dark .nav-user-email { color: #808080; }
    body.dark .nav-btn {
      border-color: #3a3a3a;
      color: #a0a0a0;
    }
    body.dark .nav-btn:hover { background: #2a2a2a; }

    /* Start wizard */
    body.dark .wizard-hero-title { color: #e8e8e8; }
    body.dark .wizard-hero-sub { color: #909090; }
    body.dark .step-dot { background: #3a3a3a; }
    body.dark .step-line { background: #3a3a3a; }
    body.dark .signed-in-as {
      background: linear-gradient(135deg, #1a2a20 0%, #1e2e24 100%);
      border-color: #2a5a3a;
    }

    /* Color grid */
    body.dark .header-preview { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

    /* Info box */
    body.dark .info-box {
      background: #1a2030;
      border-color: #2a3a50;
    }
    body.dark .info-box h4 { color: #7db3e0; }
    body.dark .info-box ol { color: #b0b0b0; }

    /* Upload area */
    body.dark .upload-area {
      background: #1e1e1e;
      border-color: #3a3a3a;
    }
    body.dark .upload-area:hover,
    body.dark .upload-area.dragover {
      border-color: #8B2635;
      background: #2a1a1a;
    }
    body.dark .upload-area-text { color: #b0b0b0; }
    body.dark .upload-area-hint { color: #606060; }
    body.dark .upload-filename {
      background: #1a2a20;
      border-color: #2a5a3a;
      color: #6fbc8f;
    }

    /* Analysis */
    body.dark .analysis-spinner {
      border-color: #3a3a3a;
      border-top-color: #8B2635;
    }
    body.dark .analysis-status-text { color: #909090; }

    /* Mapping table */
    body.dark .mapping-table th {
      background: #1e1e1e;
      color: #a0a0a0;
    }
    body.dark .mapping-table td {
      border-bottom-color: #333333;
      color: #d0d0d0;
    }
    body.dark .mapping-status.mapped { background: #1a2a20; color: #6fbc8f; }
    body.dark .mapping-status.missing { background: #2a1a1a; color: #f87171; }
    body.dark .mapping-status.optional { background: #2a2510; color: #d4a020; }
    body.dark .mapping-summary.good {
      background: #1a2a20;
      border-color: #2a5a3a;
      color: #6fbc8f;
    }
    body.dark .mapping-summary.warn {
      background: #2a2510;
      border-color: #5a4a1a;
      color: #d4a020;
    }
    body.dark .btn-download {
      background: #242424;
      color: #7db3e0;
      border-color: #2a3a50;
    }
    body.dark .btn-download:hover {
      background: #1a2030;
      border-color: #7db3e0;
    }

    /* Sheet preview */
    body.dark .sheet-preview {
      border-color: #3a3a3a;
    }
    body.dark .sheet-preview th {
      background: #1e1e1e;
      color: #a0a0a0;
    }
    body.dark .sheet-preview td {
      border-top-color: #333333;
      color: #909090;
    }
    body.dark .sheet-preview tr:nth-child(even) td {
      background: #1e1e1e;
    }

    /* Connection status */
    body.dark .connection-status.success {
      background: #1a2a20;
      border-color: #2a5a3a;
      color: #6fbc8f;
    }
    body.dark .connection-status.error {
      background: #2a1a1a;
      border-color: #5a2a2a;
      color: #f87171;
    }
    body.dark .connection-status.testing {
      background: #1a2030;
      border-color: #2a3a50;
      color: #7db3e0;
    }

    /* Setup steps */
    body.dark .setup-step { border-bottom-color: #333333; }
    body.dark .setup-step-title { color: #e0e0e0; }
    body.dark .setup-step-desc { color: #909090; }

    /* Admin list */
    body.dark .admin-item { background: #1e1e1e; }
    body.dark .admin-item-name { color: #e0e0e0; }
    body.dark .admin-item-email { color: #808080; }
    body.dark .admin-item-tag { color: #e0a0a8; }
    body.dark .btn-sm { background: #8B2635; }

    /* Summary */
    body.dark .summary-row { border-bottom-color: #333333; }
    body.dark .summary-label { color: #707070; }
    body.dark .summary-value { color: #e0e0e0; }

    /* Settings */
    body.dark .settings-back { color: #e0a0a8; }
    body.dark .settings-section-title { color: #707070; }
    body.dark .settings-card {
      background: #242424;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
    }
    body.dark .settings-item {
      border-bottom-color: #333333;
    }
    body.dark .settings-item:hover { background: #2a2a2a; }
    body.dark .settings-item-label { color: #e0e0e0; }
    body.dark .settings-item-desc { color: #707070; }
    body.dark .settings-item-value { color: #909090; }
    body.dark .settings-item-arrow { color: #505050; }
    body.dark .toggle-switch { background: #3a3a3a; }

    /* Template cards */
    body.dark .template-card {
      background: #1e1e1e;
    }
    body.dark .template-card h4 { color: #e0e0e0; }
    body.dark .template-card p { color: #909090; }
    body.dark .template-card textarea {
      background: #1a1a1a;
      border-color: #3a3a3a;
      color: #e0e0e0;
    }
    body.dark .template-card textarea:focus { border-color: #8B2635; }

    /* Success icon in confirmed view */
    body.dark .success-icon {
      box-shadow: 0 8px 24px rgba(74, 156, 109, 0.2);
    }
  </style>
</head>
<body>
<script>
  // Apply theme before first paint to prevent flash
  if ((localStorage.getItem('mf-theme') || 'dark') === 'dark') document.body.classList.add('dark');
</script>

<!-- THEME TOGGLE -->
<button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode">&#9790;</button>

<!-- TOP NAVIGATION BAR -->
<nav id="top-nav" class="top-nav hidden">
  <div class="nav-brand" id="nav-brand-text">Ministry Fair</div>
  <div class="nav-right">
    <span class="role-badge" id="nav-role-badge"></span>
    <div class="nav-user-info">
      <div class="nav-user-name" id="nav-user-name"></div>
      <div class="nav-user-email" id="nav-user-email"></div>
    </div>
    <button class="nav-btn" id="nav-settings-btn" title="Settings">&#9881;</button>
    <button class="nav-btn" id="nav-logout-btn" title="Log out">&#10140;</button>
  </div>
</nav>

<!-- LOADING VIEW -->
<div id="view-loading">
  <header class="header">
    <h1 class="app-title"></h1>
    <p class="app-tagline"></p>
  </header>
  <div class="content">
    <div class="card">
      <div class="loading">Loading ministries...</div>
    </div>
  </div>
</div>

<!-- ======================================== -->
<!-- START WIZARD VIEW                        -->
<!-- ======================================== -->
<div id="view-start" class="hidden">
  <div class="wizard-hero">
    <div class="wizard-hero-icon">&#9962;</div>
    <h1 class="wizard-hero-title">Set Up Your Ministry Fair</h1>
    <p class="wizard-hero-sub">Let's get your parish ministry fair up and running.<br>This will only take a few minutes.</p>
  </div>

  <div class="step-indicator" id="step-indicator">
    <div class="step-dot active" data-step="1"></div>
    <div class="step-line" data-after="1"></div>
    <div class="step-dot" data-step="2"></div>
    <div class="step-line" data-after="2"></div>
    <div class="step-dot" data-step="3"></div>
    <div class="step-line" data-after="3"></div>
    <div class="step-dot" data-step="4"></div>
    <div class="step-line" data-after="4"></div>
    <div class="step-dot" data-step="5"></div>
  </div>

  <div class="content">
    <!-- STEP 1: Sign In -->
    <div class="wizard-step active" data-wizard-step="1">
      <div class="card">
        <h2 class="section-title">Sign In as Administrator</h2>
        <p class="welcome-text">
          Sign in with your Google account. You'll be the first administrator and can add others later.
        </p>
        <div class="google-signin-section">
          <div id="g_id_signin_admin"></div>
        </div>
        <div id="admin-signed-in" class="hidden">
          <div class="signed-in-as">
            <div class="profile-icon" id="admin-setup-initials"></div>
            <div>
              <div class="profile-name" id="admin-setup-name"></div>
              <div class="profile-email" id="admin-setup-email"></div>
            </div>
            <div class="signed-in-check">&#10003;</div>
          </div>
          <!-- Domain detection results -->
          <div id="domain-detection" class="hidden"></div>
        </div>
        <div class="form" style="margin-top: 24px;">
          <div class="input-group">
            <label class="label">Claude API Key</label>
            <input type="password" class="input" id="setup-api-key" placeholder="sk-ant-api03-...">
            <p style="font-size: 12px; color: #888; margin-top: 4px; font-family: 'Inter', sans-serif;">
              Used to intelligently read your spreadsheet and power notifications.
              Get one at <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #8B2635;">console.anthropic.com</a>
            </p>
          </div>
        </div>
        <div class="wizard-nav">
          <button class="btn" id="step1-next" disabled>Next &rarr;</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: Organization Details -->
    <div class="wizard-step" data-wizard-step="2">
      <div class="card">
        <h2 class="section-title">Your Organization</h2>
        <p class="welcome-text">Tell us about your parish or organization.</p>
        <div class="form">
          <div class="input-group">
            <label class="label">Organization Name</label>
            <input type="text" class="input" id="setup-org-name" placeholder="St. Theresa Catholic Church">
          </div>
          <div class="input-group">
            <label class="label">App Title</label>
            <input type="text" class="input" id="setup-app-title" value="Ministry Fair">
          </div>
          <div class="input-group">
            <label class="label">Tagline</label>
            <input type="text" class="input" id="setup-tagline" value="Find your place to serve">
          </div>
          <div class="input-group">
            <label class="label">Theme Color</label>
            <div class="color-grid" id="color-grid"></div>
          </div>
          <div class="header-preview" id="header-preview">
            <h3 id="preview-title">Ministry Fair</h3>
            <p id="preview-tagline">Find your place to serve</p>
          </div>
        </div>
        <div class="wizard-nav">
          <button class="btn-secondary" id="step2-back">&larr; Back</button>
          <button class="btn" id="step2-next">Next &rarr;</button>
        </div>
      </div>
    </div>

    <!-- STEP 3: Upload & Analyze Spreadsheet -->
    <div class="wizard-step" data-wizard-step="3">
      <div class="card">
        <h2 class="section-title">Upload Your Ministry List</h2>
        <p class="welcome-text">
          Upload a spreadsheet with your ministries. It doesn't need to be in any special format &mdash; we'll use AI to read it and figure out what's what.
        </p>

        <!-- Upload area -->
        <div id="upload-area" class="upload-area">
          <div class="upload-area-icon">&#128203;</div>
          <div class="upload-area-text">Drop your file here, or click to browse</div>
          <div class="upload-area-hint">CSV, Excel, or any spreadsheet format</div>
          <input type="file" id="file-input" accept=".csv,.tsv,.xlsx,.xls,.txt">
        </div>
        <div id="upload-filename" class="upload-filename hidden">
          <span>&#128196;</span>
          <span id="filename-text"></span>
          <button class="remove-file" id="remove-file-btn">&times;</button>
        </div>

        <!-- AI analysis area (hidden until file uploaded) -->
        <div id="analysis-section" class="hidden">
          <!-- Progress spinner -->
          <div id="analysis-progress" class="analysis-progress hidden">
            <div class="analysis-spinner"></div>
            <div class="analysis-status-text">Reading your spreadsheet with AI...</div>
          </div>

          <!-- Mapping results -->
          <div id="mapping-results" class="hidden">
            <div id="mapping-summary-box"></div>
            <table class="mapping-table" id="mapping-table">
              <thead>
                <tr>
                  <th>Our Field</th>
                  <th>Your Column</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="mapping-table-body"></tbody>
            </table>

            <div id="mapping-suggestions"></div>

            <p style="font-size: 14px; font-weight: 600; color: #333; margin-top: 20px; font-family: 'Inter', sans-serif;">
              Preview (first 3 rows):
            </p>
            <div class="data-preview-scroll">
              <table class="sheet-preview" id="data-preview-table"></table>
            </div>

            <button class="btn-download" id="download-formatted-btn" style="margin-top: 16px;">&#128196; Download Formatted Sheet (.csv)</button>
          </div>
        </div>

        <!-- Connect section (shown after analysis or if skipping upload) -->
        <div style="margin-top: 24px;">
          <div class="setup-step">
            <span class="step-number">1</span>
            <div class="setup-step-content">
              <div class="setup-step-title">Import into Google Sheets</div>
              <div class="setup-step-desc">Create a new Google Sheet. If you downloaded the formatted file above, use File &rarr; Import to bring it in. Otherwise, paste your ministry data directly.</div>
            </div>
          </div>
          <div class="setup-step">
            <span class="step-number">2</span>
            <div class="setup-step-content">
              <div class="setup-step-title">Add the backend script</div>
              <div class="setup-step-desc">In your Google Sheet, go to <strong>Extensions &rarr; Apps Script</strong>. Delete any existing code, paste the contents of <strong>google-apps-script.js</strong> (included with this app), and click Save.</div>
            </div>
          </div>
          <div class="setup-step">
            <span class="step-number">3</span>
            <div class="setup-step-content">
              <div class="setup-step-title">Deploy as a Web App</div>
              <div class="setup-step-desc">In Apps Script, click <strong>Deploy &rarr; New deployment</strong>. Set type to "Web app", execute as "Me", access "Anyone". Click Deploy and copy the URL.</div>
            </div>
          </div>
        </div>

        <div class="form" style="margin-top: 20px;">
          <div class="input-group">
            <label class="label">Google Sheet URL</label>
            <input type="url" class="input" id="setup-sheet-url" placeholder="https://docs.google.com/spreadsheets/d/...">
          </div>
          <div class="input-group">
            <label class="label">Apps Script API URL</label>
            <input type="url" class="input" id="setup-api-url" placeholder="https://script.google.com/macros/s/.../exec">
          </div>
          <button class="btn-secondary" id="test-connection-btn" type="button">&#128268; Test Connection</button>
          <div id="connection-status"></div>
        </div>
        <div class="wizard-nav">
          <button class="btn-secondary" id="step3-back">&larr; Back</button>
          <button class="btn" id="step3-next">Next &rarr;</button>
        </div>
      </div>
    </div>

    <!-- STEP 4: Add Admins -->
    <div class="wizard-step" data-wizard-step="4">
      <div class="card">
        <h2 class="section-title">Add Administrators</h2>
        <p class="welcome-text">
          Add other people who should be able to manage this app. You can always add or remove admins later in Settings.
        </p>
        <div class="admin-list" id="setup-admin-list"></div>
        <div class="add-admin-row">
          <input type="email" class="input" id="setup-new-admin-email" placeholder="colleague@gmail.com">
          <button class="btn-sm" id="setup-add-admin-btn">Add</button>
        </div>
        <div class="wizard-nav">
          <button class="btn-secondary" id="step4-back">&larr; Back</button>
          <button class="btn" id="step4-next">Next &rarr;</button>
        </div>
      </div>
    </div>

    <!-- STEP 5: Review & Launch -->
    <div class="wizard-step" data-wizard-step="5">
      <div class="card">
        <h2 class="section-title">Review &amp; Launch</h2>
        <p class="welcome-text">Everything looks good! Here's a summary of your setup.</p>
        <div class="summary-list" id="setup-summary"></div>
        <div class="launch-area">
          <div class="success-icon">&#9889;</div>
          <button class="btn btn-green" id="launch-btn" style="margin-top: 16px;">Launch Ministry Fair</button>
        </div>
        <div class="wizard-nav" style="margin-top: 16px;">
          <button class="btn-secondary" id="step5-back">&larr; Back</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================================== -->
<!-- SETTINGS VIEW                            -->
<!-- ======================================== -->
<div id="view-settings" class="hidden">
  <div class="content" style="padding-top: 16px;">
    <button class="settings-back" id="settings-back-btn">&larr; Back</button>
    <h2 class="section-title">Settings</h2>

    <!-- Admin-only sections -->
    <div id="settings-admin-sections">
      <div class="settings-section">
        <div class="settings-section-title">Organization</div>
        <div class="settings-card">
          <div class="settings-item" id="settings-org-name-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Organization Name</div>
            </div>
            <div style="display:flex;align-items:center;">
              <span class="settings-item-value" id="settings-org-name-val"></span>
              <span class="settings-item-arrow">&rsaquo;</span>
            </div>
          </div>
          <div class="settings-item" id="settings-app-title-item">
            <div class="settings-item-left">
              <div class="settings-item-label">App Title</div>
            </div>
            <div style="display:flex;align-items:center;">
              <span class="settings-item-value" id="settings-app-title-val"></span>
              <span class="settings-item-arrow">&rsaquo;</span>
            </div>
          </div>
          <div class="settings-item" id="settings-color-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Theme Color</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
              <div id="settings-color-swatch" style="width:24px;height:24px;border-radius:6px;"></div>
              <span class="settings-item-arrow">&rsaquo;</span>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Data Connection</div>
        <div class="settings-card">
          <div class="settings-item" id="settings-api-item">
            <div class="settings-item-left">
              <div class="settings-item-label">API URL</div>
              <div class="settings-item-desc" id="settings-api-status">Connected</div>
            </div>
            <span class="settings-item-arrow">&rsaquo;</span>
          </div>
          <div class="settings-item" id="settings-sheet-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Google Sheet</div>
              <div class="settings-item-desc" id="settings-sheet-status">Not set</div>
            </div>
            <span class="settings-item-arrow">&rsaquo;</span>
          </div>
          <div class="settings-item" id="settings-claude-key-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Claude API Key</div>
              <div class="settings-item-desc" id="settings-claude-key-status">Not set</div>
            </div>
            <span class="settings-item-arrow">&rsaquo;</span>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Administrators</div>
        <div class="settings-card" id="settings-admins-card">
          <!-- populated by JS -->
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Notifications</div>
        <div class="settings-card">
          <div class="settings-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Email Notifications</div>
              <div class="settings-item-desc">Sent from your signed-in account</div>
            </div>
            <div class="toggle-switch on" id="toggle-email" data-key="emailEnabled"></div>
          </div>
          <div class="settings-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Text Notifications</div>
              <div class="settings-item-desc">SMS to members</div>
            </div>
            <div class="toggle-switch" id="toggle-text" data-key="textEnabled"></div>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Email Templates</div>
        <div id="settings-email-templates">
          <!-- populated by JS -->
        </div>
      </div>
    </div>

    <!-- Parishioner-visible section -->
    <div class="settings-section">
      <div class="settings-section-title">Your Account</div>
      <div class="settings-card">
        <div class="settings-item">
          <div class="settings-item-left">
            <div class="settings-item-label" id="settings-user-name"></div>
            <div class="settings-item-desc" id="settings-user-email"></div>
          </div>
        </div>
        <div class="settings-item" id="settings-logout-item" style="cursor:pointer;">
          <div class="settings-item-label" style="color:#c53030;">Log Out</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- REGISTER VIEW -->
<div id="view-register" class="hidden">
  <header class="header">
    <h1 class="app-title"></h1>
    <p class="app-tagline"></p>
  </header>
  <div class="content">
    <div class="card">
      <p class="welcome-text">
        Welcome! Let's get you signed up so you can explore our ministries and express interest in serving.
      </p>
      <div class="google-signin-section">
        <div id="g_id_signin"></div>
      </div>
      <div class="divider">or fill in manually</div>
      <form class="form" id="register-form">
        <div class="input-row">
          <div class="input-group">
            <label class="label">First Name</label>
            <input type="text" class="input" id="firstName" required autocomplete="given-name" placeholder="John">
          </div>
          <div class="input-group">
            <label class="label">Last Name</label>
            <input type="text" class="input" id="lastName" required autocomplete="family-name" placeholder="Smith">
          </div>
        </div>
        <div class="input-group">
          <label class="label">Email</label>
          <input type="email" class="input" id="email" required autocomplete="email" placeholder="john@example.com">
        </div>
        <div class="input-group">
          <label class="label">Cell Phone</label>
          <input type="tel" class="input" id="phone" required autocomplete="tel" placeholder="(555) 555-1234" maxlength="14">
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="joinParish">
          <label for="joinParish" id="joinParishLabel"></label>
        </div>
        <p class="consent-text" id="consentText"></p>
        <button type="submit" class="btn">Continue to Ministries &rarr;</button>
      </form>
    </div>
  </div>
</div>

<!-- MINISTRIES VIEW -->
<div id="view-ministries" class="hidden">
  <header class="header">
    <h1 class="app-title"></h1>
    <p id="interest-count">Tap a ministry to learn more</p>
  </header>
  <div class="content">
    <div class="profile-badge" id="parishioner-profile-badge">
      <div class="profile-icon" id="profile-initials"></div>
      <div style="flex: 1;">
        <div class="profile-name" id="profile-name"></div>
        <div class="profile-email" id="profile-email"></div>
        <div class="profile-phone" id="profile-phone"></div>
      </div>
      <button class="logout-link" id="logout-btn">Log out</button>
    </div>
    <h2 class="section-title">Our Ministries</h2>
    <div class="search-box">
      <input type="text" class="input" id="ministry-search" placeholder="&#128269; Search ministries...">
    </div>
    <div id="ministry-list"></div>
    <button class="btn-secondary hidden" id="show-all-btn">Show All Ministries</button>
  </div>
</div>

<!-- MINISTRY DETAIL VIEW -->
<div id="view-detail" class="hidden">
  <header class="header">
    <h1 id="detail-name"></h1>
    <p id="detail-icon"></p>
  </header>
  <div class="content">
    <div class="card">
      <p class="welcome-text" id="detail-desc"></p>
      <div id="detail-questions"></div>
      <div class="btn-group">
        <button class="btn" id="interest-btn">I'm Interested!</button>
        <button class="btn-remove hidden" id="remove-btn">Remove Interest</button>
        <button class="btn-secondary" id="back-btn">&larr; Back to All Ministries</button>
      </div>
    </div>
  </div>
</div>

<!-- CONFIRMATION MODAL -->
<div id="confirm-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <h3 class="modal-title">Remove Interest?</h3>
    <p class="modal-text">Are you sure you want to remove your interest in <strong id="modal-ministry-name"></strong>?</p>
    <div class="modal-buttons">
      <button class="btn-secondary" id="modal-cancel">Cancel</button>
      <button class="btn-remove" id="modal-confirm">Yes, Remove</button>
    </div>
  </div>
</div>

<!-- CONFIRMED VIEW -->
<div id="view-confirmed" class="hidden">
  <header class="header">
    <h1>Thank You!</h1>
    <p>Your interest has been recorded</p>
  </header>
  <div class="content">
    <div class="card" style="text-align: center;">
      <div class="success-icon">&#10003;</div>
      <h2 class="section-title" style="margin-bottom: 12px;">You're on the list!</h2>
      <p class="welcome-text" style="margin-bottom: 8px;">
        The <strong id="confirmed-ministry"></strong> ministry leader will reach out to you soon.
      </p>
      <div id="organizer-info"></div>
      <p style="font-size: 15px; color: #666; margin-bottom: 28px; margin-top: 20px;">
        Feel free to visit other tables and express interest in more ministries.
      </p>
      <button class="btn" id="explore-btn">Explore More Ministries</button>
    </div>
    <div id="interests-list" style="margin-top: 24px;"></div>
  </div>
</div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const DEFAULT_CONFIG = {
  organizationName: '',
  appTitle: 'Ministry Fair',
  tagline: 'Find your place to serve',
  apiUrl: '',
  spreadsheetUrl: '',
  primaryColor: '#8B2635',
  primaryColorDark: '#6B1D29',
  googleClientId: '1054492643145-oc8io3rqen2k1hqgrrj86a4op47nkg0m.apps.googleusercontent.com',
  setupComplete: false
};

const DEFAULT_NOTIFICATIONS = {
  emailEnabled: true,
  textEnabled: false,
  templates: {
    addedToMinistry: {
      name: 'Added to Ministry',
      subject: 'Welcome to {{ministry}}!',
      body: 'Hi {{firstName}},\n\nYou\'ve been added to {{ministry}} at {{organization}}. We\'re glad to have you!\n\nIf you have any questions, please reach out to your ministry lead.\n\nGod bless,\n{{organization}}'
    },
    appointedLead: {
      name: 'Appointed Ministry Lead',
      subject: 'You\'ve been appointed Ministry Lead of {{ministry}}',
      body: 'Hi {{firstName}},\n\nYou\'ve been appointed as Ministry Lead of {{ministry}} at {{organization}}. Thank you for stepping up to serve!\n\nYou can now manage members and communicate with your ministry team.\n\nGod bless,\n{{organization}}'
    },
    removedFromMinistry: {
      name: 'Removed from Ministry',
      subject: 'Update regarding {{ministry}}',
      body: 'Hi {{firstName}},\n\nThis is to let you know that you have been removed from {{ministry}} at {{organization}}.\n\nIf you believe this was a mistake, please contact your parish administrator.\n\nGod bless,\n{{organization}}'
    },
    removedAsLead: {
      name: 'Removed as Ministry Lead',
      subject: 'Update regarding {{ministry}} leadership',
      body: 'Hi {{firstName}},\n\nThis is to let you know that you have been removed as Ministry Lead of {{ministry}} at {{organization}}.\n\nThank you for your service. If you have questions, please contact your parish administrator.\n\nGod bless,\n{{organization}}'
    },
    newEvent: {
      name: 'New Event',
      subject: 'New Event: {{eventName}}',
      body: 'Hi {{firstName}},\n\nA new event has been scheduled for {{ministry}} at {{organization}}:\n\n{{eventName}}\nDate: {{eventDate}}\nLocation: {{eventLocation}}\n\nWe hope to see you there!\n\nGod bless,\n{{organization}}'
    }
  }
};

const COLOR_OPTIONS = [
  { color: '#8B2635', dark: '#6B1D29', name: 'Burgundy' },
  { color: '#1a5276', dark: '#154360', name: 'Navy' },
  { color: '#1e8449', dark: '#196f3d', name: 'Forest' },
  { color: '#6c3483', dark: '#5b2c6f', name: 'Purple' },
  { color: '#c0392b', dark: '#a93226', name: 'Red' },
  { color: '#2c3e50', dark: '#1a252f', name: 'Charcoal' },
  { color: '#d4ac0d', dark: '#b7950b', name: 'Gold' },
  { color: '#148f77', dark: '#117a65', name: 'Teal' },
  { color: '#1f618d', dark: '#1a5276', name: 'Blue' },
  { color: '#a04000', dark: '#873600', name: 'Rust' },
  { color: '#7d3c98', dark: '#6c3483', name: 'Violet' },
  { color: '#117864', dark: '#0e6655', name: 'Emerald' },
];

// ============================================
// STATE MANAGEMENT
// ============================================
function loadAppConfig() {
  try {
    const saved = localStorage.getItem('mf-app-config');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return { ...DEFAULT_CONFIG };
}

function saveAppConfig(config) {
  // Strip the API key before persisting to localStorage
  var toSave = Object.assign({}, config);
  delete toSave.claudeApiKey;
  localStorage.setItem('mf-app-config', JSON.stringify(toSave));
}

function getApiKey() {
  return sessionStorage.getItem('mf-claude-key') || '';
}

function setApiKey(key) {
  if (key) {
    sessionStorage.setItem('mf-claude-key', key);
  } else {
    sessionStorage.removeItem('mf-claude-key');
  }
}

function loadAdmins() {
  try {
    const saved = localStorage.getItem('mf-admins');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return [];
}

function saveAdmins(admins) {
  localStorage.setItem('mf-admins', JSON.stringify(admins));
}

function loadSession() {
  try {
    const saved = localStorage.getItem('mf-session');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return null;
}

function saveSession(session) {
  if (session) {
    localStorage.setItem('mf-session', JSON.stringify(session));
  } else {
    localStorage.removeItem('mf-session');
  }
}

function loadNotificationSettings() {
  try {
    const saved = localStorage.getItem('mf-notifications');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return JSON.parse(JSON.stringify(DEFAULT_NOTIFICATIONS));
}

function saveNotificationSettings(settings) {
  localStorage.setItem('mf-notifications', JSON.stringify(settings));
}

function isAdmin(email) {
  if (!email) return false;
  const admins = loadAdmins();
  return admins.some(a => a.email.toLowerCase() === email.toLowerCase());
}

function getUserRole(email) {
  if (isAdmin(email)) return 'admin';
  return 'parishioner';
}

function darkenColor(hex, amount) {
  hex = hex.replace('#', '');
  let r = parseInt(hex.substring(0, 2), 16);
  let g = parseInt(hex.substring(2, 4), 16);
  let b = parseInt(hex.substring(4, 6), 16);
  r = Math.max(0, r - amount);
  g = Math.max(0, g - amount);
  b = Math.max(0, b - amount);
  return '#' + [r, g, b].map(c => c.toString(16).padStart(2, '0')).join('');
}

// ============================================
// GLOBAL STATE
// ============================================
let appConfig = loadAppConfig();
let appAdmins = loadAdmins();
let currentSession = loadSession();
let notificationSettings = loadNotificationSettings();

let MINISTRIES = [];
let profile = { firstName: '', lastName: '', email: '', phone: '', wantsToJoinParish: false };
let interests = [];
let currentMinistry = null;
let showAll = false;
let searchTerm = '';
let wizardStep = 1;
let setupAdminData = null; // temp admin data during wizard

// Load saved parishioner data
function hasSavedProfile() { return !!localStorage.getItem('ministry-fair-profile'); }
var _savedProfile = localStorage.getItem('ministry-fair-profile');
var _savedInterests = localStorage.getItem('ministry-fair-interests');
if (_savedProfile) { try { profile = JSON.parse(_savedProfile); } catch(e) {} }
if (_savedInterests) { try { interests = JSON.parse(_savedInterests); } catch(e) {} }

// Check URL for ministry param
const urlParams = new URLSearchParams(window.location.search);
const ministryParam = urlParams.get('m');

// Fallback ministries
const FALLBACK_MINISTRIES = [
  { id: 'music', name: 'Music Ministry', description: 'Supports parish liturgies through choirs, cantors, and instrumentalists.', icon: '&#127925;', questions: [] },
  { id: 'hospitality', name: 'Hospitality Ministers', description: 'Welcomes parishioners and assists during Masses and parish events.', icon: '&#128682;', questions: [] }
];

// ============================================
// VIEWS
// ============================================
const views = {
  loading: document.getElementById('view-loading'),
  start: document.getElementById('view-start'),
  register: document.getElementById('view-register'),
  ministries: document.getElementById('view-ministries'),
  detail: document.getElementById('view-detail'),
  confirmed: document.getElementById('view-confirmed'),
  settings: document.getElementById('view-settings')
};

function showView(viewName) {
  Object.values(views).forEach(v => v.classList.add('hidden'));
  views[viewName].classList.remove('hidden');
  window.scrollTo(0, 0);

  // Show/hide nav bar
  const nav = document.getElementById('top-nav');
  if (viewName === 'start' || viewName === 'loading' || viewName === 'register') {
    nav.classList.add('hidden');
  } else if (currentSession) {
    updateNavBar();
    nav.classList.remove('hidden');
  }

  // Render Google buttons when those views show
  if (viewName === 'register') {
    renderGoogleButton('g_id_signin', handleParishionerSignIn);
  }
  if (viewName === 'start') {
    renderGoogleButton('g_id_signin_admin', handleAdminSignIn);
  }
}

// ============================================
// GOOGLE SIGN-IN
// ============================================
var _googleRetryCount = {};
function renderGoogleButton(containerId, callback) {
  if (typeof google === 'undefined' || !google.accounts) {
    _googleRetryCount[containerId] = (_googleRetryCount[containerId] || 0) + 1;
    if (_googleRetryCount[containerId] > 50) return; // Stop after ~10 seconds
    setTimeout(function() { renderGoogleButton(containerId, callback); }, 200);
    return;
  }
  _googleRetryCount[containerId] = 0;
  google.accounts.id.initialize({
    client_id: appConfig.googleClientId || DEFAULT_CONFIG.googleClientId,
    callback: callback
  });
  var container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  google.accounts.id.renderButton(container, {
    type: 'standard',
    size: 'large',
    theme: 'outline',
    text: 'sign_in_with',
    shape: 'rectangular',
    logo_alignment: 'left',
    width: 300
  });
}

function decodeJwt(credential) {
  var base64Url = credential.split('.')[1];
  var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  return JSON.parse(atob(base64));
}

// ============================================
// DOMAIN DETECTION & CHURCH LOOKUP
// ============================================
var CONSUMER_DOMAINS = [
  'gmail.com','googlemail.com','yahoo.com','yahoo.co.uk','hotmail.com',
  'outlook.com','live.com','msn.com','aol.com','icloud.com','me.com',
  'mac.com','mail.com','protonmail.com','proton.me','zoho.com',
  'yandex.com','gmx.com','gmx.net','fastmail.com','tutanota.com',
  'hey.com','pm.me','comcast.net','verizon.net','att.net','sbcglobal.net',
  'cox.net','charter.net','earthlink.net','juno.com','bellsouth.net',
  'rocketmail.com','aim.com','optonline.net','frontier.com','windstream.net'
];

var detectedOrg = null; // stores AI detection result

function getDomain(email) {
  if (!email || !email.includes('@')) return '';
  return email.split('@')[1].toLowerCase();
}

function isConsumerDomain(domain) {
  return CONSUMER_DOMAINS.includes(domain);
}

// Check if this domain is already registered (local check for now)
// FUTURE: Replace this with an API call to a central registry
function checkRegistration(domain) {
  // Single-tenant check: if app is set up and the domain matches
  // any admin's domain, it's "registered"
  if (appConfig.setupComplete) {
    var admins = loadAdmins();
    return admins.some(function(a) {
      return getDomain(a.email) === domain;
    });
  }
  return false;
}

// Call Claude API to identify if a domain belongs to a church.
// Routes through GAS proxy when available, falls back to direct browser call during setup.
async function lookupChurchDomain(domain, apiKey) {
  if (!domain) return null;

  // Try GAS proxy first (key stored server-side)
  if (appConfig.apiUrl) {
    try {
      var proxyResp = await fetch(appConfig.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'ai-lookup', domain: domain })
      });
      var proxyResult = await proxyResp.json();
      if (proxyResult.success && proxyResult.result) {
        return proxyResult.result;
      }
      // If server says no key, fall through to direct call
    } catch(err) {
      console.warn('GAS proxy lookup failed, trying direct:', err);
    }
  }

  // Fall back to direct browser call (during setup, before GAS URL exists)
  if (!apiKey) return null;
  var prompt = 'Analyze this email domain: "' + domain + '"\n\n' +
    'Based on the domain name and any knowledge you have, determine:\n' +
    '1. Is this likely a church, parish, temple, synagogue, mosque, or other religious organization?\n' +
    '2. If yes, what is the probable full name of the organization?\n' +
    '3. What denomination or religious tradition (if identifiable from the domain)?\n' +
    '4. What city/state or region (if identifiable)?\n\n' +
    'Return ONLY a JSON object with these fields:\n' +
    '{\n' +
    '  "isReligiousOrg": boolean,\n' +
    '  "organizationName": string (full name, e.g. "St. Theresa Catholic Church"),\n' +
    '  "denomination": string (e.g. "Catholic", "Baptist", "Methodist", "Non-denominational", or ""),\n' +
    '  "location": string (e.g. "Austin, TX" or "" if unknown),\n' +
    '  "confidence": "high" | "medium" | "low"\n' +
    '}\n\n' +
    'If you cannot determine, set isReligiousOrg to false. Return ONLY JSON, no explanation.';

  try {
    var response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-5-20250929',
        max_tokens: 256,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) return null;

    var result = await response.json();
    var text = result.content[0].text;
    text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
    return JSON.parse(text);
  } catch(err) {
    console.error('Church lookup error:', err);
    return null;
  }
}

// Run full domain detection flow
async function runDomainDetection(email) {
  var detectionDiv = document.getElementById('domain-detection');
  var domain = getDomain(email);

  if (!domain || isConsumerDomain(domain)) {
    // Personal email - no detection needed
    detectionDiv.classList.add('hidden');
    detectedOrg = null;
    return;
  }

  // Show detecting state
  detectionDiv.classList.remove('hidden');
  detectionDiv.innerHTML =
    '<div class="detection-card detecting">' +
      '<div class="detection-spinner-sm"></div>' +
      '<span class="detection-detail">Checking ' + escapeHtml(domain) + '...</span>' +
    '</div>';

  // Check if already registered with us
  if (checkRegistration(domain)) {
    detectionDiv.innerHTML =
      '<div class="detection-card found">' +
        '<div class="detection-icon">&#9989;</div>' +
        '<div class="detection-title">Welcome back!</div>' +
        '<div class="detection-detail">This organization is already set up. You\'ll be added as an administrator.</div>' +
      '</div>';
    detectedOrg = { isReligiousOrg: true, alreadyRegistered: true };
    return;
  }

  // Try AI lookup
  var apiKey = document.getElementById('setup-api-key').value.trim();
  if (!apiKey) {
    // No API key yet - try heuristic detection from domain name
    var heuristic = heuristicChurchDetect(domain);
    if (heuristic) {
      detectedOrg = heuristic;
      showDetectionResult(heuristic, domain);
    } else {
      detectionDiv.innerHTML =
        '<div class="detection-card not-found">' +
          '<div class="detection-icon">&#127970;</div>' +
          '<div class="detection-title">Custom domain detected</div>' +
          '<div class="detection-detail">We detected <strong>' + escapeHtml(domain) + '</strong>. ' +
          'Enter your API key above and we\'ll try to identify your organization automatically.</div>' +
        '</div>';
      detectedOrg = null;
    }
    return;
  }

  // AI-powered lookup
  var result = await lookupChurchDomain(domain, apiKey);

  if (result && result.isReligiousOrg) {
    detectedOrg = result;
    showDetectionResult(result, domain);
  } else {
    detectionDiv.innerHTML =
      '<div class="detection-card not-found">' +
        '<div class="detection-icon">&#127970;</div>' +
        '<div class="detection-title">Organization detected</div>' +
        '<div class="detection-detail">We see you\'re using <strong>' + escapeHtml(domain) + '</strong>. ' +
        'You\'ll configure your organization details in the next step.</div>' +
      '</div>';
    detectedOrg = null;
  }
}

function showDetectionResult(result, domain) {
  var detectionDiv = document.getElementById('domain-detection');
  var meta = [];
  if (result.denomination) meta.push(result.denomination);
  if (result.location) meta.push(result.location);

  detectionDiv.innerHTML =
    '<div class="detection-card found">' +
      '<div class="detection-icon">&#9962;</div>' +
      '<div class="detection-title">We found your organization!</div>' +
      '<div class="detection-org-name">' + escapeHtml(result.organizationName || domain) + '</div>' +
      (meta.length > 0 ? '<div class="detection-meta">' + meta.map(escapeHtml).join(' &middot; ') + '</div>' : '') +
      '<div class="detection-detail" style="margin-top:10px;">We\'ll pre-fill your setup with this information.</div>' +
    '</div>';
}

// Heuristic church detection from domain name patterns
function heuristicChurchDetect(domain) {
  var name = domain.split('.')[0].toLowerCase();
  var churchWords = [
    'church','parish','catholic','baptist','methodist','lutheran',
    'presbyterian','episcopal','pentecostal','adventist','orthodox',
    'assembly','temple','synagogue','mosque','masjid','chapel',
    'ministry','ministries','diocese','archdiocese','congregation',
    'covenant','gospel','faith','grace','hope','trinity','calvary',
    'bethel','zion','emmanuel','immanuel','redeemer','shepherd',
    'saint','saints','st-','umc','cogic'
  ];

  var found = churchWords.some(function(word) {
    return name.includes(word);
  });

  if (!found) return null;

  // Try to build a readable name from the domain
  var readable = name
    .replace(/-/g, ' ')
    .replace(/\b\w/g, function(c) { return c.toUpperCase(); })
    .replace(/\bSt /g, 'St. ')
    .replace(/\bUmc\b/g, 'United Methodist Church')
    .replace(/\bCogic\b/g, 'Church of God in Christ');

  return {
    isReligiousOrg: true,
    organizationName: readable,
    denomination: '',
    location: '',
    confidence: 'low'
  };
}

// Re-run detection when API key is entered (in case domain was already captured)
document.getElementById('setup-api-key').addEventListener('change', function() {
  if (setupAdminData && setupAdminData.email) {
    var domain = getDomain(setupAdminData.email);
    if (domain && !isConsumerDomain(domain) && !detectedOrg) {
      runDomainDetection(setupAdminData.email);
    }
  }
});

// ============================================
// GOOGLE SIGN-IN HANDLERS
// ============================================

// Admin sign-in (during /start wizard)
function handleAdminSignIn(response) {
  var payload = decodeJwt(response.credential);
  setupAdminData = {
    email: payload.email || '',
    firstName: payload.given_name || '',
    lastName: payload.family_name || '',
    picture: payload.picture || ''
  };

  // Show signed-in state
  document.getElementById('admin-signed-in').classList.remove('hidden');
  document.getElementById('admin-setup-initials').textContent =
    (setupAdminData.firstName[0] || '') + (setupAdminData.lastName[0] || '');
  document.getElementById('admin-setup-name').textContent =
    setupAdminData.firstName + ' ' + setupAdminData.lastName;
  document.getElementById('admin-setup-email').textContent = setupAdminData.email;

  // Enable next button
  document.getElementById('step1-next').disabled = false;

  // Run domain detection
  runDomainDetection(setupAdminData.email);
}

// Parishioner sign-in (auto-fill registration form)
function handleParishionerSignIn(response) {
  var payload = decodeJwt(response.credential);

  // Check if this is a church domain + app not set up = potential first-time admin
  var domain = getDomain(payload.email || '');
  if (domain && !isConsumerDomain(domain) && !appConfig.setupComplete) {
    // This looks like an org admin, not a parishioner
    // Route them to /start wizard with their data pre-loaded
    setupAdminData = {
      email: payload.email || '',
      firstName: payload.given_name || '',
      lastName: payload.family_name || '',
      picture: payload.picture || ''
    };
    showView('start');
    showWizardStep(1);
    // Trigger the signed-in state on the wizard
    document.getElementById('admin-signed-in').classList.remove('hidden');
    document.getElementById('admin-setup-initials').textContent =
      (setupAdminData.firstName[0] || '') + (setupAdminData.lastName[0] || '');
    document.getElementById('admin-setup-name').textContent =
      setupAdminData.firstName + ' ' + setupAdminData.lastName;
    document.getElementById('admin-setup-email').textContent = setupAdminData.email;
    document.getElementById('step1-next').disabled = false;
    runDomainDetection(setupAdminData.email);
    return;
  }

  // Normal parishioner flow - auto-fill form
  document.getElementById('firstName').value = payload.given_name || '';
  document.getElementById('lastName').value = payload.family_name || '';
  document.getElementById('email').value = payload.email || '';
  document.getElementById('phone').focus();

  // If this person is an admin, create a session for them
  if (isAdmin(payload.email)) {
    currentSession = {
      email: payload.email,
      firstName: payload.given_name || '',
      lastName: payload.family_name || '',
      picture: payload.picture || '',
      role: 'admin'
    };
    saveSession(currentSession);
  }
}

// ============================================
// NAV BAR
// ============================================
function updateNavBar() {
  if (!currentSession) return;
  var role = getUserRole(currentSession.email);
  document.getElementById('nav-brand-text').textContent = appConfig.appTitle || 'Ministry Fair';
  document.getElementById('nav-user-name').textContent =
    currentSession.firstName + ' ' + currentSession.lastName;
  document.getElementById('nav-user-email').textContent = currentSession.email;

  var badge = document.getElementById('nav-role-badge');
  badge.textContent = role === 'admin' ? 'Admin' : 'Member';
  badge.className = 'role-badge role-' + role;

  // Only show settings gear for admins
  document.getElementById('nav-settings-btn').classList.toggle('hidden', role !== 'admin');
}

document.getElementById('nav-settings-btn').addEventListener('click', function() {
  showSettingsView();
});

document.getElementById('nav-logout-btn').addEventListener('click', function() {
  if (confirm('Log out of your admin session?')) {
    currentSession = null;
    saveSession(null);
    document.getElementById('top-nav').classList.add('hidden');
    // If they also had a parishioner profile, keep that flow
    if (hasSavedProfile()) {
      showMinistriesList();
    } else {
      showView('register');
    }
  }
});

// ============================================
// SECURITY: HTML ESCAPING
// ============================================
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function isValidEmail(email) {
  if (!email) return false;
  if (/^javascript:/i.test(email.trim())) return false;
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// ============================================
// PHONE FORMATTING
// ============================================
function formatPhoneNumber(value) {
  if (!value) return '';
  var digits = value.replace(/\D/g, '');
  if (digits.length === 11 && digits[0] === '1') digits = digits.slice(1);
  digits = digits.slice(0, 10);
  if (digits.length === 0) return '';
  if (digits.length <= 3) return '(' + digits + ')';
  if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
  return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6);
}

// ============================================
// START WIZARD
// ============================================
function showWizardStep(step) {
  wizardStep = step;

  // Restore API key from sessionStorage into the input field
  if (step === 1) {
    var savedKey = getApiKey();
    var keyInput = document.getElementById('setup-api-key');
    if (savedKey && keyInput && !keyInput.value) {
      keyInput.value = savedKey;
    }
  }

  // Update step dots
  document.querySelectorAll('.step-dot').forEach(function(dot) {
    var s = parseInt(dot.dataset.step);
    dot.className = 'step-dot';
    if (s < step) dot.classList.add('done');
    if (s === step) dot.classList.add('active');
  });
  document.querySelectorAll('.step-line').forEach(function(line) {
    var after = parseInt(line.dataset.after);
    line.className = 'step-line';
    if (after < step) line.classList.add('done');
  });

  // Show/hide steps
  document.querySelectorAll('.wizard-step').forEach(function(ws) {
    var s = parseInt(ws.dataset.wizardStep);
    ws.classList.toggle('active', s === step);
  });

  // Step-specific init
  if (step === 2) initStep2();
  if (step === 4) renderAdminList();
  if (step === 5) renderSummary();
}

// Step 2: Color grid + preview + pre-fill from detection
function initStep2() {
  // Pre-fill from AI detection results
  if (detectedOrg && detectedOrg.organizationName) {
    var orgInput = document.getElementById('setup-org-name');
    if (!orgInput.value) {
      orgInput.value = detectedOrg.organizationName;
    }
  }

  var grid = document.getElementById('color-grid');
  if (grid.children.length > 0) return; // already rendered

  COLOR_OPTIONS.forEach(function(opt) {
    var swatch = document.createElement('div');
    swatch.className = 'color-swatch' + (opt.color === appConfig.primaryColor ? ' selected' : '');
    swatch.style.background = 'linear-gradient(135deg, ' + opt.color + ' 0%, ' + opt.dark + ' 100%)';
    swatch.title = opt.name;
    swatch.dataset.color = opt.color;
    swatch.dataset.dark = opt.dark;
    swatch.addEventListener('click', function() {
      grid.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('selected'); });
      swatch.classList.add('selected');
      appConfig.primaryColor = opt.color;
      appConfig.primaryColorDark = opt.dark;
      updateHeaderPreview();
    });
    grid.appendChild(swatch);
  });

  // Sync inputs to preview
  var titleInput = document.getElementById('setup-app-title');
  var taglineInput = document.getElementById('setup-tagline');
  titleInput.addEventListener('input', updateHeaderPreview);
  taglineInput.addEventListener('input', updateHeaderPreview);
  updateHeaderPreview();
}

function updateHeaderPreview() {
  var preview = document.getElementById('header-preview');
  var title = document.getElementById('setup-app-title').value || 'Ministry Fair';
  var tagline = document.getElementById('setup-tagline').value || 'Find your place to serve';
  preview.style.background = 'linear-gradient(135deg, ' + appConfig.primaryColor + ' 0%, ' + appConfig.primaryColorDark + ' 100%)';
  document.getElementById('preview-title').textContent = title;
  document.getElementById('preview-tagline').textContent = tagline;
}

// ============================================
// STEP 3: FILE UPLOAD + AI SPREADSHEET ANALYSIS
// ============================================

var uploadedFileData = null; // { headers: [], rows: [] }
var aiMappingResult = null;  // result from Claude

// CSV Parser - handles quoted fields, commas in values, newlines in quotes
function parseCSV(text) {
  var rows = [];
  var row = [];
  var field = '';
  var inQuotes = false;
  var i = 0;

  while (i < text.length) {
    var ch = text[i];
    if (inQuotes) {
      if (ch === '"') {
        if (i + 1 < text.length && text[i + 1] === '"') {
          field += '"';
          i += 2;
        } else {
          inQuotes = false;
          i++;
        }
      } else {
        field += ch;
        i++;
      }
    } else {
      if (ch === '"') {
        inQuotes = true;
        i++;
      } else if (ch === ',') {
        row.push(field.trim());
        field = '';
        i++;
      } else if (ch === '\n' || (ch === '\r' && i + 1 < text.length && text[i + 1] === '\n')) {
        row.push(field.trim());
        if (row.some(function(c) { return c !== ''; })) rows.push(row);
        row = [];
        field = '';
        i += (ch === '\r') ? 2 : 1;
      } else if (ch === '\r') {
        row.push(field.trim());
        if (row.some(function(c) { return c !== ''; })) rows.push(row);
        row = [];
        field = '';
        i++;
      } else {
        field += ch;
        i++;
      }
    }
  }
  // Last field
  row.push(field.trim());
  if (row.some(function(c) { return c !== ''; })) rows.push(row);

  return rows;
}

// Tab-separated parser
function parseTSV(text) {
  return text.split(/\r?\n/).filter(function(line) { return line.trim(); }).map(function(line) {
    return line.split('\t').map(function(c) { return c.trim(); });
  });
}

// File upload - drag & drop and click
(function() {
  var area = document.getElementById('upload-area');
  var fileInput = document.getElementById('file-input');

  area.addEventListener('click', function() { fileInput.click(); });

  area.addEventListener('dragover', function(e) {
    e.preventDefault();
    area.classList.add('dragover');
  });
  area.addEventListener('dragleave', function() {
    area.classList.remove('dragover');
  });
  area.addEventListener('drop', function(e) {
    e.preventDefault();
    area.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
  });

  fileInput.addEventListener('change', function() {
    if (fileInput.files.length > 0) handleFile(fileInput.files[0]);
  });

  document.getElementById('remove-file-btn').addEventListener('click', function() {
    uploadedFileData = null;
    aiMappingResult = null;
    fileInput.value = '';
    document.getElementById('upload-area').classList.remove('hidden');
    document.getElementById('upload-filename').classList.add('hidden');
    document.getElementById('analysis-section').classList.add('hidden');
    document.getElementById('mapping-results').classList.add('hidden');
  });
})();

function handleFile(file) {
  document.getElementById('upload-area').classList.add('hidden');
  document.getElementById('upload-filename').classList.remove('hidden');
  document.getElementById('filename-text').textContent = file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)';
  document.getElementById('analysis-section').classList.remove('hidden');

  var reader = new FileReader();
  reader.onload = function(e) {
    var text = e.target.result;
    var parsed;

    // Detect format
    if (file.name.endsWith('.tsv') || file.name.endsWith('.txt')) {
      parsed = parseTSV(text);
    } else {
      // Try CSV first; if first row has only 1 column but has tabs, try TSV
      parsed = parseCSV(text);
      if (parsed.length > 0 && parsed[0].length === 1 && parsed[0][0].includes('\t')) {
        parsed = parseTSV(text);
      }
    }

    if (parsed.length < 2) {
      document.getElementById('analysis-progress').classList.add('hidden');
      document.getElementById('mapping-results').classList.remove('hidden');
      document.getElementById('mapping-summary-box').innerHTML =
        '<div class="mapping-summary warn"><h4>Not enough data</h4><p>The file needs at least a header row and one data row.</p></div>';
      return;
    }

    uploadedFileData = {
      headers: parsed[0],
      rows: parsed.slice(1)
    };

    analyzeWithAI(uploadedFileData);
  };
  reader.readAsText(file);
}

// Call Claude API to analyze the spreadsheet.
// Routes through GAS proxy when available, falls back to direct browser call during setup.
async function analyzeWithAI(data) {
  var apiKey = document.getElementById('setup-api-key').value.trim();
  var progress = document.getElementById('analysis-progress');
  var results = document.getElementById('mapping-results');

  progress.classList.remove('hidden');
  results.classList.add('hidden');

  var hasDirectKey = !!apiKey;
  var hasGasUrl = !!appConfig.apiUrl;

  if (!hasDirectKey && !hasGasUrl) {
    progress.classList.add('hidden');
    results.classList.remove('hidden');
    document.getElementById('mapping-summary-box').innerHTML =
      '<div class="mapping-summary warn"><h4>No API key provided</h4>' +
      '<p>Go back to Step 1 and enter your Claude API key to enable AI-powered spreadsheet analysis.</p></div>';
    return;
  }

  // Build sample data for the prompt (headers + first 5 rows max)
  var sampleRows = data.rows.slice(0, 5);
  var sampleText = 'HEADERS: ' + JSON.stringify(data.headers) + '\n\nSAMPLE ROWS:\n';
  sampleRows.forEach(function(row, i) {
    sampleText += 'Row ' + (i + 1) + ': ' + JSON.stringify(row) + '\n';
  });

  var prompt = 'I have a spreadsheet with ministry/group data from a church or parish. I need to map the columns to this schema:\n\n' +
    'REQUIRED FIELDS:\n' +
    '- name: The ministry or group name (REQUIRED)\n' +
    '- description: What the ministry does\n\n' +
    'OPTIONAL FIELDS:\n' +
    '- id: A short slug/identifier (if not present, we can generate from name)\n' +
    '- icon: An emoji representing the ministry\n' +
    '- organizerName: Contact person name\n' +
    '- organizerEmail: Contact person email\n' +
    '- organizerPhone: Contact person phone\n' +
    '- question1, question2, question3: Questions to ask people who sign up (in format: type|label|options where type is text/select/checkbox)\n\n' +
    'Here is the spreadsheet data:\n\n' + sampleText + '\n\n' +
    'Analyze the headers and data. Return a JSON object with:\n' +
    '1. "mapping": An object where each key is one of my schema fields (name, description, id, icon, organizerName, organizerEmail, organizerPhone, question1, question2, question3) and the value is the 0-based column index that best matches it, or -1 if no column matches.\n' +
    '2. "confidence": "high", "medium", or "low" - overall confidence in the mapping.\n' +
    '3. "found": Number of fields that were successfully mapped.\n' +
    '4. "missing": Array of field names that could not be mapped.\n' +
    '5. "suggestions": Array of human-readable suggestions for improving the data (e.g., "Add a Description column to explain what each ministry does"). Keep this to genuinely useful suggestions only.\n' +
    '6. "columnNotes": Object mapping column index to a note about what we think that column contains (for columns that DO map to something).\n\n' +
    'IMPORTANT: Return ONLY the JSON object, no markdown formatting, no explanation outside the JSON.';

  try {
    var mappingText = null;

    // Try GAS proxy first (key stored server-side)
    if (hasGasUrl) {
      try {
        var proxyResp = await fetch(appConfig.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'ai-analyze', sampleData: sampleText, prompt: prompt })
        });
        var proxyResult = await proxyResp.json();
        if (proxyResult.success && proxyResult.result) {
          aiMappingResult = typeof proxyResult.result === 'string' ? JSON.parse(proxyResult.result) : proxyResult.result;
          mappingText = 'done';
        }
      } catch(proxyErr) {
        console.warn('GAS proxy analysis failed, trying direct:', proxyErr);
      }
    }

    // Fall back to direct browser call
    if (!mappingText && hasDirectKey) {
      var response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-5-20250929',
          max_tokens: 1024,
          messages: [{ role: 'user', content: prompt }]
        })
      });

      if (!response.ok) {
        var errBody = await response.text();
        throw new Error('API error ' + response.status + ': ' + errBody);
      }

      var result = await response.json();
      var text = result.content[0].text;
      text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
      aiMappingResult = JSON.parse(text);
    }

    if (!aiMappingResult) {
      throw new Error('No AI analysis result received');
    }

    progress.classList.add('hidden');
    results.classList.remove('hidden');
    renderMappingResults(aiMappingResult, data);

  } catch(err) {
    progress.classList.add('hidden');
    results.classList.remove('hidden');
    document.getElementById('mapping-summary-box').innerHTML =
      '<div class="mapping-summary warn"><h4>Analysis error</h4>' +
      '<p>' + escapeHtml(err.message) + '</p>' +
      '<p style="margin-top:8px;">Check that your API key is correct and try again.</p></div>';
  }
}

// Render AI mapping results
function renderMappingResults(mapping, data) {
  var FIELD_LABELS = {
    name: { label: 'Ministry Name', required: true },
    description: { label: 'Description', required: false },
    id: { label: 'ID / Slug', required: false },
    icon: { label: 'Icon (emoji)', required: false },
    organizerName: { label: 'Organizer Name', required: false },
    organizerEmail: { label: 'Organizer Email', required: false },
    organizerPhone: { label: 'Organizer Phone', required: false },
    question1: { label: 'Question 1', required: false },
    question2: { label: 'Question 2', required: false },
    question3: { label: 'Question 3', required: false }
  };

  // Summary box
  var summaryClass = mapping.confidence === 'high' ? 'good' : 'warn';
  var summaryIcon = mapping.confidence === 'high' ? '&#10003;' : '&#9888;';
  var summaryText = 'Mapped ' + mapping.found + ' of 10 fields from your spreadsheet (' + data.rows.length + ' ministries found).';
  document.getElementById('mapping-summary-box').innerHTML =
    '<div class="mapping-summary ' + summaryClass + '">' +
    '<h4>' + summaryIcon + ' ' + summaryText + '</h4></div>';

  // Mapping table
  var tbody = document.getElementById('mapping-table-body');
  var fields = Object.keys(FIELD_LABELS);
  tbody.innerHTML = fields.map(function(field) {
    var info = FIELD_LABELS[field];
    var colIdx = mapping.mapping[field];
    var isMapped = colIdx !== undefined && colIdx >= 0 && colIdx < data.headers.length;
    var yourCol = isMapped ? data.headers[colIdx] : '&mdash;';
    var statusClass = isMapped ? 'mapped' : (info.required ? 'missing' : 'optional');
    var statusText = isMapped ? '&#10003; Mapped' : (info.required ? '&#10007; Missing' : 'Not found');
    var note = (mapping.columnNotes && mapping.columnNotes[String(colIdx)]) ? ' <span style="color:#888;font-size:11px;">(' + escapeHtml(mapping.columnNotes[String(colIdx)]) + ')</span>' : '';

    return '<tr>' +
      '<td>' + escapeHtml(info.label) + (info.required ? ' <span style="color:#c53030;">*</span>' : '') + '</td>' +
      '<td>' + escapeHtml(yourCol) + note + '</td>' +
      '<td><span class="mapping-status ' + statusClass + '">' + statusText + '</span></td>' +
      '</tr>';
  }).join('');

  // Suggestions
  var suggestionsDiv = document.getElementById('mapping-suggestions');
  if (mapping.suggestions && mapping.suggestions.length > 0) {
    suggestionsDiv.innerHTML =
      '<div class="mapping-summary warn" style="margin-top: 12px;">' +
      '<h4>Suggestions</h4><ul>' +
      mapping.suggestions.map(function(s) { return '<li>' + escapeHtml(s) + '</li>'; }).join('') +
      '</ul></div>';
  } else {
    suggestionsDiv.innerHTML = '';
  }

  // Data preview (first 3 rows mapped to our fields)
  renderDataPreview(mapping, data);
}

function renderDataPreview(mapping, data) {
  var table = document.getElementById('data-preview-table');
  var ourHeaders = ['ID', 'Name', 'Description', 'Icon', 'Organizer', 'Email', 'Phone'];
  var fieldKeys = ['id', 'name', 'description', 'icon', 'organizerName', 'organizerEmail', 'organizerPhone'];

  var thead = '<thead><tr>' + ourHeaders.map(function(h) { return '<th>' + escapeHtml(h) + '</th>'; }).join('') + '</tr></thead>';

  var previewRows = data.rows.slice(0, 3);
  var tbody = '<tbody>' + previewRows.map(function(row) {
    return '<tr>' + fieldKeys.map(function(key) {
      var idx = mapping.mapping[key];
      if (idx === undefined || idx < 0 || idx >= row.length) return '<td style="color:#ccc;">-</td>';
      var val = row[idx] || '';
      if (val.length > 30) val = val.substring(0, 30) + '...';
      return '<td>' + escapeHtml(val) + '</td>';
    }).join('') + '</tr>';
  }).join('') + '</tbody>';

  table.innerHTML = thead + tbody;
}

// Download formatted CSV using the AI mapping
document.getElementById('download-formatted-btn').addEventListener('click', function() {
  if (!uploadedFileData || !aiMappingResult) return;

  var outHeaders = ['ID', 'Name', 'Description', 'Icon', 'Organizer Name', 'Organizer Email', 'Organizer Phone', 'Question 1', 'Question 2', 'Question 3'];
  var fieldKeys = ['id', 'name', 'description', 'icon', 'organizerName', 'organizerEmail', 'organizerPhone', 'question1', 'question2', 'question3'];
  var m = aiMappingResult.mapping;

  function csvEscape(val) {
    val = String(val || '');
    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
      return '"' + val.replace(/"/g, '""') + '"';
    }
    return val;
  }

  function slugify(text) {
    return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
  }

  var csv = '\uFEFF'; // BOM
  csv += outHeaders.map(csvEscape).join(',') + '\n';

  uploadedFileData.rows.forEach(function(row) {
    var outRow = fieldKeys.map(function(key) {
      var idx = m[key];
      if (idx === undefined || idx < 0 || idx >= row.length) {
        // Auto-generate ID from name if missing
        if (key === 'id' && m.name >= 0 && m.name < row.length) {
          return slugify(row[m.name] || '');
        }
        return '';
      }
      return row[idx] || '';
    });
    csv += outRow.map(csvEscape).join(',') + '\n';
  });

  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'ministries-formatted.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// Test connection
document.getElementById('test-connection-btn').addEventListener('click', async function() {
  var url = document.getElementById('setup-api-url').value.trim();
  var statusDiv = document.getElementById('connection-status');

  if (!url) {
    statusDiv.innerHTML = '<div class="connection-status error">Please enter an API URL first.</div>';
    return;
  }

  statusDiv.innerHTML = '<div class="connection-status testing">Testing connection...</div>';

  try {
    var controller = new AbortController();
    var timeoutId = setTimeout(function() { controller.abort(); }, 10000);
    var response = await fetch(url, { signal: controller.signal });
    clearTimeout(timeoutId);
    var data = await response.json();

    if (data.ministries) {
      var count = data.ministries.length;
      statusDiv.innerHTML = '<div class="connection-status success">&#10003; Connected! Found ' + count + ' ministr' + (count === 1 ? 'y' : 'ies') + '.</div>';
    } else if (data.error) {
      statusDiv.innerHTML = '<div class="connection-status error">&#10007; Error: ' + escapeHtml(data.error) + '</div>';
    } else {
      statusDiv.innerHTML = '<div class="connection-status error">&#10007; Unexpected response. Make sure you deployed the correct Apps Script.</div>';
    }
  } catch(err) {
    statusDiv.innerHTML = '<div class="connection-status error">&#10007; Could not connect. Check the URL and try again.</div>';
  }
});

// Step 4: Admin management
function renderAdminList() {
  var list = document.getElementById('setup-admin-list');
  var admins = loadAdmins();

  // Make sure setup admin is in the list
  if (setupAdminData && !admins.some(function(a) { return a.email === setupAdminData.email; })) {
    admins.unshift({
      email: setupAdminData.email,
      firstName: setupAdminData.firstName,
      lastName: setupAdminData.lastName,
      picture: setupAdminData.picture,
      role: 'admin'
    });
    saveAdmins(admins);
    appAdmins = admins;
  }

  list.innerHTML = admins.map(function(admin, idx) {
    var initials = escapeHtml((admin.firstName[0] || '') + (admin.lastName[0] || ''));
    var isSetupAdmin = setupAdminData && admin.email === setupAdminData.email;
    return '<div class="admin-item">' +
      '<div class="profile-icon">' + initials + '</div>' +
      '<div class="admin-item-details">' +
        '<div class="admin-item-name">' + escapeHtml(admin.firstName + ' ' + admin.lastName) + '</div>' +
        '<div class="admin-item-email">' + escapeHtml(admin.email) + '</div>' +
      '</div>' +
      (isSetupAdmin ? '<span class="admin-item-tag">You</span>' :
        '<button class="admin-remove-btn" data-idx="' + idx + '" title="Remove">&times;</button>') +
    '</div>';
  }).join('');

  // Remove buttons
  list.querySelectorAll('.admin-remove-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var admins = loadAdmins();
      admins.splice(parseInt(btn.dataset.idx), 1);
      saveAdmins(admins);
      appAdmins = admins;
      renderAdminList();
    });
  });
}

document.getElementById('setup-add-admin-btn').addEventListener('click', function() {
  var input = document.getElementById('setup-new-admin-email');
  var email = input.value.trim().toLowerCase();
  if (!email || !email.includes('@')) return;

  var admins = loadAdmins();
  if (admins.some(function(a) { return a.email.toLowerCase() === email; })) {
    input.value = '';
    return; // already exists
  }

  // Derive a readable name from the email local part
  var localPart = email.split('@')[0]
    .replace(/[._-]+/g, ' ')
    .replace(/\b\w/g, function(c) { return c.toUpperCase(); });
  var nameParts = localPart.split(' ');

  admins.push({
    email: email,
    firstName: nameParts[0] || '',
    lastName: nameParts.slice(1).join(' ') || '',
    picture: '',
    role: 'admin'
  });
  saveAdmins(admins);
  appAdmins = admins;
  input.value = '';
  renderAdminList();
});

// Step 5: Summary
function renderSummary() {
  var orgName = document.getElementById('setup-org-name').value || '(not set)';
  var appTitle = document.getElementById('setup-app-title').value || 'Ministry Fair';
  var tagline = document.getElementById('setup-tagline').value || 'Find your place to serve';
  var apiUrl = document.getElementById('setup-api-url').value || '(not set)';
  var sheetUrl = document.getElementById('setup-sheet-url').value || '(not set)';
  var adminCount = loadAdmins().length;

  document.getElementById('setup-summary').innerHTML =
    '<div class="summary-row"><span class="summary-label">Organization</span><span class="summary-value">' + escapeHtml(orgName) + '</span></div>' +
    '<div class="summary-row"><span class="summary-label">App Title</span><span class="summary-value">' + escapeHtml(appTitle) + '</span></div>' +
    '<div class="summary-row"><span class="summary-label">Tagline</span><span class="summary-value">' + escapeHtml(tagline) + '</span></div>' +
    '<div class="summary-row"><span class="summary-label">Theme</span><span class="summary-value"><span style="display:inline-block;width:20px;height:20px;border-radius:4px;vertical-align:middle;background:' + escapeHtml(appConfig.primaryColor) + '"></span></span></div>' +
    '<div class="summary-row"><span class="summary-label">API URL</span><span class="summary-value">' + escapeHtml(apiUrl.length > 30 ? apiUrl.substring(0, 30) + '...' : apiUrl) + '</span></div>' +
    '<div class="summary-row"><span class="summary-label">Admins</span><span class="summary-value">' + adminCount + '</span></div>';
}

// Wizard navigation
document.getElementById('step1-next').addEventListener('click', function() { showWizardStep(2); });
document.getElementById('step2-back').addEventListener('click', function() { showWizardStep(1); });
document.getElementById('step2-next').addEventListener('click', function() { showWizardStep(3); });
document.getElementById('step3-back').addEventListener('click', function() { showWizardStep(2); });
document.getElementById('step3-next').addEventListener('click', function() { showWizardStep(4); });
document.getElementById('step4-back').addEventListener('click', function() { showWizardStep(3); });
document.getElementById('step4-next').addEventListener('click', function() { showWizardStep(5); });
document.getElementById('step5-back').addEventListener('click', function() { showWizardStep(4); });

// Launch!
document.getElementById('launch-btn').addEventListener('click', function() {
  // 
  // FUTURE: Payment step hook
  // Uncomment and implement when ready to add billing:
  //
  // if (!appConfig.paymentComplete) {
  //   showPaymentStep({
  //     organizationName: document.getElementById('setup-org-name').value,
  //     adminEmail: setupAdminData ? setupAdminData.email : '',
  //     detectedOrg: detectedOrg,
  //     onComplete: function() {
  //       appConfig.paymentComplete = true;
  //       // continue with launch below
  //     }
  //   });
  //   return;
  // }
  // 

  // Save all config
  appConfig.organizationName = document.getElementById('setup-org-name').value || '';
  appConfig.appTitle = document.getElementById('setup-app-title').value || 'Ministry Fair';
  appConfig.tagline = document.getElementById('setup-tagline').value || 'Find your place to serve';
  appConfig.apiUrl = document.getElementById('setup-api-url').value || '';
  appConfig.spreadsheetUrl = document.getElementById('setup-sheet-url').value || '';
  var enteredKey = document.getElementById('setup-api-key').value || '';
  setApiKey(enteredKey); // session-only backup
  appConfig.orgDomain = setupAdminData ? getDomain(setupAdminData.email) : '';
  appConfig.detectedOrg = detectedOrg || null;
  appConfig.setupComplete = true;
  saveAppConfig(appConfig);

  // Create admin session
  if (setupAdminData) {
    currentSession = {
      email: setupAdminData.email,
      firstName: setupAdminData.firstName,
      lastName: setupAdminData.lastName,
      picture: setupAdminData.picture,
      role: 'admin'
    };
    saveSession(currentSession);
  }

  // Save default notification settings
  saveNotificationSettings(notificationSettings);

  // Send API key to GAS for secure server-side storage
  if (enteredKey && appConfig.apiUrl) {
    fetch(appConfig.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'store-api-key', apiKey: enteredKey })
    }).then(function() {
      // Key stored server-side; clear from session
      setApiKey('');
    }).catch(function(err) {
      console.warn('Could not store API key server-side, keeping in session:', err);
    });
  }

  // Apply config and load the app
  applyConfig();
  loadMinistries();
});

// ============================================
// SETTINGS VIEW
// ============================================
function showSettingsView() {
  showView('settings');
  var role = currentSession ? getUserRole(currentSession.email) : 'parishioner';

  // Show/hide admin sections
  document.getElementById('settings-admin-sections').classList.toggle('hidden', role !== 'admin');

  // Populate current values
  document.getElementById('settings-org-name-val').textContent = appConfig.organizationName || '(not set)';
  document.getElementById('settings-app-title-val').textContent = appConfig.appTitle || 'Ministry Fair';
  document.getElementById('settings-color-swatch').style.background = appConfig.primaryColor;

  // API/sheet status
  document.getElementById('settings-api-status').textContent = appConfig.apiUrl ? 'Connected' : 'Not configured';
  document.getElementById('settings-sheet-status').textContent = appConfig.spreadsheetUrl ? 'Linked' : 'Not set';
  // Check server-side key status
  var keyStatusEl = document.getElementById('settings-claude-key-status');
  var sessionKey = getApiKey();
  keyStatusEl.textContent = sessionKey ? 'Session key active' : 'Checking server...';
  if (appConfig.apiUrl) {
    fetch(appConfig.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'check-api-key' })
    }).then(function(r) { return r.json(); }).then(function(data) {
      if (data.hasKey) {
        keyStatusEl.textContent = 'Stored securely on server';
        keyStatusEl.style.color = '#4a9c6d';
      } else if (sessionKey) {
        keyStatusEl.textContent = 'Session only (not on server)';
        keyStatusEl.style.color = '#a04000';
      } else {
        keyStatusEl.textContent = 'Not configured';
        keyStatusEl.style.color = '';
      }
    }).catch(function() {
      keyStatusEl.textContent = sessionKey ? 'Session only (server unreachable)' : 'Not configured';
    });
  } else {
    keyStatusEl.textContent = sessionKey ? 'Session only (no API URL)' : 'Not configured';
  }

  // User info
  if (currentSession) {
    document.getElementById('settings-user-name').textContent = currentSession.firstName + ' ' + currentSession.lastName;
    document.getElementById('settings-user-email').textContent = currentSession.email;
  } else if (hasSavedProfile()) {
    document.getElementById('settings-user-name').textContent = profile.firstName + ' ' + profile.lastName;
    document.getElementById('settings-user-email').textContent = profile.email;
  }

  // Admin list
  if (role === 'admin') {
    var adminsCard = document.getElementById('settings-admins-card');
    var admins = loadAdmins();
    adminsCard.innerHTML = admins.map(function(admin) {
      var initials = escapeHtml((admin.firstName[0] || '') + (admin.lastName[0] || ''));
      var isMe = currentSession && admin.email.toLowerCase() === currentSession.email.toLowerCase();
      return '<div class="settings-item">' +
        '<div style="display:flex;align-items:center;gap:10px;">' +
          '<div class="profile-icon" style="width:32px;height:32px;font-size:12px;">' + initials + '</div>' +
          '<div class="settings-item-left">' +
            '<div class="settings-item-label">' + escapeHtml(admin.firstName + ' ' + admin.lastName) + (isMe ? ' (you)' : '') + '</div>' +
            '<div class="settings-item-desc">' + escapeHtml(admin.email) + '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }).join('');

    // Notification toggles
    var ns = loadNotificationSettings();
    document.getElementById('toggle-email').className = 'toggle-switch' + (ns.emailEnabled ? ' on' : '');
    document.getElementById('toggle-text').className = 'toggle-switch' + (ns.textEnabled ? ' on' : '');

    // Email templates
    renderEmailTemplates();
  }
}

// Settings item click handlers (editable fields)
document.getElementById('settings-org-name-item').addEventListener('click', function() {
  var val = prompt('Organization Name:', appConfig.organizationName || '');
  if (val !== null) {
    appConfig.organizationName = val;
    saveAppConfig(appConfig);
    applyConfig();
    showSettingsView();
  }
});

document.getElementById('settings-app-title-item').addEventListener('click', function() {
  var val = prompt('App Title:', appConfig.appTitle || '');
  if (val !== null) {
    appConfig.appTitle = val;
    saveAppConfig(appConfig);
    applyConfig();
    showSettingsView();
  }
});

document.getElementById('settings-api-item').addEventListener('click', function() {
  var val = prompt('Google Apps Script API URL:', appConfig.apiUrl || '');
  if (val !== null) {
    appConfig.apiUrl = val;
    saveAppConfig(appConfig);
    showSettingsView();
  }
});

document.getElementById('settings-sheet-item').addEventListener('click', function() {
  var val = prompt('Google Sheet URL:', appConfig.spreadsheetUrl || '');
  if (val !== null) {
    appConfig.spreadsheetUrl = val;
    saveAppConfig(appConfig);
    showSettingsView();
  }
});

document.getElementById('settings-claude-key-item').addEventListener('click', function() {
  var current = getApiKey();
  var val = prompt('Claude API Key:\n\nIf your API URL is configured, this key will be sent to your server for secure storage. Otherwise it is kept in this browser session only.', current || '');
  if (val !== null && val.trim()) {
    setApiKey(val.trim());
    // Try to store on server
    if (appConfig.apiUrl) {
      fetch(appConfig.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'store-api-key', apiKey: val.trim() })
      }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.success) {
          setApiKey(''); // Clear from session since server has it
          alert('API key stored securely on server.');
        }
        showSettingsView();
      }).catch(function() {
        alert('Could not reach server. Key stored in this session only.');
        showSettingsView();
      });
    } else {
      showSettingsView();
    }
  } else if (val !== null) {
    setApiKey('');
    showSettingsView();
  }
});

function renderEmailTemplates() {
  var ns = loadNotificationSettings();
  var container = document.getElementById('settings-email-templates');
  var html = '';
  var keys = Object.keys(ns.templates);
  keys.forEach(function(key) {
    var t = ns.templates[key];
    html += '<div class="template-card">' +
      '<h4>' + escapeHtml(t.name) + '</h4>' +
      '<p>Subject: ' + escapeHtml(t.subject) + '</p>' +
      '<textarea data-template-key="' + escapeHtml(key) + '">' + escapeHtml(t.body) + '</textarea>' +
    '</div>';
  });
  container.innerHTML = html;

  // Save on change
  container.querySelectorAll('textarea').forEach(function(ta) {
    ta.addEventListener('change', function() {
      var ns = loadNotificationSettings();
      ns.templates[ta.dataset.templateKey].body = ta.value;
      saveNotificationSettings(ns);
    });
  });
}

// Toggle switches
document.querySelectorAll('.toggle-switch').forEach(function(toggle) {
  toggle.addEventListener('click', function() {
    toggle.classList.toggle('on');
    var ns = loadNotificationSettings();
    ns[toggle.dataset.key] = toggle.classList.contains('on');
    saveNotificationSettings(ns);
  });
});

// Settings back button
document.getElementById('settings-back-btn').addEventListener('click', function() {
  showMinistriesList();
});

// Settings logout
document.getElementById('settings-logout-item').addEventListener('click', function() {
  if (confirm('Are you sure you want to log out?')) {
    currentSession = null;
    saveSession(null);
    localStorage.removeItem('ministry-fair-profile');
    localStorage.removeItem('ministry-fair-interests');
    profile = { firstName: '', lastName: '', email: '', phone: '', wantsToJoinParish: false };
    interests = [];
    currentMinistry = null;
    showAll = false;
    searchTerm = '';
    showView('register');
  }
});

// ============================================
// APPLY CONFIGURATION
// ============================================
function applyConfig() {
  document.title = appConfig.appTitle || 'Ministry Fair';

  document.querySelectorAll('.app-title').forEach(function(el) {
    el.textContent = appConfig.appTitle || 'Ministry Fair';
  });
  document.querySelectorAll('.app-tagline').forEach(function(el) {
    el.textContent = appConfig.tagline || 'Find your place to serve';
  });

  var consentText = document.getElementById('consentText');
  if (consentText) {
    consentText.textContent = 'By clicking Continue, you give ' + (appConfig.organizationName || 'us') + ' permission to contact you by email or phone about the ministries you express interest in.';
  }

  var joinLabel = document.getElementById('joinParishLabel');
  if (joinLabel) {
    joinLabel.textContent = "I'm not yet a parishioner but I'd like to join " + (appConfig.organizationName || 'the parish') + '.';
  }

  // Apply theme color to headers
  document.querySelectorAll('.header').forEach(function(h) {
    h.style.background = 'linear-gradient(135deg, ' + appConfig.primaryColor + ' 0%, ' + appConfig.primaryColorDark + ' 100%)';
  });
  // Apply to buttons
  document.querySelectorAll('.btn:not(.btn-green)').forEach(function(b) {
    b.style.background = 'linear-gradient(135deg, ' + appConfig.primaryColor + ' 0%, ' + appConfig.primaryColorDark + ' 100%)';
  });
  document.querySelectorAll('.btn-secondary').forEach(function(b) {
    b.style.color = appConfig.primaryColor;
    b.style.borderColor = appConfig.primaryColor;
  });
}

// ============================================
// FETCH MINISTRIES
// ============================================
async function loadMinistries() {
  var apiUrl = appConfig.apiUrl;
  if (!apiUrl) {
    MINISTRIES = FALLBACK_MINISTRIES;
    initializeApp();
    return;
  }

  try {
    var controller = new AbortController();
    var timeoutId = setTimeout(function() { controller.abort(); }, 10000);
    var response = await fetch(apiUrl, { signal: controller.signal });
    clearTimeout(timeoutId);
    var data = await response.json();
    if (data.ministries && data.ministries.length > 0) {
      MINISTRIES = data.ministries;
    } else {
      MINISTRIES = FALLBACK_MINISTRIES;
    }
  } catch (error) {
    console.error('Error loading ministries:', error);
    MINISTRIES = FALLBACK_MINISTRIES;
  }

  // Clean up stale interests referencing deleted ministries
  var validIds = new Set(MINISTRIES.map(function(m) { return m.id; }));
  var cleanInterests = interests.filter(function(i) { return validIds.has(i.ministryId); });
  if (cleanInterests.length !== interests.length) {
    interests = cleanInterests;
    localStorage.setItem('ministry-fair-interests', JSON.stringify(interests));
  }

  initializeApp();
}

// ============================================
// APP INITIALIZATION
// ============================================
function initializeApp() {
  if (hasSavedProfile()) {
    // Check if this user is an admin and auto-create session
    if (isAdmin(profile.email) && !currentSession) {
      currentSession = {
        email: profile.email,
        firstName: profile.firstName,
        lastName: profile.lastName,
        picture: '',
        role: 'admin'
      };
      saveSession(currentSession);
    }

    if (ministryParam) {
      currentMinistry = MINISTRIES.find(function(m) { return m.id === ministryParam; });
      if (currentMinistry) {
        showMinistryDetail(currentMinistry);
      } else {
        showMinistriesList();
      }
    } else {
      showMinistriesList();
    }
  } else {
    showView('register');
  }
}

// ============================================
// THEME (LIGHT / DARK MODE)
// ============================================
function initTheme() {
  var saved = localStorage.getItem('mf-theme');
  // Default to dark
  var theme = saved || 'dark';
  applyTheme(theme);
}

function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.classList.add('dark');
  } else {
    document.body.classList.remove('dark');
  }
  // Update toggle icon: sun for dark mode (click to go light), moon for light mode
  var btn = document.getElementById('theme-toggle');
  btn.textContent = theme === 'dark' ? '\u2600' : '\u263D';
  btn.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
  localStorage.setItem('mf-theme', theme);
}

document.getElementById('theme-toggle').addEventListener('click', function() {
  var isDark = document.body.classList.contains('dark');
  applyTheme(isDark ? 'light' : 'dark');
});

// Apply theme immediately (before boot to avoid flash)
initTheme();

// ============================================
// BOOT SEQUENCE
// ============================================
function boot() {
  var hash = window.location.hash;

  // If #/start is in URL or setup not complete, show wizard
  if (hash === '#/start' || !appConfig.setupComplete) {
    applyConfig();
    showView('start');
    showWizardStep(1);
    return;
  }

  // If #/settings, show settings (if admin)
  if (hash === '#/settings' && currentSession && getUserRole(currentSession.email) === 'admin') {
    applyConfig();
    loadMinistries().then(function() {
      showSettingsView();
    }).catch(function() {
      showSettingsView();
    });
    return;
  }

  // Normal boot
  applyConfig();
  loadMinistries();
}

// Apply phone formatting
var phoneInput = document.getElementById('phone');
if (phoneInput) {
  phoneInput.addEventListener('input', function(e) {
    e.target.value = formatPhoneNumber(e.target.value);
  });
}

// Register form
document.getElementById('register-form').addEventListener('submit', function(e) {
  e.preventDefault();
  profile = {
    firstName: document.getElementById('firstName').value,
    lastName: document.getElementById('lastName').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    wantsToJoinParish: document.getElementById('joinParish').checked
  };
  localStorage.setItem('ministry-fair-profile', JSON.stringify(profile));

  // Check if admin
  if (isAdmin(profile.email) && !currentSession) {
    currentSession = {
      email: profile.email,
      firstName: profile.firstName,
      lastName: profile.lastName,
      picture: '',
      role: 'admin'
    };
    saveSession(currentSession);
  }

  if (ministryParam) {
    currentMinistry = MINISTRIES.find(function(m) { return m.id === ministryParam; });
    if (currentMinistry) {
      showMinistryDetail(currentMinistry);
      return;
    }
  }
  showMinistriesList();
});

// ============================================
// MINISTRY LIST
// ============================================
function showMinistriesList() {
  showView('ministries');

  // Hide parishioner profile badge if admin (they have the nav)
  var profileBadge = document.getElementById('parishioner-profile-badge');
  if (currentSession && getUserRole(currentSession.email) === 'admin') {
    profileBadge.classList.add('hidden');
  } else {
    profileBadge.classList.remove('hidden');
    document.getElementById('profile-initials').textContent = (profile.firstName[0] || '') + (profile.lastName[0] || '');
    document.getElementById('profile-name').textContent = profile.firstName + ' ' + profile.lastName;
    document.getElementById('profile-email').textContent = profile.email;
    document.getElementById('profile-phone').textContent = formatPhoneNumber(profile.phone);
  }

  var count = interests.length;
  document.getElementById('interest-count').textContent = count > 0
    ? count + ' interest' + (count > 1 ? 's' : '') + ' expressed'
    : 'Tap a ministry to learn more';

  var searchInput = document.getElementById('ministry-search');
  searchInput.value = searchTerm;
  searchInput.oninput = function() {
    searchTerm = this.value.toLowerCase();
    renderMinistryList();
  };

  renderMinistryList();
}

function renderMinistryList() {
  var list = document.getElementById('ministry-list');

  var filtered = MINISTRIES;
  if (searchTerm) {
    filtered = MINISTRIES.filter(function(m) {
      return m.name.toLowerCase().includes(searchTerm) ||
        m.description.toLowerCase().includes(searchTerm) ||
        (m.organizerName && m.organizerName.toLowerCase().includes(searchTerm));
    });
  }

  var sorted = filtered.slice().sort(function(a, b) {
    var aI = interests.some(function(i) { return i.ministryId === a.id; });
    var bI = interests.some(function(i) { return i.ministryId === b.id; });
    if (aI && !bI) return -1;
    if (!aI && bI) return 1;
    return a.name.localeCompare(b.name);
  });

  var displayed = (showAll || searchTerm) ? sorted : sorted.slice(0, 5);

  if (displayed.length === 0) {
    list.innerHTML = '<div class="no-results">No ministries found matching "' + escapeHtml(searchTerm) + '"</div>';
  } else {
    list.innerHTML = displayed.map(function(m) {
      var interested = interests.some(function(i) { return i.ministryId === m.id; });
      return '<div class="ministry-card ' + (interested ? 'interested' : '') + '" data-id="' + escapeHtml(m.id) + '">' +
        '<div class="ministry-icon">' + escapeHtml(m.icon) + '</div>' +
        '<div class="ministry-info">' +
          '<h3 class="ministry-name">' + escapeHtml(m.name) + '</h3>' +
          '<p class="ministry-desc">' + escapeHtml(m.description) + '</p>' +
        '</div>' +
        (interested ? '<span class="badge">Interested</span>' : '') +
      '</div>';
    }).join('');
  }

  var showAllBtn = document.getElementById('show-all-btn');
  if (!showAll && !searchTerm && MINISTRIES.length > 5) {
    showAllBtn.classList.remove('hidden');
    showAllBtn.textContent = 'Show All ' + MINISTRIES.length + ' Ministries';
  } else {
    showAllBtn.classList.add('hidden');
  }

  list.querySelectorAll('.ministry-card').forEach(function(card) {
    card.addEventListener('click', function() {
      var ministry = MINISTRIES.find(function(m) { return m.id === card.dataset.id; });
      showMinistryDetail(ministry);
    });
  });
}

document.getElementById('show-all-btn').addEventListener('click', function() {
  showAll = true;
  renderMinistryList();
});

// ============================================
// MINISTRY DETAIL
// ============================================
function showMinistryDetail(ministry) {
  currentMinistry = ministry;
  showView('detail');

  document.getElementById('detail-name').textContent = ministry.name;
  document.getElementById('detail-icon').textContent = ministry.icon;
  document.getElementById('detail-desc').textContent = ministry.description;

  var questionsDiv = document.getElementById('detail-questions');
  if (ministry.questions && ministry.questions.length > 0) {
    questionsDiv.innerHTML = '<div class="form">' + ministry.questions.map(function(q) {
      if (q.type === 'select') {
        return '<div class="input-group">' +
          '<label class="label">' + escapeHtml(q.label) + '</label>' +
          '<select class="select" data-qid="' + escapeHtml(q.id) + '">' +
            '<option value="">Select...</option>' +
            q.options.map(function(opt) { return '<option value="' + escapeHtml(opt) + '">' + escapeHtml(opt) + '</option>'; }).join('') +
          '</select></div>';
      } else if (q.type === 'checkbox') {
        return '<div class="input-group">' +
          '<label class="label">' + escapeHtml(q.label) + '</label>' +
          '<div class="checkbox-options" data-qid="' + escapeHtml(q.id) + '" data-type="checkbox">' +
            q.options.map(function(opt, idx) {
              return '<div class="checkbox-option">' +
                '<input type="checkbox" id="q-' + escapeHtml(q.id) + '-' + idx + '" value="' + escapeHtml(opt) + '">' +
                '<label for="q-' + escapeHtml(q.id) + '-' + idx + '">' + escapeHtml(opt) + '</label></div>';
            }).join('') +
          '</div></div>';
      } else {
        return '<div class="input-group">' +
          '<label class="label">' + escapeHtml(q.label) + '</label>' +
          '<input type="text" class="input" data-qid="' + escapeHtml(q.id) + '" placeholder="Your answer">' +
        '</div>';
      }
    }).join('') + '</div>';
  } else {
    questionsDiv.innerHTML = '';
  }

  var interestBtn = document.getElementById('interest-btn');
  var removeBtn = document.getElementById('remove-btn');
  var alreadyInterested = interests.some(function(i) { return i.ministryId === ministry.id; });

  interestBtn.textContent = alreadyInterested ? ' Update Interest' : "I'm Interested!";
  interestBtn.className = alreadyInterested ? 'btn btn-green' : 'btn';

  if (alreadyInterested) {
    removeBtn.classList.remove('hidden');
  } else {
    removeBtn.classList.add('hidden');
  }
}

document.getElementById('back-btn').addEventListener('click', function() {
  currentMinistry = null;
  showMinistriesList();
});

// Remove interest
document.getElementById('remove-btn').addEventListener('click', function() {
  document.getElementById('modal-ministry-name').textContent = currentMinistry.name;
  document.getElementById('confirm-modal').classList.remove('hidden');
});

document.getElementById('modal-cancel').addEventListener('click', function() {
  document.getElementById('confirm-modal').classList.add('hidden');
});

document.querySelector('.modal-backdrop').addEventListener('click', function() {
  document.getElementById('confirm-modal').classList.add('hidden');
});

document.getElementById('modal-confirm').addEventListener('click', function() {
  var apiUrl = appConfig.apiUrl;
  if (apiUrl) {
    var payload = {
      firstName: profile.firstName,
      lastName: profile.lastName,
      email: profile.email,
      phone: profile.phone,
      wantsToJoinParish: profile.wantsToJoinParish || false,
      ministry: currentMinistry.name,
      action: 'Removed'
    };
    fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).catch(function(err) { console.error('API error:', err); });
  }

  interests = interests.filter(function(i) { return i.ministryId !== currentMinistry.id; });
  localStorage.setItem('ministry-fair-interests', JSON.stringify(interests));
  document.getElementById('confirm-modal').classList.add('hidden');
  currentMinistry = null;
  showMinistriesList();
});

// Submit interest
document.getElementById('interest-btn').addEventListener('click', async function() {
  var btn = this;
  var originalText = btn.textContent;

  try {
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    var answers = {};
    document.querySelectorAll('#detail-questions [data-qid]:not([data-type="checkbox"])').forEach(function(el) {
      answers[el.dataset.qid] = el.value;
    });
    document.querySelectorAll('#detail-questions [data-type="checkbox"]').forEach(function(group) {
      var qid = group.dataset.qid;
      var checked = [];
      group.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) {
        checked.push(cb.value);
      });
      answers[qid] = checked.join(', ');
    });

    var questions = currentMinistry.questions || [];
    var payload = {
      firstName: profile.firstName,
      lastName: profile.lastName,
      email: profile.email,
      phone: profile.phone,
      wantsToJoinParish: profile.wantsToJoinParish || false,
      ministry: currentMinistry.name,
      action: 'Signup',
      q1: questions[0] ? answers[questions[0].id] || '' : '',
      q2: questions[1] ? answers[questions[1].id] || '' : '',
      q3: questions[2] ? answers[questions[2].id] || '' : ''
    };

    var apiUrl = appConfig.apiUrl;
    if (apiUrl) {
      try {
        var response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        var result = await response.json();
        if (result.success === false) {
          console.warn('Server reported error:', result.error);
        }
      } catch(err) { console.error('API error:', err); }
    }

    var newInterest = {
      ministryId: currentMinistry.id,
      ministryName: currentMinistry.name,
      answers: answers,
      timestamp: new Date().toISOString()
    };

    interests = interests.filter(function(i) { return i.ministryId !== currentMinistry.id; });
    interests.push(newInterest);
    localStorage.setItem('ministry-fair-interests', JSON.stringify(interests));

    btn.disabled = false;
    showConfirmation();

  } catch (error) {
    console.error('Error submitting interest:', error);
    alert('Something went wrong. Please try again.');
    btn.disabled = false;
    btn.textContent = originalText;
  }
});

// ============================================
// CONFIRMATION
// ============================================
function showConfirmation() {
  if (!currentMinistry) {
    showMinistriesList();
    return;
  }

  showView('confirmed');
  document.getElementById('confirmed-ministry').textContent = currentMinistry.name;

  var organizerDiv = document.getElementById('organizer-info');
  if (currentMinistry.organizerName) {
    var contactHtml = '';
    if (currentMinistry.organizerEmail && isValidEmail(currentMinistry.organizerEmail)) {
      contactHtml += '<a href="mailto:' + escapeHtml(currentMinistry.organizerEmail) + '">' + escapeHtml(currentMinistry.organizerEmail) + '</a>';
    } else if (currentMinistry.organizerEmail) {
      contactHtml += escapeHtml(currentMinistry.organizerEmail);
    }
    if (currentMinistry.organizerPhone) {
      if (contactHtml) contactHtml += ' &middot; ';
      var formattedPhone = formatPhoneNumber(currentMinistry.organizerPhone);
      contactHtml += '<a href="tel:' + escapeHtml(currentMinistry.organizerPhone) + '">' + escapeHtml(formattedPhone) + '</a>';
    }

    organizerDiv.innerHTML =
      '<div class="organizer-box">' +
        '<div class="organizer-title">Ministry Contact</div>' +
        '<div class="organizer-name">' + escapeHtml(currentMinistry.organizerName) + '</div>' +
        (contactHtml ? '<div class="organizer-contact">' + contactHtml + '</div>' : '') +
      '</div>';
  } else {
    organizerDiv.innerHTML = '';
  }

  var listDiv = document.getElementById('interests-list');
  if (interests.length > 0) {
    listDiv.innerHTML = '<h3 class="section-title" style="font-size: 18px;">Your Interests Today</h3>' +
      interests.map(function(i) {
        var m = MINISTRIES.find(function(min) { return min.id === i.ministryId; });
        return '<div class="ministry-card" style="cursor: default;">' +
          '<div class="ministry-icon">' + (m ? escapeHtml(m.icon) : '&#128203;') + '</div>' +
          '<div class="ministry-info"><h3 class="ministry-name">' + escapeHtml(i.ministryName) + '</h3></div>' +
          '<span class="badge">&#10003;</span></div>';
      }).join('');
  } else {
    listDiv.innerHTML = '';
  }
}

document.getElementById('explore-btn').addEventListener('click', function() {
  currentMinistry = null;
  showMinistriesList();
});

// Parishioner logout (on ministries view)
document.getElementById('logout-btn').addEventListener('click', function() {
  if (confirm('Are you sure you want to log out? Your interest selections on this device will be cleared.')) {
    localStorage.removeItem('ministry-fair-profile');
    localStorage.removeItem('ministry-fair-interests');
    profile = { firstName: '', lastName: '', email: '', phone: '', wantsToJoinParish: false };
    interests = [];
    currentMinistry = null;
    currentSession = null;
    saveSession(null);
    showAll = false;
    searchTerm = '';
    showView('register');
  }
});

// Hash change routing
window.addEventListener('hashchange', function() {
  var hash = window.location.hash;
  if (hash === '#/start' && !appConfig.setupComplete) {
    showView('start');
    showWizardStep(1);
  } else if (hash === '#/settings' && currentSession && getUserRole(currentSession.email) === 'admin') {
    showSettingsView();
  }
});

// ============================================
// BOOT
// ============================================
boot();
</script>

</body>
</html>
