<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ministry Fair</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" async defer></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Crimson Pro', Georgia, serif;
      background: linear-gradient(145deg, #faf8f5 0%, #f5f0e8 100%);
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #8B2635 0%, #6B1D29 100%);
      color: white;
      padding: 24px 20px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(107, 29, 41, 0.3);
    }
    .header h1 {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .header p {
      margin-top: 8px;
      font-size: 15px;
      opacity: 0.9;
    }
    .content {
      padding: 24px 20px;
      max-width: 500px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 28px 24px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    .welcome-text {
      font-size: 17px;
      line-height: 1.7;
      color: #4a4a4a;
      margin-bottom: 24px;
    }
    .form { display: flex; flex-direction: column; gap: 18px; }
    .input-row { display: flex; gap: 12px; }
    .input-group { display: flex; flex-direction: column; gap: 6px; flex: 1; }
    .label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .input, .select {
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid #e8e4de;
      border-radius: 10px;
      outline: none;
      font-family: 'Inter', -apple-system, sans-serif;
      width: 100%;
    }
    .input:focus, .select:focus { border-color: #8B2635; }
    .select { background: white; cursor: pointer; }
    .btn {
      background: linear-gradient(135deg, #8B2635 0%, #6B1D29 100%);
      color: white;
      border: none;
      padding: 16px 24px;
      font-size: 17px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Crimson Pro', Georgia, serif;
      letter-spacing: 0.3px;
      box-shadow: 0 4px 14px rgba(139, 38, 53, 0.35);
      width: 100%;
      margin-top: 8px;
    }
    .btn:disabled { opacity: 0.7; cursor: wait; }
    .btn-secondary {
      background: white;
      color: #8B2635;
      border: 2px solid #8B2635;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Crimson Pro', Georgia, serif;
      width: 100%;
    }
    .btn-green { background: linear-gradient(135deg, #4a9c6d 0%, #3d8259 100%); box-shadow: 0 4px 14px rgba(74, 156, 109, 0.35); }
    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, #f0f7ff 0%, #e8f2ff 100%);
      border-radius: 10px;
      border: 1px solid #d0e3ff;
    }
    .checkbox-group input[type="checkbox"] {
      margin-top: 3px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .checkbox-group label {
      font-size: 14px;
      color: #444;
      line-height: 1.5;
      cursor: pointer;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .consent-text {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      margin-top: 16px;
      margin-bottom: 4px;
      text-align: center;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .google-signin-section {
      text-align: center;
      margin-bottom: 8px;
    }
    .google-signin-section #g_id_signin,
    .google-signin-section #g_id_signin_admin {
      display: flex;
      justify-content: center;
    }
    .divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 13px;
      color: #999;
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      border-top: 1px solid #e8e4de;
    }
    .profile-badge {
      background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .profile-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #8B2635;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .profile-photo {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
    }
    .profile-name { font-size: 17px; font-weight: 600; color: #333; }
    .profile-email { font-size: 13px; color: #666; }
    .profile-phone { font-size: 13px; color: #666; }
    .logout-link {
      background: none;
      border: none;
      color: #8B2635;
      font-size: 13px;
      cursor: pointer;
      padding: 4px 8px;
      font-family: 'Inter', -apple-system, sans-serif;
      text-decoration: underline;
    }
    .logout-link:hover {
      color: #6B1D29;
    }
    .search-box { margin-bottom: 20px; }
    .section-title { font-size: 22px; font-weight: 600; color: #333; margin: 0 0 20px; }
    .ministry-card {
      background: white;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .ministry-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    .ministry-card.interested {
      border-color: #4a9c6d;
      background: linear-gradient(135deg, #f0f9f4 0%, #e8f5ed 100%);
    }
    .ministry-icon {
      font-size: 32px;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #faf8f5;
      border-radius: 12px;
      flex-shrink: 0;
    }
    .ministry-info { flex: 1; }
    .ministry-name { font-size: 18px; font-weight: 600; color: #333; margin: 0; }
    .ministry-desc { font-size: 14px; color: #666; margin: 4px 0 0; line-height: 1.5; }
    .badge {
      background: #4a9c6d;
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 20px;
      font-family: 'Inter', -apple-system, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .success-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4a9c6d 0%, #3d8259 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 24px;
      box-shadow: 0 8px 24px rgba(74, 156, 109, 0.35);
    }
    .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
    .hidden { display: none !important; }
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 16px;
    }
    .checkbox-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: #faf8f5;
      border-radius: 8px;
      cursor: pointer;
    }
    .checkbox-option:hover {
      background: #f0ebe3;
    }
    .checkbox-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .checkbox-option label {
      font-size: 15px;
      color: #333;
      cursor: pointer;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .organizer-box {
      background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      text-align: left;
    }
    .organizer-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-family: 'Inter', -apple-system, sans-serif;
    }
    .organizer-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    .organizer-contact {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }
    .organizer-contact a {
      color: #8B2635;
      text-decoration: none;
    }
    .organizer-contact a:hover {
      text-decoration: underline;
    }
    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 16px;
    }
    .btn-remove {
      background: white;
      color: #c53030;
      border: 2px solid #c53030;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Crimson Pro', Georgia, serif;
      width: 100%;
    }
    .btn-remove:hover {
      background: #fff5f5;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal.hidden {
      display: none !important;
    }
    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      position: relative;
      background: white;
      border-radius: 16px;
      padding: 28px 24px;
      max-width: 340px;
      margin: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      text-align: center;
    }
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
    }
    .modal-text {
      font-size: 15px;
      color: #666;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
    }
    .modal-buttons button {
      flex: 1;
    }

    .role-picker-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
    }
    .role-picker-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border: 2px solid #e8e4de;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.2s, background 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .role-picker-btn:hover {
      border-color: var(--primary);
      background: #faf8f5;
    }
    .role-picker-icon {
      font-size: 24px;
      width: 40px;
      text-align: center;
    }
    .role-picker-label {
      font-size: 15px;
      font-weight: 600;
      color: #333;
    }
    .role-picker-desc {
      font-size: 13px;
      color: #888;
      margin-top: 2px;
    }

    /* ======================================== */
    /* TOP NAVIGATION BAR                       */
    /* ======================================== */
    .top-nav {
      background: white;
      border-bottom: 1px solid #e8e4de;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-brand {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .role-badge {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'Inter', sans-serif;
    }
    .role-badge.role-admin {
      background: #8B2635;
      color: white;
    }
    .role-badge.role-ministry_lead {
      background: #4a9c6d;
      color: white;
    }
    .role-badge.role-parishioner {
      background: #e8e4de;
      color: #666;
    }
    .nav-user-info {
      text-align: right;
      font-family: 'Inter', sans-serif;
    }
    .nav-user-name {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .nav-user-email {
      font-size: 11px;
      color: #888;
    }
    .nav-btn {
      background: none;
      border: 1px solid #e8e4de;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      font-family: 'Inter', sans-serif;
    }
    .nav-btn:hover {
      background: #f5f0e8;
    }

    /* ======================================== */
    /* START WIZARD                             */
    /* ======================================== */
    .wizard-hero {
      text-align: center;
      padding: 48px 20px 24px;
    }
    .wizard-hero-icon {
      font-size: 56px;
      margin-bottom: 16px;
    }
    .wizard-hero-title {
      font-size: 30px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .wizard-hero-sub {
      font-size: 16px;
      color: #666;
      line-height: 1.6;
    }
    .step-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 16px 20px;
    }
    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e8e4de;
      transition: all 0.3s;
    }
    .step-dot.active {
      background: #8B2635;
      transform: scale(1.3);
    }
    .step-dot.done {
      background: #4a9c6d;
    }
    .step-line {
      width: 24px;
      height: 2px;
      background: #e8e4de;
    }
    .step-line.done {
      background: #4a9c6d;
    }
    .wizard-step {
      display: none;
    }
    .wizard-step.active {
      display: block;
    }
    .wizard-nav {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .wizard-nav .btn,
    .wizard-nav .btn-secondary {
      flex: 1;
    }
    .signed-in-as {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, #f0f9f4 0%, #e8f5ed 100%);
      border: 1px solid #b7e4c7;
      border-radius: 12px;
      margin-top: 16px;
    }
    .signed-in-as .profile-icon {
      background: #4a9c6d;
      width: 40px;
      height: 40px;
      font-size: 16px;
    }
    .signed-in-check {
      color: #4a9c6d;
      font-size: 20px;
      font-weight: bold;
      margin-left: auto;
    }
    .color-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .color-swatch {
      aspect-ratio: 1;
      border-radius: 10px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    .color-swatch:hover {
      transform: scale(1.1);
    }
    .color-swatch.selected {
      border-color: #333;
      transform: scale(1.15);
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .header-preview {
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      color: white;
      margin-top: 20px;
      transition: background 0.3s;
    }
    .header-preview h3 {
      font-size: 20px;
      font-weight: 600;
    }
    .header-preview p {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
    }
    .info-box {
      background: #f0f7ff;
      border: 1px solid #d0e3ff;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
    }
    .info-box h4 {
      font-size: 15px;
      font-weight: 600;
      color: #2b6cb0;
      margin-bottom: 12px;
      font-family: 'Inter', sans-serif;
    }
    .info-box ol {
      padding-left: 20px;
      font-size: 14px;
      color: #444;
      line-height: 2;
      font-family: 'Inter', sans-serif;
    }
    .info-box a {
      color: #8B2635;
      font-weight: 500;
    }
    .sheet-preview {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      font-family: 'Inter', sans-serif;
      margin-top: 12px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e8e4de;
    }
    .sheet-preview th {
      background: #f5f0e8;
      padding: 8px 6px;
      text-align: left;
      font-weight: 600;
      color: #555;
      white-space: nowrap;
    }
    .sheet-preview td {
      padding: 7px 6px;
      border-top: 1px solid #f0ebe3;
      color: #666;
      white-space: nowrap;
    }
    .sheet-preview tr:nth-child(even) td {
      background: #faf8f5;
    }
    .sheet-scroll {
      overflow-x: auto;
      margin: 12px 0;
      border-radius: 8px;
    }
    .btn-download {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: white;
      color: #2b6cb0;
      border: 2px solid #d0e3ff;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      width: 100%;
      justify-content: center;
      margin-bottom: 12px;
    }
    .btn-download:hover {
      background: #f0f7ff;
      border-color: #2b6cb0;
    }
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #8B2635;
      color: white;
      font-size: 14px;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      flex-shrink: 0;
    }
    .setup-step {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 16px 0;
      border-bottom: 1px solid #f0ebe3;
    }
    .setup-step:last-child {
      border-bottom: none;
    }
    .setup-step-content {
      flex: 1;
    }
    .setup-step-title {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      font-family: 'Inter', sans-serif;
    }
    .setup-step-desc {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      font-family: 'Inter', sans-serif;
    }
    /* File upload area */
    .upload-area {
      border: 2px dashed #d0d0d0;
      border-radius: 14px;
      padding: 32px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #faf8f5;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: #8B2635;
      background: #fef7f8;
    }
    .upload-area-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    .upload-area-text {
      font-size: 15px;
      color: #555;
      font-family: 'Inter', sans-serif;
    }
    .upload-area-hint {
      font-size: 12px;
      color: #999;
      margin-top: 6px;
      font-family: 'Inter', sans-serif;
    }
    .upload-area input[type="file"] {
      display: none;
    }
    .upload-filename {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: #f0f9f4;
      border: 1px solid #b7e4c7;
      border-radius: 10px;
      margin-top: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      color: #2d6a4f;
    }
    .upload-filename .remove-file {
      margin-left: auto;
      background: none;
      border: none;
      color: #c53030;
      cursor: pointer;
      font-size: 18px;
    }
    /* AI analysis states */
    .analysis-progress {
      text-align: center;
      padding: 24px;
    }
    .analysis-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #e8e4de;
      border-top-color: #8B2635;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .analysis-status-text {
      font-size: 14px;
      color: #666;
      font-family: 'Inter', sans-serif;
    }
    /* Mapping results */
    .mapping-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      margin: 12px 0;
    }
    .mapping-table th {
      text-align: left;
      padding: 10px 8px;
      background: #f5f0e8;
      font-weight: 600;
      color: #555;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .mapping-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f0ebe3;
      color: #333;
    }
    .mapping-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .mapping-status.mapped {
      background: #f0f9f4;
      color: #2d6a4f;
    }
    .mapping-status.missing {
      background: #fff5f5;
      color: #c53030;
    }
    .mapping-status.optional {
      background: #fefce8;
      color: #92400e;
    }
    .mapping-summary {
      padding: 16px;
      border-radius: 10px;
      margin: 16px 0;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    .mapping-summary.good {
      background: #f0f9f4;
      border: 1px solid #b7e4c7;
      color: #2d6a4f;
    }
    .mapping-summary.warn {
      background: #fefce8;
      border: 1px solid #fde68a;
      color: #92400e;
    }
    .mapping-summary h4 {
      font-size: 15px;
      margin-bottom: 6px;
    }
    .mapping-summary ul {
      margin-top: 8px;
      padding-left: 18px;
      line-height: 1.8;
    }
    .data-preview-scroll {
      overflow-x: auto;
      margin: 12px 0;
      border-radius: 8px;
    }
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      margin-top: 12px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
    }
    .connection-status.success {
      background: #f0f9f4;
      color: #2d6a4f;
      border: 1px solid #b7e4c7;
    }
    .connection-status.error {
      background: #fff5f5;
      color: #c53030;
      border: 1px solid #feb2b2;
    }
    .connection-status.testing {
      background: #f0f7ff;
      color: #2b6cb0;
      border: 1px solid #bee3f8;
    }
    .sheet-tab-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border: 2px solid #e8e4de;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      margin-bottom: 8px;
      transition: border-color 0.2s, background 0.2s;
      width: 100%;
      text-align: left;
    }
    .sheet-tab-btn:hover {
      border-color: var(--primary);
      background: #faf8f5;
    }
    .sheet-tab-btn.selected {
      border-color: var(--primary);
      background: #fdf2f3;
    }
    .sheet-tab-btn .tab-name {
      font-weight: 600;
      color: #333;
    }
    .sheet-tab-btn .tab-meta {
      font-size: 12px;
      color: #888;
    }
    .sheet-tab-btn .tab-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 8px;
      background: #f0f9f4;
      color: #2d6a4f;
      font-weight: 600;
    }
    .admin-list {
      margin-top: 16px;
    }
    .admin-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: #faf8f5;
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .admin-item .profile-icon {
      width: 36px;
      height: 36px;
      font-size: 14px;
    }
    .admin-item-details { flex: 1; }
    .admin-item-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    .admin-item-email {
      font-size: 12px;
      color: #666;
    }
    .admin-item-tag {
      font-size: 10px;
      font-weight: 700;
      color: #8B2635;
      text-transform: uppercase;
      font-family: 'Inter', sans-serif;
    }
    .admin-remove-btn {
      background: none;
      border: none;
      color: #c53030;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
    }
    .add-admin-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .add-admin-row .input { flex: 1; }
    .btn-sm {
      background: #8B2635;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }
    .summary-list {
      margin-top: 16px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid #f0ebe3;
    }
    .summary-row:last-child { border-bottom: none; }
    .summary-label {
      font-size: 13px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'Inter', sans-serif;
    }
    .summary-value {
      font-size: 15px;
      color: #333;
      font-weight: 500;
      text-align: right;
      max-width: 60%;
      word-break: break-all;
    }
    .launch-area {
      text-align: center;
      margin-top: 32px;
    }
    .launch-area .success-icon {
      width: 64px;
      height: 64px;
      font-size: 32px;
    }

    /* ======================================== */
    /* SETTINGS                                 */
    /* ======================================== */
    .settings-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      color: #8B2635;
      cursor: pointer;
      font-size: 15px;
      font-family: 'Crimson Pro', Georgia, serif;
      padding: 0;
      margin-bottom: 20px;
    }
    .settings-section {
      margin-bottom: 28px;
    }
    .settings-section-title {
      font-size: 12px;
      font-weight: 700;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      font-family: 'Inter', sans-serif;
    }
    .settings-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #f5f0e8;
      cursor: pointer;
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-item:hover { background: #faf8f5; }
    .settings-item-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .settings-item-label {
      font-size: 15px;
      color: #333;
    }
    .settings-item-desc {
      font-size: 12px;
      color: #999;
      font-family: 'Inter', sans-serif;
    }
    .settings-item-value {
      font-size: 14px;
      color: #888;
      font-family: 'Inter', sans-serif;
    }
    .settings-item-arrow {
      color: #ccc;
      margin-left: 8px;
    }
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
      flex-shrink: 0;
    }
    .toggle-switch.on {
      background: #4a9c6d;
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch.on::after {
      transform: translateX(20px);
    }
    .template-card {
      background: #faf8f5;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 10px;
    }
    .template-card h4 {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      font-family: 'Inter', sans-serif;
    }
    .template-card p {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      font-family: 'Inter', sans-serif;
    }
    .template-card textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      border: 1px solid #e8e4de;
      border-radius: 8px;
      margin-top: 8px;
      resize: vertical;
      outline: none;
    }
    .template-card textarea:focus {
      border-color: #8B2635;
    }

    /* ======================================== */
    /* THEME TOGGLE                             */
    /* ======================================== */
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: white;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      z-index: 999;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .theme-toggle:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }

    /* ======================================== */
    /* DOMAIN DETECTION                         */
    /* ======================================== */
    .detection-card {
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
      text-align: center;
    }
    .detection-card.detecting {
      background: linear-gradient(135deg, #f0f7ff 0%, #e8f2ff 100%);
      border: 1px solid #d0e3ff;
    }
    .detection-card.found {
      background: linear-gradient(135deg, #f0f9f4 0%, #e8f5ed 100%);
      border: 1px solid #b7e4c7;
    }
    .detection-card.not-found {
      background: #faf8f5;
      border: 1px solid #e8e4de;
    }
    .detection-icon {
      font-size: 36px;
      margin-bottom: 10px;
    }
    .detection-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }
    .detection-detail {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
      font-family: 'Inter', sans-serif;
    }
    .detection-org-name {
      font-size: 20px;
      font-weight: 600;
      color: #2d6a4f;
      margin: 8px 0 4px;
    }
    .detection-meta {
      font-size: 13px;
      color: #888;
      font-family: 'Inter', sans-serif;
    }
    .detection-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .detection-actions button { flex: 1; }
    .detection-spinner-sm {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid #bee3f8;
      border-top-color: #2b6cb0;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    /* Dark mode overrides for detection */
    body.dark .detection-card.detecting {
      background: linear-gradient(135deg, #1a2030 0%, #1a2535 100%);
      border-color: #2a3a50;
    }
    body.dark .detection-card.found {
      background: linear-gradient(135deg, #1a2a20 0%, #1e2e24 100%);
      border-color: #2a5a3a;
    }
    body.dark .detection-card.not-found {
      background: #1e1e1e;
      border-color: #3a3a3a;
    }
    body.dark .detection-title { color: #e0e0e0; }
    body.dark .detection-detail { color: #a0a0a0; }
    body.dark .detection-org-name { color: #6fbc8f; }
    body.dark .detection-meta { color: #707070; }
    body.dark .detection-spinner-sm {
      border-color: #2a3a50;
      border-top-color: #7db3e0;
    }

    /* ======================================== */
    /* DARK MODE                                */
    /* ======================================== */
    body.dark {
      background: linear-gradient(145deg, #141414 0%, #1a1a1a 100%);
      color: #e0e0e0;
    }
    body.dark .theme-toggle {
      background: #2a2a2a;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
    }

    /* Header - keep gradient from config, just soften the shadow */
    body.dark .header {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    /* Cards */
    body.dark .card {
      background: #242424;
      box-shadow: 0 2px 16px rgba(0,0,0,0.3);
    }

    /* Text colors */
    body.dark .welcome-text { color: #b0b0b0; }
    body.dark .section-title { color: #e8e8e8; }
    body.dark .label { color: #d0d0d0; }
    body.dark .consent-text { color: #808080; }
    body.dark .divider { color: #606060; }
    body.dark .divider::before,
    body.dark .divider::after { border-top-color: #3a3a3a; }

    /* Inputs */
    body.dark .input,
    body.dark .select {
      background: #1a1a1a;
      border-color: #3a3a3a;
      color: #e8e8e8;
    }
    body.dark .input::placeholder { color: #606060; }
    body.dark .input:focus,
    body.dark .select:focus { border-color: #8B2635; }
    body.dark .select option { background: #242424; color: #e8e8e8; }

    /* Buttons */
    body.dark .btn-secondary {
      background: #242424;
      border-color: #8B2635;
      color: #e0a0a8;
    }
    body.dark .btn-remove {
      background: #242424;
      color: #f87171;
      border-color: #f87171;
    }
    body.dark .btn-remove:hover { background: #2a1a1a; }
    body.dark .btn:disabled { opacity: 0.5; }

    /* Profile badge */
    body.dark .profile-badge {
      background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);
    }
    body.dark .profile-name { color: #e8e8e8; }
    body.dark .profile-email,
    body.dark .profile-phone { color: #909090; }
    body.dark .logout-link { color: #e0a0a8; }
    body.dark .logout-link:hover { color: #f0c0c8; }

    /* Checkbox group */
    body.dark .checkbox-group {
      background: linear-gradient(135deg, #1a2030 0%, #1a2535 100%);
      border-color: #2a3a50;
    }
    body.dark .checkbox-group label { color: #b0b0b0; }

    /* Ministry cards */
    body.dark .ministry-card {
      background: #242424;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
    }
    body.dark .ministry-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }
    body.dark .ministry-card.interested {
      border-color: #4a9c6d;
      background: linear-gradient(135deg, #1a2a20 0%, #1e2e24 100%);
    }
    body.dark .ministry-icon {
      background: #1e1e1e;
    }
    body.dark .ministry-name { color: #e8e8e8; }
    body.dark .ministry-desc { color: #909090; }

    /* Search */
    body.dark .no-results { color: #808080; }

    /* Detail view */
    body.dark .checkbox-option {
      background: #1e1e1e;
    }
    body.dark .checkbox-option:hover { background: #2a2a2a; }
    body.dark .checkbox-option label { color: #d0d0d0; }

    /* Organizer box */
    body.dark .organizer-box {
      background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);
    }
    body.dark .organizer-title { color: #d0d0d0; }
    body.dark .organizer-name { color: #e8e8e8; }
    body.dark .organizer-contact { color: #909090; }
    body.dark .organizer-contact a { color: #e0a0a8; }

    /* Modal */
    body.dark .modal-backdrop { background: rgba(0, 0, 0, 0.7); }
    body.dark .modal-content {
      background: #2a2a2a;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    body.dark .modal-title { color: #e8e8e8; }
    body.dark .modal-text { color: #a0a0a0; }

    /* Loading */
    body.dark .loading { color: #808080; }

    /* Top nav */
    body.dark .top-nav {
      background: #1e1e1e;
      border-bottom-color: #333333;
    }
    body.dark .nav-brand { color: #e8e8e8; }
    body.dark .nav-user-name { color: #e0e0e0; }
    body.dark .nav-user-email { color: #808080; }
    body.dark .nav-btn {
      border-color: #3a3a3a;
      color: #a0a0a0;
    }
    body.dark .nav-btn:hover { background: #2a2a2a; }

    /* Start wizard */
    body.dark .wizard-hero-title { color: #e8e8e8; }
    body.dark .wizard-hero-sub { color: #909090; }
    body.dark .step-dot { background: #3a3a3a; }
    body.dark .step-line { background: #3a3a3a; }
    body.dark .signed-in-as {
      background: linear-gradient(135deg, #1a2a20 0%, #1e2e24 100%);
      border-color: #2a5a3a;
    }

    /* Color grid */
    body.dark .header-preview { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

    /* Info box */
    body.dark .info-box {
      background: #1a2030;
      border-color: #2a3a50;
    }
    body.dark .info-box h4 { color: #7db3e0; }
    body.dark .info-box ol { color: #b0b0b0; }

    /* Upload area */
    body.dark .upload-area {
      background: #1e1e1e;
      border-color: #3a3a3a;
    }
    body.dark .upload-area:hover,
    body.dark .upload-area.dragover {
      border-color: #8B2635;
      background: #2a1a1a;
    }
    body.dark .upload-area-text { color: #b0b0b0; }
    body.dark .upload-area-hint { color: #606060; }
    body.dark .upload-filename {
      background: #1a2a20;
      border-color: #2a5a3a;
      color: #6fbc8f;
    }

    /* Analysis */
    body.dark .analysis-spinner {
      border-color: #3a3a3a;
      border-top-color: #8B2635;
    }
    body.dark .analysis-status-text { color: #909090; }

    /* Mapping table */
    body.dark .mapping-table th {
      background: #1e1e1e;
      color: #a0a0a0;
    }
    body.dark .mapping-table td {
      border-bottom-color: #333333;
      color: #d0d0d0;
    }
    body.dark .mapping-status.mapped { background: #1a2a20; color: #6fbc8f; }
    body.dark .mapping-status.missing { background: #2a1a1a; color: #f87171; }
    body.dark .mapping-status.optional { background: #2a2510; color: #d4a020; }
    body.dark .mapping-summary.good {
      background: #1a2a20;
      border-color: #2a5a3a;
      color: #6fbc8f;
    }
    body.dark .mapping-summary.warn {
      background: #2a2510;
      border-color: #5a4a1a;
      color: #d4a020;
    }
    body.dark .btn-download {
      background: #242424;
      color: #7db3e0;
      border-color: #2a3a50;
    }
    body.dark .btn-download:hover {
      background: #1a2030;
      border-color: #7db3e0;
    }

    /* Sheet preview */
    body.dark .sheet-preview {
      border-color: #3a3a3a;
    }
    body.dark .sheet-preview th {
      background: #1e1e1e;
      color: #a0a0a0;
    }
    body.dark .sheet-preview td {
      border-top-color: #333333;
      color: #909090;
    }
    body.dark .sheet-preview tr:nth-child(even) td {
      background: #1e1e1e;
    }

    /* Connection status */
    body.dark .connection-status.success {
      background: #1a2a20;
      border-color: #2a5a3a;
      color: #6fbc8f;
    }
    body.dark .connection-status.error {
      background: #2a1a1a;
      border-color: #5a2a2a;
      color: #f87171;
    }
    body.dark .connection-status.testing {
      background: #1a2030;
      border-color: #2a3a50;
      color: #7db3e0;
    }

    /* Setup steps */
    body.dark .setup-step { border-bottom-color: #333333; }
    body.dark .setup-step-title { color: #e0e0e0; }
    body.dark .setup-step-desc { color: #909090; }

    /* Admin list */
    body.dark .admin-item { background: #1e1e1e; }
    body.dark .admin-item-name { color: #e0e0e0; }
    body.dark .admin-item-email { color: #808080; }
    body.dark .admin-item-tag { color: #e0a0a8; }
    body.dark .btn-sm { background: #8B2635; }

    /* Summary */
    body.dark .summary-row { border-bottom-color: #333333; }
    body.dark .summary-label { color: #707070; }
    body.dark .summary-value { color: #e0e0e0; }

    /* Settings */
    body.dark .settings-back { color: #e0a0a8; }
    body.dark .settings-section-title { color: #707070; }
    body.dark .settings-card {
      background: #242424;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
    }
    body.dark .settings-item {
      border-bottom-color: #333333;
    }
    body.dark .settings-item:hover { background: #2a2a2a; }
    body.dark .settings-item-label { color: #e0e0e0; }
    body.dark .settings-item-desc { color: #707070; }
    body.dark .settings-item-value { color: #909090; }
    body.dark .settings-item-arrow { color: #505050; }
    body.dark .toggle-switch { background: #3a3a3a; }

    /* Template cards */
    body.dark .template-card {
      background: #1e1e1e;
    }
    body.dark .template-card h4 { color: #e0e0e0; }
    body.dark .template-card p { color: #909090; }
    body.dark .template-card textarea {
      background: #1a1a1a;
      border-color: #3a3a3a;
      color: #e0e0e0;
    }
    body.dark .template-card textarea:focus { border-color: #8B2635; }

    /* Success icon in confirmed view */
    body.dark .success-icon {
      box-shadow: 0 8px 24px rgba(74, 156, 109, 0.2);
    }

    /* ======================================== */
    /* ADMIN DASHBOARD                          */
    /* ======================================== */
    .admin-tabs {
      display: flex;
      border-bottom: 2px solid #e8e4de;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    .admin-tab {
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #888;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
      margin-bottom: -2px;
    }
    .admin-tab.active {
      color: #8B2635;
      border-bottom-color: #8B2635;
    }
    .admin-tab:hover { color: #333; }
    .admin-table-wrap { overflow-x: auto; margin: 12px 0; }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      min-width: 600px;
    }
    .admin-table th {
      text-align: left;
      padding: 10px 8px;
      background: #f5f0e8;
      font-weight: 600;
      color: #555;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
    }
    .admin-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f0ebe3;
      color: #333;
    }
    .admin-table tr:hover td { background: #faf8f5; }
    .admin-toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .admin-toolbar .input {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      font-size: 14px;
    }
    .enrich-item {
      border: 1px solid #e8e4de;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      background: white;
    }
    .enrich-item-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .enrich-item-header input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    .enrich-item-name {
      font-weight: 600;
      font-size: 15px;
      color: #333;
    }
    .enrich-item-match {
      font-size: 12px;
      color: #2d6a4f;
      background: #f0f9f4;
      padding: 2px 8px;
      border-radius: 6px;
    }
    .enrich-item-new {
      font-size: 12px;
      color: #c53030;
      background: #fff5f5;
      padding: 2px 8px;
      border-radius: 6px;
    }
    .enrich-field {
      font-size: 13px;
      color: #555;
      padding: 4px 0;
      line-height: 1.5;
    }
    .enrich-field-label {
      font-weight: 600;
      color: #333;
      margin-right: 4px;
    }
    .enrich-field-new {
      background: #f0f9f4;
      padding: 1px 4px;
      border-radius: 3px;
    }
    .btn-export {
      background: white;
      color: #1a5276;
      border: 2px solid #d0e3ff;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }
    .btn-export:hover { background: #f0f7ff; border-color: #1a5276; }
    .admin-stat {
      font-size: 13px;
      color: #888;
      font-family: 'Inter', sans-serif;
    }
    .admin-empty {
      text-align: center;
      padding: 40px 20px;
      color: #888;
      font-size: 15px;
    }
    .ministry-form-grid {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .ministry-form-row {
      display: flex;
      gap: 10px;
    }
    .ministry-form-row .input-group { flex: 1; }
    .admin-ministry-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .admin-ministry-card .ministry-icon {
      width: 40px;
      height: 40px;
      font-size: 24px;
      border-radius: 8px;
    }
    .admin-ministry-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      background: none;
      border: 1px solid #e8e4de;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
      color: #666;
    }
    .btn-icon:hover { background: #faf8f5; }
    .btn-icon.danger { color: #c53030; border-color: #feb2b2; }
    .btn-icon.danger:hover { background: #fff5f5; }

    /* Dark mode for admin dashboard */
    body.dark .admin-tabs { border-bottom-color: #3a3a3a; }
    body.dark .admin-tab { color: #808080; }
    body.dark .admin-tab.active { color: #e0a0a8; border-bottom-color: #8B2635; }
    body.dark .admin-tab:hover { color: #e0e0e0; }
    body.dark .admin-table th { background: #1e1e1e; color: #a0a0a0; }
    body.dark .admin-table td { border-bottom-color: #333; color: #d0d0d0; }
    body.dark .admin-table tr:hover td { background: #2a2a2a; }
    body.dark .btn-export { background: #242424; color: #7db3e0; border-color: #2a3a50; }
    body.dark .btn-export:hover { background: #1a2030; }
    body.dark .admin-ministry-card { background: #242424; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    body.dark .btn-icon { border-color: #3a3a3a; color: #a0a0a0; }
    body.dark .btn-icon:hover { background: #2a2a2a; }
    body.dark .btn-icon.danger { color: #f87171; border-color: #5a2a2a; }

    /* ======================================== */
    /* QR CODE GENERATION                       */
    /* ======================================== */
    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .qr-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .qr-card canvas { max-width: 160px; margin: 0 auto; }
    .qr-card-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-top: 10px;
      font-family: 'Inter', sans-serif;
    }
    .qr-card-url {
      font-size: 11px;
      color: #888;
      word-break: break-all;
      margin-top: 4px;
      font-family: 'Inter', sans-serif;
    }
    .btn-print {
      background: white;
      color: #333;
      border: 2px solid #e8e4de;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
    }
    .btn-print:hover { background: #faf8f5; border-color: #333; }
    body.dark .qr-card { background: #242424; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    body.dark .qr-card-name { color: #e0e0e0; }
    body.dark .btn-print { background: #242424; color: #e0e0e0; border-color: #3a3a3a; }

    /* Print styles for QR codes */
    @media print {
      body * { visibility: hidden; }
      #view-qr, #view-qr * { visibility: visible; }
      #view-qr { position: absolute; left: 0; top: 0; width: 100%; }
      .qr-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
      .qr-card { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; }
      .top-nav, .theme-toggle, .btn-print, .admin-toolbar { display: none !important; }
    }

    /* ======================================== */
    /* MY SIGNUPS VIEW                          */
    /* ======================================== */
    .signup-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .signup-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .signup-card-ministry {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    .signup-card-date {
      font-size: 12px;
      color: #888;
      font-family: 'Inter', sans-serif;
    }
    .signup-card-status {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: auto;
    }
    .signup-card-status.active { background: #f0f9f4; color: #2d6a4f; }
    .signup-card-status.removed { background: #fff5f5; color: #c53030; }
    body.dark .signup-card { background: #242424; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    body.dark .signup-card-ministry { color: #e0e0e0; }
    body.dark .signup-card-status.active { background: #1a2a20; color: #6fbc8f; }
    body.dark .signup-card-status.removed { background: #2a1a1a; color: #f87171; }

    /* ======================================== */
    /* MINISTRY EDIT MODAL                      */
    /* ======================================== */
    .edit-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 1001;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 60px;
      overflow-y: auto;
    }
    .edit-modal.hidden { display: none !important; }
    .edit-modal-content {
      position: relative;
      background: white;
      border-radius: 16px;
      padding: 28px 24px;
      max-width: 500px;
      width: 90%;
      margin: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .edit-modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
    }
    .edit-modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .edit-modal-actions button { flex: 1; }
    body.dark .edit-modal-content { background: #2a2a2a; }
    body.dark .edit-modal-title { color: #e0e0e0; }

    /* ======================================== */
    /* MANUAL ENTRY TAB                         */
    /* ======================================== */
    .manual-entry-modes {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border: 1px solid #e8e4de;
      border-radius: 10px;
      overflow: hidden;
      max-width: 320px;
    }
    .mode-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: white;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
    }
    .mode-btn.active {
      background: #8B2635;
      color: white;
    }
    .manual-entry-form {
      max-width: 500px;
    }
    .manual-entry-form .form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .manual-entry-form .input-row {
      display: flex;
      gap: 12px;
    }
    .manual-entry-success {
      background: #f0f9f4;
      border: 1px solid #b7e4c7;
      border-radius: 10px;
      padding: 16px;
      color: #2d6a4f;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      margin-bottom: 16px;
      display: none;
    }
    .manual-entry-success.visible { display: block; }
    .review-container {
      margin-top: 20px;
    }
    .review-container h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      font-family: 'Inter', sans-serif;
    }
    .review-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      align-items: center;
    }
    .review-count {
      font-size: 14px;
      color: #666;
      font-family: 'Inter', sans-serif;
    }
    .review-row-remove {
      background: none;
      border: none;
      color: #c53030;
      cursor: pointer;
      font-size: 16px;
      padding: 2px 6px;
    }
    .admin-table td input, .admin-table td select {
      border: 1px solid #e8e4de;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      width: 100%;
      box-sizing: border-box;
    }
    body.dark .mode-btn { background: #1e1e1e; color: #909090; border-color: #3a3a3a; }
    body.dark .mode-btn.active { background: #8B2635; color: white; }
    body.dark .admin-table td input, body.dark .admin-table td select {
      background: #2a2a2a; color: #e0e0e0; border-color: #3a3a3a;
    }

    /* ======================================== */
    /* FOLLOW-UP QUESTIONNAIRE                  */
    /* ======================================== */
    .followup-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .followup-header h2 {
      font-size: 22px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .followup-header p {
      font-size: 15px;
      color: #666;
      line-height: 1.5;
    }
    .followup-success {
      text-align: center;
      padding: 32px 20px;
    }
    .followup-success .success-icon {
      margin-bottom: 20px;
    }
    .followup-link-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f5f0e8;
      border-radius: 10px;
      padding: 12px 16px;
      margin-top: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      word-break: break-all;
    }
    .followup-link-box input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      color: #333;
      outline: none;
    }
    .btn-copy {
      background: white;
      border: 1px solid #e8e4de;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }
    .btn-copy:hover { background: #faf8f5; }
    .followup-editor-questions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 16px 0;
    }
    .followup-q-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 12px;
      background: #faf8f5;
      border-radius: 10px;
    }
    .followup-q-row .input-group { flex: 1; }
    .followup-q-row .input { font-size: 14px; padding: 10px 12px; }
    .followup-q-num {
      font-size: 12px;
      font-weight: 700;
      color: #888;
      padding-top: 10px;
      font-family: 'Inter', sans-serif;
    }
    .btn-remove-q {
      background: none;
      border: none;
      color: #c53030;
      cursor: pointer;
      font-size: 18px;
      padding: 8px;
    }
    .btn-add-q {
      background: white;
      border: 2px dashed #d0d0d0;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      color: #666;
    }
    .btn-add-q:hover { border-color: #8B2635; color: #8B2635; }
    .admin-ministry-card .btn-followup {
      background: none;
      border: 1px solid #1a5276;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      color: #1a5276;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
    }
    .admin-ministry-card .btn-followup:hover { background: #f0f7ff; }
    .followup-round {
      border: 1px solid #e8e4de;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .followup-round-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .followup-round-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      font-family: 'Inter', sans-serif;
    }
    .followup-round-link {
      font-size: 11px;
      color: #1a5276;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
    }
    .followup-round-link:hover { text-decoration: underline; }
    .btn-add-round {
      background: white;
      border: 2px dashed #d0d0d0;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      color: #666;
      width: 100%;
    }
    .btn-add-round:hover { border-color: #8B2635; color: #8B2635; }
    body.dark .followup-round { border-color: #3a3a3a; }
    body.dark .followup-round-title { color: #e0e0e0; }
    body.dark .followup-header h2 { color: #e0e0e0; }
    body.dark .followup-header p { color: #909090; }
    body.dark .followup-link-box { background: #2a2a2a; }
    body.dark .followup-link-box input { color: #e0e0e0; }
    body.dark .followup-q-row { background: #2a2a2a; }
    body.dark .btn-add-q { background: #1e1e1e; border-color: #3a3a3a; color: #909090; }
  </style>
</head>
<body>
<script>
  // Apply theme before first paint to prevent flash
  if ((localStorage.getItem('mf-theme') || 'light') === 'dark') document.body.classList.add('dark');
</script>

<!-- THEME TOGGLE -->
<button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode">&#9790;</button>

<!-- TOP NAVIGATION BAR -->
<nav id="top-nav" class="top-nav hidden">
  <div class="nav-brand" id="nav-brand-text" style="cursor:pointer;" title="Home">Ministry Fair</div>
  <div class="nav-right">
    <span class="role-badge" id="nav-role-badge"></span>
    <div class="nav-user-info">
      <div class="nav-user-name" id="nav-user-name"></div>
      <div class="nav-user-email" id="nav-user-email"></div>
    </div>
    <button class="nav-btn" id="nav-dashboard-btn" title="Admin Dashboard">&#128202;</button>
    <button class="nav-btn" id="nav-my-signups-btn" title="My Signups">&#128203;</button>
    <button class="nav-btn" id="nav-settings-btn" title="Settings">&#9881;</button>
    <button class="nav-btn" id="nav-logout-btn" title="Log out">&#10140;</button>
  </div>
</nav>

<!-- LOADING VIEW -->
<div id="view-loading">
  <header class="header">
    <h1 class="app-title"></h1>
    <p class="app-tagline"></p>
  </header>
  <div class="content">
    <div class="card">
      <div class="loading">Loading ministries...</div>
    </div>
  </div>
</div>

<!-- ======================================== -->
<!-- START WIZARD VIEW                        -->
<!-- ======================================== -->
<div id="view-start" class="hidden">
  <div class="wizard-hero">
    <div class="wizard-hero-icon">&#9962;</div>
    <h1 class="wizard-hero-title">Set Up Your Ministry Fair</h1>
    <p class="wizard-hero-sub">Let's get your parish ministry fair up and running.<br>This will only take a few minutes.</p>
  </div>

  <div class="step-indicator" id="step-indicator">
    <div class="step-dot active" data-step="1"></div>
    <div class="step-line" data-after="1"></div>
    <div class="step-dot" data-step="2"></div>
    <div class="step-line" data-after="2"></div>
    <div class="step-dot" data-step="3"></div>
    <div class="step-line" data-after="3"></div>
    <div class="step-dot" data-step="4"></div>
    <div class="step-line" data-after="4"></div>
    <div class="step-dot" data-step="5"></div>
  </div>

  <div class="content">
    <!-- STEP 1: Sign In -->
    <div class="wizard-step active" data-wizard-step="1">
      <div class="card">
        <h2 class="section-title">Sign In as Administrator</h2>
        <p class="welcome-text">
          Sign in with your Google account. You'll be the first administrator and can add others later.
        </p>
        <div class="google-signin-section">
          <div id="g_id_signin_admin"></div>
        </div>
        <div id="admin-signed-in" class="hidden">
          <div class="signed-in-as">
            <div class="profile-icon" id="admin-setup-initials"></div>
            <div>
              <div class="profile-name" id="admin-setup-name"></div>
              <div class="profile-email" id="admin-setup-email"></div>
            </div>
            <div class="signed-in-check">&#10003;</div>
          </div>
          <!-- Domain detection results -->
          <div id="domain-detection" class="hidden"></div>
        </div>
        <div class="form" style="margin-top: 24px;">
          <div class="input-group">
            <label class="label">Claude API Key</label>
            <input type="password" class="input" id="setup-api-key" placeholder="sk-ant-api03-...">
            <p style="font-size: 12px; color: #888; margin-top: 4px; font-family: 'Inter', sans-serif;">
              Used to intelligently read your spreadsheet and power notifications.
              Get one at <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #8B2635;">console.anthropic.com</a>
            </p>
          </div>
        </div>
        <div class="wizard-nav">
          <button class="btn" id="step1-next" disabled>Next &rarr;</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: Organization Details -->
    <div class="wizard-step" data-wizard-step="2">
      <div class="card">
        <h2 class="section-title">Your Organization</h2>
        <p class="welcome-text">Tell us about your parish or organization.</p>
        <div class="form">
          <div class="input-group">
            <label class="label">Organization Name</label>
            <input type="text" class="input" id="setup-org-name" placeholder="St. Theresa Catholic Church">
          </div>
          <div class="input-group">
            <label class="label">App Title</label>
            <input type="text" class="input" id="setup-app-title" value="Ministry Fair">
          </div>
          <div class="input-group">
            <label class="label">Tagline</label>
            <input type="text" class="input" id="setup-tagline" value="Find your place to serve">
          </div>
          <div class="input-group">
            <label class="label">Theme Color</label>
            <div class="color-grid" id="color-grid"></div>
          </div>
          <div class="header-preview" id="header-preview">
            <h3 id="preview-title">Ministry Fair</h3>
            <p id="preview-tagline">Find your place to serve</p>
          </div>
        </div>
        <div class="wizard-nav">
          <button class="btn-secondary" id="step2-back">&larr; Back</button>
          <button class="btn" id="step2-next">Next &rarr;</button>
        </div>
      </div>
    </div>

    <!-- STEP 3: Upload & Analyze Spreadsheet -->
    <div class="wizard-step" data-wizard-step="3">
      <div class="card">
        <h2 class="section-title">Upload Your Ministry List</h2>
        <p class="welcome-text">
          Upload a spreadsheet with your ministries. It doesn't need to be in any special format &mdash; we'll use AI to read it and figure out what's what.
        </p>

        <!-- Upload area -->
        <div id="upload-area" class="upload-area">
          <div class="upload-area-icon">&#128203;</div>
          <div class="upload-area-text">Drop your file here, or click to browse</div>
          <div class="upload-area-hint">CSV, Excel, or any spreadsheet format</div>
          <input type="file" id="file-input" accept=".csv,.tsv,.xlsx,.xls,.txt">
        </div>
        <div id="upload-filename" class="upload-filename hidden">
          <span>&#128196;</span>
          <span id="filename-text"></span>
          <button class="remove-file" id="remove-file-btn">&times;</button>
        </div>

        <!-- AI analysis area (hidden until file uploaded) -->
        <div id="analysis-section" class="hidden">
          <!-- Progress spinner -->
          <div id="analysis-progress" class="analysis-progress hidden">
            <div class="analysis-spinner"></div>
            <div class="analysis-status-text">Reading your spreadsheet with AI...</div>
          </div>

          <!-- Mapping results -->
          <div id="mapping-results" class="hidden">
            <div id="mapping-summary-box"></div>
            <table class="mapping-table" id="mapping-table">
              <thead>
                <tr>
                  <th>Our Field</th>
                  <th>Your Column</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="mapping-table-body"></tbody>
            </table>

            <div id="mapping-suggestions"></div>

            <p style="font-size: 14px; font-weight: 600; color: #333; margin-top: 20px; font-family: 'Inter', sans-serif;">
              Preview (first 3 rows):
            </p>
            <div class="data-preview-scroll">
              <table class="sheet-preview" id="data-preview-table"></table>
            </div>

            <button class="btn-download" id="download-formatted-btn" style="margin-top: 16px;">&#128196; Download Formatted Sheet (.csv)</button>
          </div>
        </div>

        <!-- Connect section -->
        <div style="margin-top: 24px;">
          <div style="background: #fff8e1; border: 1px solid #ffe082; border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">&#128187;</span>
            <div style="font-size: 13px; color: #5d4037; font-family: 'Inter', sans-serif;">
              <strong>Best done on a desktop or laptop.</strong> The next steps involve Google Sheets and Apps Script, which are much easier to work with on a full-size screen.
            </div>
          </div>

          <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 12px; font-family: 'Crimson Pro', serif;">Connect to Google Sheets</h3>
          <p style="font-size: 13px; color: #666; margin-bottom: 16px; font-family: 'Inter', sans-serif;">
            This app uses a Google Sheet as its database. You'll set up a Sheet and add a small script that lets the app read and write data. Don't worry &mdash; we'll walk you through it.
          </p>

          <div class="setup-step">
            <span class="step-number">1</span>
            <div class="setup-step-content">
              <div class="setup-step-title">Create or open a Google Sheet</div>
              <div class="setup-step-desc">Go to <a href="https://sheets.new" target="_blank" style="color: #8B2635; font-weight: 600;">sheets.new</a> to create a blank sheet, or open an existing one that has your ministry data. If you downloaded the formatted file above, you can import it via <strong>File &rarr; Import</strong>.</div>
            </div>
          </div>
          <div class="setup-step">
            <span class="step-number">2</span>
            <div class="setup-step-content">
              <div class="setup-step-title">Add the backend script</div>
              <div class="setup-step-desc">In your Google Sheet, click <strong>Extensions &rarr; Apps Script</strong>. This opens a code editor. We need to paste a small script there.</div>
            </div>
          </div>
          <div class="setup-step">
            <span class="step-number">3</span>
            <div class="setup-step-content">
              <div class="setup-step-title">Deploy it as a Web App</div>
              <div class="setup-step-desc">After pasting the script, you'll deploy it so this app can talk to your Sheet. You'll get a URL to paste below.</div>
            </div>
          </div>

          <!-- Expandable detailed help -->
          <details style="margin-top: 16px; border: 1px solid #e8e4de; border-radius: 10px; overflow: hidden;">
            <summary style="padding: 12px 16px; cursor: pointer; font-size: 14px; font-weight: 600; color: #8B2635; font-family: 'Inter', sans-serif; background: #fdf8f8; user-select: none;">
              &#9432; Show me detailed step-by-step instructions
            </summary>
            <div style="padding: 16px; font-size: 13px; line-height: 1.8; color: #444; font-family: 'Inter', sans-serif;">
              <h4 style="font-size: 14px; color: #333; margin: 0 0 8px 0;">Step 1: Create your Google Sheet</h4>
              <ol style="margin: 0 0 16px 20px; padding: 0;">
                <li>Go to <a href="https://sheets.new" target="_blank" style="color: #8B2635;">sheets.new</a> &mdash; this creates a brand-new spreadsheet.</li>
                <li>Give it a name like <strong>"Ministry Fair Data"</strong> (click "Untitled spreadsheet" at the top left).</li>
                <li><strong>If you have existing ministry data:</strong> You can paste it into Sheet1, or use <strong>File &rarr; Import</strong> to bring in a CSV/Excel file. The app will auto-detect your columns.</li>
                <li><strong>If you're starting fresh:</strong> The script will create the proper sheets automatically when you first connect.</li>
                <li>Copy the URL from your browser's address bar &mdash; you'll need it below.</li>
              </ol>

              <h4 style="font-size: 14px; color: #333; margin: 0 0 8px 0;">Step 2: Add the Apps Script</h4>
              <ol style="margin: 0 0 16px 20px; padding: 0;">
                <li>In your Google Sheet, click <strong>Extensions</strong> in the menu bar at the top.</li>
                <li>Click <strong>Apps Script</strong>. A new tab will open with a code editor.</li>
                <li>You'll see some default code like <code>function myFunction() {}</code> &mdash; <strong>select all of it and delete it</strong> (Ctrl+A then Delete).</li>
                <li>Open the file <strong>google-apps-script.js</strong> that came with this app (it's in the same folder as the app). Copy its entire contents.</li>
                <li>Paste everything into the Apps Script editor (Ctrl+V).</li>
                <li>Click the <strong>Save</strong> button (floppy disk icon) or press <strong>Ctrl+S</strong>.</li>
                <li>You can rename the project from "Untitled project" to something like <strong>"Ministry Fair Backend"</strong> if you like.</li>
              </ol>

              <h4 style="font-size: 14px; color: #333; margin: 0 0 8px 0;">Step 3: Deploy as a Web App</h4>
              <ol style="margin: 0 0 16px 20px; padding: 0;">
                <li>In the Apps Script editor, click the blue <strong>Deploy</strong> button in the top right.</li>
                <li>Select <strong>New deployment</strong>.</li>
                <li>Next to "Select type", click the <strong>gear icon</strong> (&#9881;) and choose <strong>Web app</strong>.</li>
                <li>Fill in these settings:
                  <ul style="margin: 4px 0 4px 16px;">
                    <li><strong>Description:</strong> anything you like (e.g., "Ministry Fair")</li>
                    <li><strong>Execute as:</strong> <strong>Me</strong> (your Google account)</li>
                    <li><strong>Who has access:</strong> <strong>Anyone</strong></li>
                  </ul>
                </li>
                <li>Click <strong>Deploy</strong>.</li>
                <li>Google may ask you to <strong>authorize</strong> the script. Click <strong>Authorize access</strong>, choose your account, and if you see a "Google hasn't verified this app" warning, click <strong>Advanced</strong> &rarr; <strong>Go to Ministry Fair Backend (unsafe)</strong>. This is safe &mdash; it's your own script.</li>
                <li>After deploying, you'll see a <strong>Web app URL</strong> that starts with <code>https://script.google.com/macros/s/...</code></li>
                <li><strong>Copy this URL</strong> and paste it into the "Apps Script API URL" field below.</li>
              </ol>

              <h4 style="font-size: 14px; color: #333; margin: 0 0 8px 0;">Troubleshooting</h4>
              <ul style="margin: 0 0 0 20px; padding: 0;">
                <li><strong>"I don't see Extensions in the menu"</strong> &mdash; Make sure you're in Google Sheets (not Docs or Drive). The Extensions menu is in the top menu bar.</li>
                <li><strong>"The authorization screen looks scary"</strong> &mdash; This is normal for custom scripts. Google shows this warning for any unverified script. Since you wrote (pasted) it yourself, it's safe.</li>
                <li><strong>"I get a 'Script function not found' error"</strong> &mdash; Make sure you deleted the old default code before pasting. The script should start with <code>const SIGNUPS_SHEET_NAME = ...</code></li>
                <li><strong>"The URL doesn't work"</strong> &mdash; Make sure you copied the <strong>Web app URL</strong> (not the deployment ID). It should end in <code>/exec</code>.</li>
                <li><strong>"I need to update the script later"</strong> &mdash; Go to Extensions &rarr; Apps Script, make your changes, then Deploy &rarr; Manage deployments &rarr; click the pencil icon &rarr; set Version to "New version" &rarr; Deploy.</li>
              </ul>
            </div>
          </details>
        </div>

        <div class="form" style="margin-top: 20px;">
          <div class="input-group">
            <label class="label">Google Sheet URL</label>
            <input type="url" class="input" id="setup-sheet-url" placeholder="https://docs.google.com/spreadsheets/d/...">
          </div>
          <div class="input-group">
            <label class="label">Apps Script API URL</label>
            <input type="url" class="input" id="setup-api-url" placeholder="https://script.google.com/macros/s/.../exec">
          </div>
          <button class="btn-secondary" id="test-connection-btn" type="button">&#128268; Scan &amp; Connect</button>
          <div id="connection-status"></div>
          <!-- Sheet tab picker (hidden until scan results arrive) -->
          <div id="sheet-tab-picker" class="hidden" style="margin-top: 16px;">
            <div id="sheet-tab-list"></div>
            <div id="sheet-tab-preview" style="margin-top: 12px;"></div>
          </div>
        </div>
        <div class="wizard-nav">
          <button class="btn-secondary" id="step3-back">&larr; Back</button>
          <button class="btn" id="step3-next">Next &rarr;</button>
        </div>
      </div>
    </div>

    <!-- STEP 4: Add Admins -->
    <div class="wizard-step" data-wizard-step="4">
      <div class="card">
        <h2 class="section-title">Add Administrators</h2>
        <p class="welcome-text">
          Add other people who should be able to manage this app. You can always add or remove admins later in Settings.
        </p>
        <div class="admin-list" id="setup-admin-list"></div>
        <div class="add-admin-row">
          <input type="email" class="input" id="setup-new-admin-email" placeholder="colleague@gmail.com">
          <button class="btn-sm" id="setup-add-admin-btn">Add</button>
        </div>
        <div class="wizard-nav">
          <button class="btn-secondary" id="step4-back">&larr; Back</button>
          <button class="btn" id="step4-next">Next &rarr;</button>
        </div>
      </div>
    </div>

    <!-- STEP 5: Review & Launch -->
    <div class="wizard-step" data-wizard-step="5">
      <div class="card">
        <h2 class="section-title">Review &amp; Launch</h2>
        <p class="welcome-text">Everything looks good! Here's a summary of your setup.</p>
        <div class="summary-list" id="setup-summary"></div>
        <div class="launch-area">
          <div class="success-icon">&#9889;</div>
          <button class="btn btn-green" id="launch-btn" style="margin-top: 16px;">Launch Ministry Fair</button>
        </div>
        <div class="wizard-nav" style="margin-top: 16px;">
          <button class="btn-secondary" id="step5-back">&larr; Back</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================================== -->
<!-- SETTINGS VIEW                            -->
<!-- ======================================== -->
<div id="view-settings" class="hidden">
  <div class="content" style="padding-top: 16px;">
    <button class="settings-back" id="settings-back-btn">&larr; Back</button>
    <h2 class="section-title">Settings</h2>

    <!-- Admin-only sections -->
    <div id="settings-admin-sections">
      <div class="settings-section">
        <div class="settings-section-title">Organization</div>
        <div class="settings-card">
          <div class="settings-item" id="settings-org-name-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Organization Name</div>
            </div>
            <div style="display:flex;align-items:center;">
              <span class="settings-item-value" id="settings-org-name-val"></span>
              <span class="settings-item-arrow">&rsaquo;</span>
            </div>
          </div>
          <div class="settings-item" id="settings-app-title-item">
            <div class="settings-item-left">
              <div class="settings-item-label">App Title</div>
            </div>
            <div style="display:flex;align-items:center;">
              <span class="settings-item-value" id="settings-app-title-val"></span>
              <span class="settings-item-arrow">&rsaquo;</span>
            </div>
          </div>
          <div class="settings-item" id="settings-color-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Theme Color</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
              <div id="settings-color-swatch" style="width:24px;height:24px;border-radius:6px;"></div>
              <span class="settings-item-arrow">&rsaquo;</span>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Data Connection</div>
        <div class="settings-card">
          <div class="settings-item" id="settings-api-item">
            <div class="settings-item-left">
              <div class="settings-item-label">API URL</div>
              <div class="settings-item-desc" id="settings-api-status">Connected</div>
            </div>
            <span class="settings-item-arrow">&rsaquo;</span>
          </div>
          <div class="settings-item" id="settings-sheet-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Google Sheet</div>
              <div class="settings-item-desc" id="settings-sheet-status">Not set</div>
            </div>
            <span class="settings-item-arrow">&rsaquo;</span>
          </div>
          <div class="settings-item" id="settings-claude-key-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Claude API Key</div>
              <div class="settings-item-desc" id="settings-claude-key-status">Not set</div>
            </div>
            <span class="settings-item-arrow">&rsaquo;</span>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Administrators</div>
        <div class="settings-card" id="settings-admins-card">
          <!-- populated by JS -->
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Notifications</div>
        <div class="settings-card">
          <div class="settings-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Email Notifications</div>
              <div class="settings-item-desc">Sent from your signed-in account</div>
            </div>
            <div class="toggle-switch on" id="toggle-email" data-key="emailEnabled"></div>
          </div>
          <div class="settings-item">
            <div class="settings-item-left">
              <div class="settings-item-label">Text Notifications</div>
              <div class="settings-item-desc">SMS to members</div>
            </div>
            <div class="toggle-switch" id="toggle-text" data-key="textEnabled"></div>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Email Templates</div>
        <div id="settings-email-templates">
          <!-- populated by JS -->
        </div>
      </div>
    </div>

    <!-- Parishioner-visible section -->
    <div class="settings-section">
      <div class="settings-section-title">Your Account</div>
      <div class="settings-card">
        <div class="settings-item">
          <div class="settings-item-left">
            <div class="settings-item-label" id="settings-user-name"></div>
            <div class="settings-item-desc" id="settings-user-email"></div>
          </div>
        </div>
        <div class="settings-item" id="settings-logout-item" style="cursor:pointer;">
          <div class="settings-item-label" style="color:#c53030;">Log Out</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- REGISTER VIEW -->
<div id="view-register" class="hidden">
  <header class="header">
    <h1 class="app-title"></h1>
    <p class="app-tagline"></p>
  </header>
  <div class="content">
    <div class="card">
      <p class="welcome-text">
        Welcome! Let's get you signed up so you can explore our ministries and express interest in serving.
      </p>
      <div class="google-signin-section">
        <div id="g_id_signin"></div>
      </div>
      <div class="divider">or fill in manually</div>
      <form class="form" id="register-form">
        <div class="input-row">
          <div class="input-group">
            <label class="label">First Name</label>
            <input type="text" class="input" id="firstName" required autocomplete="given-name" placeholder="John">
          </div>
          <div class="input-group">
            <label class="label">Last Name</label>
            <input type="text" class="input" id="lastName" required autocomplete="family-name" placeholder="Smith">
          </div>
        </div>
        <div class="input-group">
          <label class="label">Email</label>
          <input type="email" class="input" id="email" required autocomplete="email" placeholder="john@example.com">
        </div>
        <div class="input-group">
          <label class="label">Cell Phone</label>
          <input type="tel" class="input" id="phone" required autocomplete="tel" placeholder="(555) 555-1234" maxlength="14">
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="joinParish">
          <label for="joinParish" id="joinParishLabel"></label>
        </div>
        <p class="consent-text" id="consentText"></p>
        <button type="submit" class="btn">Continue to Ministries &rarr;</button>
      </form>
    </div>
  </div>
</div>

<!-- MINISTRIES VIEW -->
<div id="view-ministries" class="hidden">
  <header class="header">
    <h1 class="app-title"></h1>
    <p id="interest-count">Tap a ministry to learn more</p>
  </header>
  <div class="content">
    <div class="profile-badge" id="parishioner-profile-badge">
      <div class="profile-icon" id="profile-initials"></div>
      <img class="profile-photo hidden" id="profile-photo" alt="Profile">
      <div style="flex: 1;">
        <div class="profile-name" id="profile-name"></div>
        <div class="profile-email" id="profile-email"></div>
        <div class="profile-phone" id="profile-phone"></div>
      </div>
      <button class="logout-link" id="logout-btn">Log out</button>
    </div>
    <h2 class="section-title">Our Ministries</h2>
    <div class="search-box">
      <input type="text" class="input" id="ministry-search" placeholder="&#128269; Search ministries...">
    </div>
    <div id="ministry-list"></div>
    <button class="btn-secondary hidden" id="show-all-btn">Show All Ministries</button>
  </div>
</div>

<!-- MINISTRY DETAIL VIEW -->
<div id="view-detail" class="hidden">
  <header class="header">
    <h1 id="detail-name"></h1>
    <p id="detail-icon"></p>
  </header>
  <div class="content">
    <div class="card">
      <p class="welcome-text" id="detail-desc"></p>
      <div id="detail-questions"></div>
      <div class="btn-group">
        <button class="btn" id="interest-btn">I'm Interested!</button>
        <button class="btn-remove hidden" id="remove-btn">Remove Interest</button>
        <button class="btn-secondary" id="back-btn">&larr; Back to All Ministries</button>
      </div>
    </div>
  </div>
</div>

<!-- CONFIRMATION MODAL -->
<div id="confirm-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <h3 class="modal-title">Remove Interest?</h3>
    <p class="modal-text">Are you sure you want to remove your interest in <strong id="modal-ministry-name"></strong>?</p>
    <div class="modal-buttons">
      <button class="btn-secondary" id="modal-cancel">Cancel</button>
      <button class="btn-remove" id="modal-confirm">Yes, Remove</button>
    </div>
  </div>
</div>

<!-- ROLE PICKER MODAL -->
<div id="role-picker-modal" class="modal hidden">
  <div class="modal-backdrop" onclick="document.getElementById('role-picker-modal').classList.add('hidden')"></div>
  <div class="modal-content" style="max-width: 380px;">
    <h3 class="modal-title">How would you like to sign in?</h3>
    <p class="modal-text" style="margin-bottom: 12px;">You have multiple roles. Choose how you'd like to use the app right now.</p>
    <div class="role-picker-options" id="role-picker-options">
      <!-- Populated dynamically -->
    </div>
  </div>
</div>

<!-- MISSING INFO PROMPT MODAL -->
<div id="missing-info-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-content" style="max-width: 380px;">
    <h3 class="modal-title">Complete Your Profile</h3>
    <p class="modal-text" style="margin-bottom: 12px;">We're missing some info for your account. Please fill in what you can.</p>
    <form class="form" id="missing-info-form">
      <div id="missing-info-fields"></div>
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button type="button" class="btn-secondary" style="flex: 1;" onclick="document.getElementById('missing-info-modal').classList.add('hidden')">Skip for Now</button>
        <button type="submit" class="btn" style="flex: 1;">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- ======================================== -->
<!-- ADMIN DASHBOARD VIEW                    -->
<!-- ======================================== -->
<div id="view-admin" class="hidden">
  <div class="content" style="max-width: 900px;">
    <div class="admin-tabs" id="admin-tabs">
      <button class="admin-tab active" data-tab="signups">Signups</button>
      <button class="admin-tab" data-tab="new-parishioners">New Parishioners</button>
      <button class="admin-tab" data-tab="ministries">Ministries</button>
      <button class="admin-tab" data-tab="users">Manage Users</button>
      <button class="admin-tab" data-tab="manual-entry">Manual Entry</button>
      <button class="admin-tab" data-tab="qr-codes">QR Codes</button>
    </div>

    <!-- Signups Tab -->
    <div id="admin-tab-signups">
      <div class="admin-toolbar">
        <input type="text" class="input" id="admin-signups-search" placeholder="&#128269; Search signups...">
        <button class="btn-export" id="export-signups-btn">&#128196; Export CSV</button>
      </div>
      <div class="admin-stat" id="admin-signups-stat"></div>
      <div class="admin-table-wrap">
        <table class="admin-table" id="admin-signups-table">
          <thead>
            <tr>
              <th>Date</th><th>Name</th><th>Email</th><th>Phone</th><th>Ministry</th><th>Action</th><th>New?</th>
            </tr>
          </thead>
          <tbody id="admin-signups-body"></tbody>
        </table>
      </div>
      <div id="admin-signups-empty" class="admin-empty hidden">No signups yet.</div>
    </div>

    <!-- New Parishioners Tab -->
    <div id="admin-tab-new-parishioners" class="hidden">
      <div class="admin-toolbar">
        <input type="text" class="input" id="admin-np-search" placeholder="&#128269; Search new parishioners...">
        <button class="btn-export" id="export-np-btn">&#128196; Export CSV</button>
      </div>
      <div class="admin-stat" id="admin-np-stat"></div>
      <div class="admin-table-wrap">
        <table class="admin-table" id="admin-np-table">
          <thead>
            <tr><th>Date</th><th>Name</th><th>Email</th><th>Phone</th></tr>
          </thead>
          <tbody id="admin-np-body"></tbody>
        </table>
      </div>
      <div id="admin-np-empty" class="admin-empty hidden">No new parishioners yet.</div>
    </div>

    <!-- Ministries Tab -->
    <div id="admin-tab-ministries" class="hidden">
      <div class="admin-toolbar">
        <button class="btn-sm" id="add-ministry-btn">+ Add Ministry</button>
        <button class="btn-sm" id="enrich-booklet-btn" style="margin-left: 8px;">&#128214; Import Booklet</button>
        <button class="btn-sm" id="enrich-spreadsheet-btn" style="margin-left: 8px;">&#128196; Add Spreadsheet</button>
        <button class="btn-sm" id="generate-icons-btn" style="margin-left: 8px;">&#127912; Generate Icons</button>
      </div>

      <!-- Enrichment Panel (hidden by default) -->
      <div id="enrich-panel" class="hidden" style="margin-bottom: 20px;">
        <div class="card" style="padding: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="section-title" style="font-size: 16px; margin: 0;" id="enrich-panel-title">Import Ministry Booklet</h3>
            <button class="remove-file" id="enrich-panel-close" style="font-size: 20px;">&times;</button>
          </div>
          <p class="welcome-text" id="enrich-panel-desc" style="font-size: 13px; margin: 8px 0 16px 0;">
            Upload a ministry booklet (PDF) or document. AI will extract descriptions, meeting times, contacts, and more to enrich your existing ministry data.
          </p>

          <!-- File upload area -->
          <div id="enrich-upload-area" class="upload-area" style="padding: 20px;">
            <div class="upload-area-icon">&#128203;</div>
            <div class="upload-area-text" id="enrich-upload-text">Drop your file here, or click to browse</div>
            <div class="upload-area-hint" id="enrich-upload-hint">PDF, Word, or image files</div>
            <input type="file" id="enrich-file-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.csv,.tsv,.xlsx,.xls,.txt">
          </div>
          <div id="enrich-filename" class="upload-filename hidden">
            <span>&#128196;</span>
            <span id="enrich-filename-text"></span>
            <button class="remove-file" id="enrich-remove-file-btn">&times;</button>
          </div>

          <!-- Progress -->
          <div id="enrich-progress" class="analysis-progress hidden">
            <div class="analysis-spinner"></div>
            <div class="analysis-status-text" id="enrich-status-text">Analyzing with AI...</div>
          </div>

          <!-- Results preview -->
          <div id="enrich-results" class="hidden" style="margin-top: 16px;">
            <div id="enrich-summary"></div>
            <div id="enrich-items" style="max-height: 400px; overflow-y: auto; margin-top: 12px;"></div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
              <button class="btn-secondary" id="enrich-cancel-btn" style="flex: 1;">Cancel</button>
              <button class="btn" id="enrich-apply-btn" style="flex: 1;">Apply Selected Changes</button>
            </div>
          </div>
        </div>
      </div>

      <div id="admin-ministries-list"></div>
    </div>

    <!-- Manage Users Tab -->
    <div id="admin-tab-users" class="hidden">
      <h3 class="section-title" style="font-size: 18px;">Administrators</h3>
      <div id="admin-users-list" class="admin-list"></div>
      <div class="add-admin-row" style="margin-top: 16px;">
        <input type="email" class="input" id="admin-new-user-email" placeholder="email@example.com">
        <input type="text" class="input" id="admin-new-user-name" placeholder="Name" style="max-width: 150px;">
        <button class="btn-sm" id="admin-add-user-btn">Add</button>
      </div>
    </div>

    <!-- Manual Entry Tab -->
    <div id="admin-tab-manual-entry" class="hidden">
      <div class="manual-entry-modes">
        <button class="mode-btn active" data-mode="upload" id="mode-upload-btn">Upload File</button>
        <button class="mode-btn" data-mode="manual" id="mode-manual-btn">Manual Entry</button>
      </div>

      <div class="manual-entry-success" id="manual-entry-success">Signup recorded successfully!</div>

      <!-- Upload Mode -->
      <div id="manual-upload-mode">
        <p style="font-size:14px;color:#666;margin-bottom:16px;font-family:'Inter',sans-serif;">
          Upload a CSV file or a photo of a paper sign-up sheet. AI will extract the signup data for you to review before submitting.
        </p>
        <div class="input-group" style="margin-bottom:12px;">
          <label class="label">Default Ministry (for entries without one)</label>
          <select class="select" id="upload-default-ministry">
            <option value="">Select a ministry...</option>
          </select>
        </div>
        <div class="upload-area" id="manual-upload-area">
          <div class="upload-area-icon">&#128196;</div>
          <div class="upload-area-text">Drop a file here or click to select</div>
          <div class="upload-area-hint">CSV, JPG, PNG, or PDF</div>
          <input type="file" id="manual-upload-input" accept=".csv,.jpg,.jpeg,.png,.pdf">
        </div>
        <div class="upload-filename hidden" id="manual-upload-filename">
          <span id="manual-upload-fname"></span>
          <button class="remove-file" id="manual-upload-remove">&times;</button>
        </div>
        <div class="analysis-progress hidden" id="manual-parse-progress">
          <div class="analysis-spinner"></div>
          <div class="analysis-status-text" id="manual-parse-status">Analyzing your file...</div>
        </div>
        <!-- Review table -->
        <div class="review-container hidden" id="manual-review-container">
          <h3>Review Parsed Entries</h3>
          <div class="admin-table-wrap">
            <table class="admin-table" id="manual-review-table">
              <thead>
                <tr>
                  <th style="width:30px;"></th>
                  <th>First</th>
                  <th>Last</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Ministry</th>
                </tr>
              </thead>
              <tbody id="manual-review-body"></tbody>
            </table>
          </div>
          <div class="review-actions">
            <span class="review-count" id="manual-review-count"></span>
            <div style="flex:1;"></div>
            <button class="btn-secondary" id="manual-review-clear">Clear</button>
            <button class="btn" id="manual-review-submit">Submit All</button>
          </div>
        </div>
      </div>

      <!-- Manual Mode -->
      <div id="manual-single-mode" class="hidden">
        <div class="manual-entry-form">
          <p style="font-size:14px;color:#666;margin-bottom:16px;font-family:'Inter',sans-serif;">
            Enter a single signup from a physical sign-up sheet.
          </p>
          <div class="form">
            <div class="input-row">
              <div class="input-group">
                <label class="label">First Name</label>
                <input type="text" class="input" id="manual-firstName" placeholder="John">
              </div>
              <div class="input-group">
                <label class="label">Last Name</label>
                <input type="text" class="input" id="manual-lastName" placeholder="Smith">
              </div>
            </div>
            <div class="input-group">
              <label class="label">Email</label>
              <input type="email" class="input" id="manual-email" placeholder="john@example.com">
            </div>
            <div class="input-group">
              <label class="label">Phone</label>
              <input type="tel" class="input" id="manual-phone" placeholder="(555) 555-1234" maxlength="14">
            </div>
            <div class="input-group">
              <label class="label">Ministry</label>
              <select class="select" id="manual-ministry">
                <option value="">Select a ministry...</option>
              </select>
            </div>
            <div id="manual-questions"></div>
            <div class="checkbox-group">
              <input type="checkbox" id="manual-newParishioner">
              <label for="manual-newParishioner">New parishioner (wants to join)</label>
            </div>
            <button class="btn" id="manual-submit-btn">Record Signup</button>
          </div>
        </div>
      </div>
    </div>

    <!-- QR Codes Tab -->
    <div id="admin-tab-qr-codes" class="hidden">
      <div class="admin-toolbar">
        <button class="btn-print" id="print-qr-btn">&#128424; Print QR Codes</button>
      </div>
      <div class="qr-grid" id="qr-grid"></div>
    </div>
  </div>
</div>

<!-- ======================================== -->
<!-- MY SIGNUPS VIEW                          -->
<!-- ======================================== -->
<div id="view-my-signups" class="hidden">
  <header class="header">
    <h1 class="app-title"></h1>
    <p>Your Ministry Signups</p>
  </header>
  <div class="content">
    <div id="my-signups-list"></div>
    <div id="my-signups-empty" class="admin-empty hidden">
      You haven't signed up for any ministries yet.
    </div>
    <button class="btn-secondary" id="my-signups-back" style="margin-top: 20px;">&larr; Back to Ministries</button>
  </div>
</div>

<!-- MINISTRY EDIT MODAL -->
<div id="ministry-edit-modal" class="edit-modal hidden">
  <div class="modal-backdrop" id="edit-modal-backdrop"></div>
  <div class="edit-modal-content">
    <h3 class="edit-modal-title" id="edit-modal-title">Add Ministry</h3>
    <div class="ministry-form-grid">
      <div class="ministry-form-row">
        <div class="input-group">
          <label class="label">ID (slug)</label>
          <input type="text" class="input" id="edit-ministry-id" placeholder="youth-group">
        </div>
        <div class="input-group">
          <label class="label">Icon (emoji)</label>
          <input type="text" class="input" id="edit-ministry-icon" placeholder="" style="max-width: 80px;">
        </div>
      </div>
      <div class="input-group">
        <label class="label">Name</label>
        <input type="text" class="input" id="edit-ministry-name" placeholder="Youth Group">
      </div>
      <div class="input-group">
        <label class="label">Description</label>
        <input type="text" class="input" id="edit-ministry-desc" placeholder="What this ministry does...">
      </div>
      <div class="ministry-form-row">
        <div class="input-group">
          <label class="label">Organizer Name</label>
          <input type="text" class="input" id="edit-ministry-org-name" placeholder="Jane Smith">
        </div>
        <div class="input-group">
          <label class="label">Organizer Email</label>
          <input type="email" class="input" id="edit-ministry-org-email" placeholder="jane@example.com">
        </div>
      </div>
      <div class="input-group">
        <label class="label">Organizer Phone</label>
        <input type="tel" class="input" id="edit-ministry-org-phone" placeholder="(555) 555-1234">
      </div>
      <div class="input-group">
        <label class="label">Tags (comma-separated)</label>
        <input type="text" class="input" id="edit-ministry-tags" placeholder="liturgy, service, socializing">
      </div>
    </div>
    <div class="edit-modal-actions">
      <button class="btn-secondary" id="edit-modal-cancel">Cancel</button>
      <button class="btn" id="edit-modal-save">Save</button>
    </div>
  </div>
</div>

<!-- FOLLOW-UP QUESTIONNAIRE VIEW -->
<div id="view-followup" class="hidden">
  <header class="header">
    <h1 class="app-title"></h1>
    <p>Follow-Up Questionnaire</p>
  </header>
  <div class="content">
    <div class="card" id="followup-form-card">
      <div class="followup-header">
        <h2 id="followup-ministry-name"></h2>
        <p id="followup-ministry-desc">Please answer the following questions so we can better serve you.</p>
      </div>
      <div class="form" id="followup-person-fields">
        <div class="input-row">
          <div class="input-group">
            <label class="label">First Name</label>
            <input type="text" class="input" id="followup-firstName" required placeholder="John">
          </div>
          <div class="input-group">
            <label class="label">Last Name</label>
            <input type="text" class="input" id="followup-lastName" required placeholder="Smith">
          </div>
        </div>
        <div class="input-group">
          <label class="label">Email</label>
          <input type="email" class="input" id="followup-email" required placeholder="john@example.com">
        </div>
        <div class="input-group">
          <label class="label">Phone</label>
          <input type="tel" class="input" id="followup-phone" placeholder="(555) 555-1234" maxlength="14">
        </div>
      </div>
      <div id="followup-questions" style="margin-top:16px;"></div>
      <button class="btn" id="followup-submit-btn" style="margin-top:20px;">Submit</button>
    </div>
    <div class="card followup-success hidden" id="followup-success-card">
      <div class="success-icon">&#10003;</div>
      <h2 class="section-title" style="margin-bottom:12px;">Thank You!</h2>
      <p class="welcome-text">Your responses have been recorded. The ministry lead will be in touch.</p>
      <div id="followup-organizer-info" style="margin-top:16px;"></div>
    </div>
  </div>
</div>

<!-- FOLLOW-UP EDITOR MODAL -->
<div id="followup-editor-modal" class="edit-modal hidden">
  <div class="modal-backdrop" id="followup-editor-backdrop"></div>
  <div class="edit-modal-content">
    <h3 class="edit-modal-title" id="followup-editor-title">Follow-Up Questions</h3>
    <p style="font-size:13px;color:#666;margin-bottom:12px;font-family:'Inter',sans-serif;">
      Configure up to 3 easy-to-answer questions per follow-up round. Add additional rounds for more questions. Each round gets its own shareable link.
    </p>
    <div id="followup-rounds-container"></div>
    <button class="btn-add-round" id="followup-add-round-btn">+ Add Another Round</button>
    <div class="edit-modal-actions">
      <button class="btn-secondary" id="followup-editor-cancel">Cancel</button>
      <button class="btn" id="followup-editor-save">Save All Rounds</button>
    </div>
  </div>
</div>

<!-- CONFIRMED VIEW -->
<div id="view-confirmed" class="hidden">
  <header class="header">
    <h1>Thank You!</h1>
    <p>Your interest has been recorded</p>
  </header>
  <div class="content">
    <div class="card" style="text-align: center;">
      <div class="success-icon">&#10003;</div>
      <h2 class="section-title" style="margin-bottom: 12px;">You're on the list!</h2>
      <p class="welcome-text" style="margin-bottom: 8px;">
        The <strong id="confirmed-ministry"></strong> ministry leader will reach out to you soon.
      </p>
      <div id="organizer-info"></div>
      <p style="font-size: 15px; color: #666; margin-bottom: 28px; margin-top: 20px;">
        Feel free to visit other tables and express interest in more ministries.
      </p>
      <button class="btn" id="explore-btn">Explore More Ministries</button>
    </div>
    <div id="interests-list" style="margin-top: 24px;"></div>
  </div>
</div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const DEFAULT_CONFIG = {
  organizationName: 'St. Theresa',
  appTitle: 'Ministry Fair',
  tagline: 'Find your place to serve',
  apiUrl: 'https://script.google.com/macros/s/AKfycbx31uyxV4pntlslmpcApd_cL_8AXz4e1ReLmSryJ-v4QuzCJid6wwB9Vg6tDkuuSVZxrQ/exec',
  spreadsheetUrl: 'https://docs.google.com/spreadsheets/d/146WY3S0WTMl_uLpufjU0z6zKtX2svKhxtu4G8w8VVHk/edit',
  primaryColor: '#8B2635',
  primaryColorDark: '#6B1D29',
  googleClientId: '1054492643145-oc8io3rqen2k1hqgrrj86a4op47nkg0m.apps.googleusercontent.com',
  setupComplete: false
};

const DEFAULT_NOTIFICATIONS = {
  emailEnabled: true,
  textEnabled: false,
  templates: {
    addedToMinistry: {
      name: 'Added to Ministry',
      subject: 'Welcome to {{ministry}}!',
      body: 'Hi {{firstName}},\n\nYou\'ve been added to {{ministry}} at {{organization}}. We\'re glad to have you!\n\nIf you have any questions, please reach out to your ministry lead.\n\nGod bless,\n{{organization}}'
    },
    appointedLead: {
      name: 'Appointed Ministry Lead',
      subject: 'You\'ve been appointed Ministry Lead of {{ministry}}',
      body: 'Hi {{firstName}},\n\nYou\'ve been appointed as Ministry Lead of {{ministry}} at {{organization}}. Thank you for stepping up to serve!\n\nYou can now manage members and communicate with your ministry team.\n\nGod bless,\n{{organization}}'
    },
    removedFromMinistry: {
      name: 'Removed from Ministry',
      subject: 'Update regarding {{ministry}}',
      body: 'Hi {{firstName}},\n\nThis is to let you know that you have been removed from {{ministry}} at {{organization}}.\n\nIf you believe this was a mistake, please contact your parish administrator.\n\nGod bless,\n{{organization}}'
    },
    removedAsLead: {
      name: 'Removed as Ministry Lead',
      subject: 'Update regarding {{ministry}} leadership',
      body: 'Hi {{firstName}},\n\nThis is to let you know that you have been removed as Ministry Lead of {{ministry}} at {{organization}}.\n\nThank you for your service. If you have questions, please contact your parish administrator.\n\nGod bless,\n{{organization}}'
    },
    newEvent: {
      name: 'New Event',
      subject: 'New Event: {{eventName}}',
      body: 'Hi {{firstName}},\n\nA new event has been scheduled for {{ministry}} at {{organization}}:\n\n{{eventName}}\nDate: {{eventDate}}\nLocation: {{eventLocation}}\n\nWe hope to see you there!\n\nGod bless,\n{{organization}}'
    }
  }
};

const COLOR_OPTIONS = [
  { color: '#8B2635', dark: '#6B1D29', name: 'Burgundy' },
  { color: '#1a5276', dark: '#154360', name: 'Navy' },
  { color: '#1e8449', dark: '#196f3d', name: 'Forest' },
  { color: '#6c3483', dark: '#5b2c6f', name: 'Purple' },
  { color: '#c0392b', dark: '#a93226', name: 'Red' },
  { color: '#2c3e50', dark: '#1a252f', name: 'Charcoal' },
  { color: '#d4ac0d', dark: '#b7950b', name: 'Gold' },
  { color: '#148f77', dark: '#117a65', name: 'Teal' },
  { color: '#1f618d', dark: '#1a5276', name: 'Blue' },
  { color: '#a04000', dark: '#873600', name: 'Rust' },
  { color: '#7d3c98', dark: '#6c3483', name: 'Violet' },
  { color: '#117864', dark: '#0e6655', name: 'Emerald' },
];

// ============================================
// STATE MANAGEMENT
// ============================================
function loadAppConfig() {
  try {
    const saved = localStorage.getItem('mf-app-config');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return { ...DEFAULT_CONFIG };
}

function saveAppConfig(config) {
  // Strip the API key before persisting to localStorage
  var toSave = Object.assign({}, config);
  delete toSave.claudeApiKey;
  localStorage.setItem('mf-app-config', JSON.stringify(toSave));
}

function getApiKey() {
  return sessionStorage.getItem('mf-claude-key') || '';
}

function setApiKey(key) {
  if (key) {
    sessionStorage.setItem('mf-claude-key', key);
  } else {
    sessionStorage.removeItem('mf-claude-key');
  }
}

function loadAdmins() {
  try {
    const saved = localStorage.getItem('mf-admins');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return [];
}

function saveAdmins(admins) {
  localStorage.setItem('mf-admins', JSON.stringify(admins));
}

function loadSession() {
  try {
    const saved = localStorage.getItem('mf-session');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return null;
}

function saveSession(session) {
  if (session) {
    localStorage.setItem('mf-session', JSON.stringify(session));
  } else {
    localStorage.removeItem('mf-session');
  }
}

function loadNotificationSettings() {
  try {
    const saved = localStorage.getItem('mf-notifications');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return JSON.parse(JSON.stringify(DEFAULT_NOTIFICATIONS));
}

function saveNotificationSettings(settings) {
  localStorage.setItem('mf-notifications', JSON.stringify(settings));
}

function isAdmin(email) {
  if (!email) return false;
  const admins = loadAdmins();
  return admins.some(a => a.email.toLowerCase() === email.toLowerCase());
}

function isMinistryLead(email) {
  if (!email || !MINISTRIES.length) return false;
  var normalizedEmail = email.toLowerCase();
  return MINISTRIES.some(function(m) {
    return m.organizerEmail && m.organizerEmail.toLowerCase() === normalizedEmail;
  });
}

function getUserRole(email) {
  if (isAdmin(email)) return 'admin';
  if (isMinistryLead(email)) return 'leader';
  return 'parishioner';
}

function darkenColor(hex, amount) {
  hex = hex.replace('#', '');
  let r = parseInt(hex.substring(0, 2), 16);
  let g = parseInt(hex.substring(2, 4), 16);
  let b = parseInt(hex.substring(4, 6), 16);
  r = Math.max(0, r - amount);
  g = Math.max(0, g - amount);
  b = Math.max(0, b - amount);
  return '#' + [r, g, b].map(c => c.toString(16).padStart(2, '0')).join('');
}

// ============================================
// GLOBAL STATE
// ============================================
let appConfig = loadAppConfig();
let appAdmins = loadAdmins();
let currentSession = loadSession();
let notificationSettings = loadNotificationSettings();

let MINISTRIES = [];
let profile = { firstName: '', lastName: '', email: '', phone: '', wantsToJoinParish: false };
let interests = [];
let currentMinistry = null;
let showAll = false;
let searchTerm = '';
let wizardStep = 1;
let setupAdminData = null; // temp admin data during wizard

// Load saved parishioner data
function hasSavedProfile() { return !!localStorage.getItem('ministry-fair-profile'); }
var _savedProfile = localStorage.getItem('ministry-fair-profile');
var _savedInterests = localStorage.getItem('ministry-fair-interests');
if (_savedProfile) { try { profile = JSON.parse(_savedProfile); } catch(e) {} }
if (_savedInterests) { try { interests = JSON.parse(_savedInterests); } catch(e) {} }

// Check URL for ministry param, follow-up param, and round
const urlParams = new URLSearchParams(window.location.search);
const ministryParam = urlParams.get('m');
const followupParam = urlParams.get('followup');
const followupRoundParam = parseInt(urlParams.get('round')) || 1;

// Fallback ministries
const FALLBACK_MINISTRIES = [
  { id: 'music', name: 'Music Ministry', description: 'Supports parish liturgies through choirs, cantors, and instrumentalists.', icon: '&#127925;', questions: [] },
  { id: 'hospitality', name: 'Hospitality Ministers', description: 'Welcomes parishioners and assists during Masses and parish events.', icon: '&#128682;', questions: [] }
];

// ============================================
// VIEWS
// ============================================
const views = {
  loading: document.getElementById('view-loading'),
  start: document.getElementById('view-start'),
  register: document.getElementById('view-register'),
  ministries: document.getElementById('view-ministries'),
  detail: document.getElementById('view-detail'),
  confirmed: document.getElementById('view-confirmed'),
  settings: document.getElementById('view-settings'),
  admin: document.getElementById('view-admin'),
  mySignups: document.getElementById('view-my-signups'),
  followup: document.getElementById('view-followup')
};

var _historyNavigating = false;

function showView(viewName) {
  Object.values(views).forEach(v => { if (v) v.classList.add('hidden'); });
  if (views[viewName]) views[viewName].classList.remove('hidden');
  window.scrollTo(0, 0);

  // Push to browser history (skip if handling back/forward navigation)
  if (!_historyNavigating) {
    var stateData = { view: viewName };
    if (viewName === 'detail' && currentMinistry) {
      stateData.ministryId = currentMinistry.id;
    }
    if (viewName === 'followup' && currentMinistry) {
      stateData.ministryId = currentMinistry.id;
    }
    history.pushState(stateData, '');
  }

  // Show/hide nav bar - visible for parishioners with saved profiles too
  const nav = document.getElementById('top-nav');
  if (viewName === 'start' || viewName === 'loading' || viewName === 'register') {
    nav.classList.add('hidden');
  } else if (currentSession || hasSavedProfile()) {
    updateNavBar();
    nav.classList.remove('hidden');
  }

  // Hide edit modals when switching views
  var editModal = document.getElementById('ministry-edit-modal');
  if (editModal) editModal.classList.add('hidden');
  var followupModal = document.getElementById('followup-editor-modal');
  if (followupModal) followupModal.classList.add('hidden');

  // Render Google buttons when those views show
  if (viewName === 'register') {
    renderGoogleButton('g_id_signin', handleParishionerSignIn);
  }
  if (viewName === 'start') {
    renderGoogleButton('g_id_signin_admin', handleAdminSignIn);
  }
}

// Browser back/forward button support
window.addEventListener('popstate', function(e) {
  if (e.state && e.state.view && views[e.state.view]) {
    _historyNavigating = true;
    var v = e.state.view;
    if (v === 'ministries') {
      showMinistriesList();
    } else if (v === 'admin') {
      showAdminDashboard();
    } else if (v === 'settings') {
      showSettingsView();
    } else if (v === 'mySignups') {
      showMySignups();
    } else if (v === 'detail' && e.state.ministryId) {
      var m = MINISTRIES.find(function(min) { return min.id === e.state.ministryId; });
      if (m) showMinistryDetail(m);
      else showMinistriesList();
    } else if (v === 'followup' && e.state.ministryId) {
      showFollowupForm(e.state.ministryId);
    } else if (v === 'confirmed') {
      showMinistriesList(); // Don't re-show confirmation, go to list
    } else {
      showView(v);
    }
    _historyNavigating = false;
  }
});

// ============================================
// GOOGLE SIGN-IN
// ============================================
var _googleRetryCount = {};
function renderGoogleButton(containerId, callback) {
  if (typeof google === 'undefined' || !google.accounts) {
    _googleRetryCount[containerId] = (_googleRetryCount[containerId] || 0) + 1;
    if (_googleRetryCount[containerId] > 50) return; // Stop after ~10 seconds
    setTimeout(function() { renderGoogleButton(containerId, callback); }, 200);
    return;
  }
  _googleRetryCount[containerId] = 0;
  google.accounts.id.initialize({
    client_id: appConfig.googleClientId || DEFAULT_CONFIG.googleClientId,
    callback: callback
  });
  var container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  google.accounts.id.renderButton(container, {
    type: 'standard',
    size: 'large',
    theme: 'outline',
    text: 'sign_in_with',
    shape: 'rectangular',
    logo_alignment: 'left',
    width: 300
  });
}

function decodeJwt(credential) {
  var base64Url = credential.split('.')[1];
  var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  return JSON.parse(atob(base64));
}

// ============================================
// DOMAIN DETECTION & CHURCH LOOKUP
// ============================================
var CONSUMER_DOMAINS = [
  'gmail.com','googlemail.com','yahoo.com','yahoo.co.uk','hotmail.com',
  'outlook.com','live.com','msn.com','aol.com','icloud.com','me.com',
  'mac.com','mail.com','protonmail.com','proton.me','zoho.com',
  'yandex.com','gmx.com','gmx.net','fastmail.com','tutanota.com',
  'hey.com','pm.me','comcast.net','verizon.net','att.net','sbcglobal.net',
  'cox.net','charter.net','earthlink.net','juno.com','bellsouth.net',
  'rocketmail.com','aim.com','optonline.net','frontier.com','windstream.net'
];

var detectedOrg = null; // stores AI detection result

function getDomain(email) {
  if (!email || !email.includes('@')) return '';
  return email.split('@')[1].toLowerCase();
}

function isConsumerDomain(domain) {
  return CONSUMER_DOMAINS.includes(domain);
}

// Extract base domain from the site URL (strips subdomains like "ministry.")
// e.g. "ministry.st-theresa.org"  "st-theresa.org"
function getSiteDomain() {
  var hostname = window.location.hostname; // e.g. "ministry.st-theresa.org"
  var parts = hostname.split('.');
  // For domains like "st-theresa.org", return as-is
  // For "ministry.st-theresa.org", return "st-theresa.org"
  if (parts.length > 2) {
    return parts.slice(1).join('.');
  }
  return hostname;
}

// Check if user's email domain matches the site's domain
function emailMatchesSiteDomain(email) {
  var emailDomain = getDomain(email);
  var siteDomain = getSiteDomain();
  if (!emailDomain || !siteDomain) return false;
  return emailDomain === siteDomain;
}

// Check if this domain is already registered (local check for now)
// FUTURE: Replace this with an API call to a central registry
function checkRegistration(domain) {
  // Single-tenant check: if app is set up and the domain matches
  // any admin's domain, it's "registered"
  if (appConfig.setupComplete) {
    var admins = loadAdmins();
    return admins.some(function(a) {
      return getDomain(a.email) === domain;
    });
  }
  return false;
}

// Call Claude API to identify if a domain belongs to a church.
// Routes through GAS proxy when available, falls back to direct browser call during setup.
async function lookupChurchDomain(domain, apiKey) {
  if (!domain) return null;

  // Try GAS proxy first (key stored server-side)
  if (appConfig.apiUrl) {
    try {
      var proxyResp = await fetch(appConfig.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'ai-lookup', domain: domain })
      });
      var proxyResult = await proxyResp.json();
      if (proxyResult.success && proxyResult.result) {
        return proxyResult.result;
      }
      // If server says no key, fall through to direct call
    } catch(err) {
      console.warn('GAS proxy lookup failed, trying direct:', err);
    }
  }

  // Fall back to direct browser call (during setup, before GAS URL exists)
  if (!apiKey) return null;
  var prompt = 'Analyze this email domain: "' + domain + '"\n\n' +
    'Based on the domain name and any knowledge you have, determine:\n' +
    '1. Is this likely a church, parish, temple, synagogue, mosque, or other religious organization?\n' +
    '2. If yes, what is the probable full name of the organization?\n' +
    '3. What denomination or religious tradition (if identifiable from the domain)?\n' +
    '4. What city/state or region (if identifiable)?\n\n' +
    'Return ONLY a JSON object with these fields:\n' +
    '{\n' +
    '  "isReligiousOrg": boolean,\n' +
    '  "organizationName": string (full name, e.g. "St. Theresa Catholic Church"),\n' +
    '  "denomination": string (e.g. "Catholic", "Baptist", "Methodist", "Non-denominational", or ""),\n' +
    '  "location": string (e.g. "Austin, TX" or "" if unknown),\n' +
    '  "confidence": "high" | "medium" | "low"\n' +
    '}\n\n' +
    'If you cannot determine, set isReligiousOrg to false. Return ONLY JSON, no explanation.';

  try {
    var response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-5-20250929',
        max_tokens: 256,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) return null;

    var result = await response.json();
    var text = result.content[0].text;
    text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
    return JSON.parse(text);
  } catch(err) {
    console.error('Church lookup error:', err);
    return null;
  }
}

// Run full domain detection flow
async function runDomainDetection(email) {
  var detectionDiv = document.getElementById('domain-detection');
  var domain = getDomain(email);

  if (!domain || isConsumerDomain(domain)) {
    // Personal email - no detection needed
    detectionDiv.classList.add('hidden');
    detectedOrg = null;
    return;
  }

  // Show detecting state
  detectionDiv.classList.remove('hidden');
  detectionDiv.innerHTML =
    '<div class="detection-card detecting">' +
      '<div class="detection-spinner-sm"></div>' +
      '<span class="detection-detail">Checking ' + escapeHtml(domain) + '...</span>' +
    '</div>';

  // Check if already registered with us
  if (checkRegistration(domain)) {
    detectionDiv.innerHTML =
      '<div class="detection-card found">' +
        '<div class="detection-icon">&#9989;</div>' +
        '<div class="detection-title">Welcome back!</div>' +
        '<div class="detection-detail">This organization is already set up. You\'ll be added as an administrator.</div>' +
      '</div>';
    detectedOrg = { isReligiousOrg: true, alreadyRegistered: true };
    return;
  }

  // Try AI lookup
  var apiKey = document.getElementById('setup-api-key').value.trim();
  if (!apiKey) {
    // No API key yet - try heuristic detection from domain name
    var heuristic = heuristicChurchDetect(domain);
    if (heuristic) {
      detectedOrg = heuristic;
      showDetectionResult(heuristic, domain);
    } else {
      detectionDiv.innerHTML =
        '<div class="detection-card not-found">' +
          '<div class="detection-icon">&#127970;</div>' +
          '<div class="detection-title">Custom domain detected</div>' +
          '<div class="detection-detail">We detected <strong>' + escapeHtml(domain) + '</strong>. ' +
          'Enter your API key above and we\'ll try to identify your organization automatically.</div>' +
        '</div>';
      detectedOrg = null;
    }
    return;
  }

  // AI-powered lookup
  var result = await lookupChurchDomain(domain, apiKey);

  if (result && result.isReligiousOrg) {
    detectedOrg = result;
    showDetectionResult(result, domain);
  } else {
    detectionDiv.innerHTML =
      '<div class="detection-card not-found">' +
        '<div class="detection-icon">&#127970;</div>' +
        '<div class="detection-title">Organization detected</div>' +
        '<div class="detection-detail">We see you\'re using <strong>' + escapeHtml(domain) + '</strong>. ' +
        'You\'ll configure your organization details in the next step.</div>' +
      '</div>';
    detectedOrg = null;
  }
}

function showDetectionResult(result, domain) {
  var detectionDiv = document.getElementById('domain-detection');
  var meta = [];
  if (result.denomination) meta.push(result.denomination);
  if (result.location) meta.push(result.location);

  detectionDiv.innerHTML =
    '<div class="detection-card found">' +
      '<div class="detection-icon">&#9962;</div>' +
      '<div class="detection-title">We found your organization!</div>' +
      '<div class="detection-org-name">' + escapeHtml(result.organizationName || domain) + '</div>' +
      (meta.length > 0 ? '<div class="detection-meta">' + meta.map(escapeHtml).join(' &middot; ') + '</div>' : '') +
      '<div class="detection-detail" style="margin-top:10px;">We\'ll pre-fill your setup with this information.</div>' +
    '</div>';
}

// Heuristic church detection from domain name patterns
function heuristicChurchDetect(domain) {
  var name = domain.split('.')[0].toLowerCase();
  var churchWords = [
    'church','parish','catholic','baptist','methodist','lutheran',
    'presbyterian','episcopal','pentecostal','adventist','orthodox',
    'assembly','temple','synagogue','mosque','masjid','chapel',
    'ministry','ministries','diocese','archdiocese','congregation',
    'covenant','gospel','faith','grace','hope','trinity','calvary',
    'bethel','zion','emmanuel','immanuel','redeemer','shepherd',
    'saint','saints','st-','umc','cogic'
  ];

  var found = churchWords.some(function(word) {
    return name.includes(word);
  });

  if (!found) return null;

  // Try to build a readable name from the domain
  var readable = name
    .replace(/-/g, ' ')
    .replace(/\b\w/g, function(c) { return c.toUpperCase(); })
    .replace(/\bSt /g, 'St. ')
    .replace(/\bUmc\b/g, 'United Methodist Church')
    .replace(/\bCogic\b/g, 'Church of God in Christ');

  return {
    isReligiousOrg: true,
    organizationName: readable,
    denomination: '',
    location: '',
    confidence: 'low'
  };
}

// Re-run detection when API key is entered (in case domain was already captured)
document.getElementById('setup-api-key').addEventListener('change', function() {
  if (setupAdminData && setupAdminData.email) {
    var domain = getDomain(setupAdminData.email);
    if (domain && !isConsumerDomain(domain) && !detectedOrg) {
      runDomainDetection(setupAdminData.email);
    }
  }
});

// ============================================
// GOOGLE SIGN-IN HANDLERS
// ============================================

// Admin sign-in (during /start wizard)
function handleAdminSignIn(response) {
  var payload = decodeJwt(response.credential);
  setupAdminData = {
    email: payload.email || '',
    firstName: payload.given_name || '',
    lastName: payload.family_name || '',
    picture: payload.picture || ''
  };

  // Show signed-in state
  document.getElementById('admin-signed-in').classList.remove('hidden');
  document.getElementById('admin-setup-initials').textContent =
    (setupAdminData.firstName[0] || '') + (setupAdminData.lastName[0] || '');
  document.getElementById('admin-setup-name').textContent =
    setupAdminData.firstName + ' ' + setupAdminData.lastName;
  document.getElementById('admin-setup-email').textContent = setupAdminData.email;

  // Enable next button
  document.getElementById('step1-next').disabled = false;

  // Run domain detection
  runDomainDetection(setupAdminData.email);
}

// Parishioner sign-in (auto-fill registration form)
function handleParishionerSignIn(response) {
  var payload = decodeJwt(response.credential);
  var email = payload.email || '';
  var firstName = payload.given_name || '';
  var lastName = payload.family_name || '';
  var picture = payload.picture || '';
  var domain = getDomain(email);

  // Build list of roles this person has
  var roles = ['parishioner']; // everyone can be a parishioner

  // Check if email domain matches site domain  potential admin (especially for first-time setup)
  var domainMatchesSite = emailMatchesSiteDomain(email);

  // Check if they're a registered admin
  var registeredAdmin = isAdmin(email);
  if (registeredAdmin) {
    roles.push('admin');
  }

  // Check if they're a ministry lead (based on loaded ministries data)
  if (isMinistryLead(email)) {
    roles.push('leader');
  }

  // If setup isn't complete and their email domain matches the site, offer admin setup
  if (!appConfig.setupComplete && domainMatchesSite && !isConsumerDomain(domain)) {
    roles.push('setup_admin');
  }

  // If they have multiple roles, show the role picker
  if (roles.length > 1) {
    showRolePicker(roles, { email: email, firstName: firstName, lastName: lastName, picture: picture });
    return;
  }

  // Single role: just a parishioner  continue with normal flow
  continueAsParishioner(firstName, lastName, email, picture);
}

// Show the role picker modal
function showRolePicker(roles, userData) {
  var container = document.getElementById('role-picker-options');
  container.innerHTML = '';

  var roleConfig = {
    parishioner: {
      icon: '\u26EA', // church emoji
      label: 'Parishioner',
      desc: 'Browse ministries and sign up to serve'
    },
    admin: {
      icon: '\u2699', // gear emoji
      label: 'Administrator',
      desc: 'Manage ministries, signups, and settings'
    },
    setup_admin: {
      icon: '\uD83D\uDD27', // wrench emoji
      label: 'Set Up This Site',
      desc: 'Configure this Ministry Fair for your organization'
    },
    leader: {
      icon: '\uD83D\uDCCB', // clipboard emoji
      label: 'Ministry Lead',
      desc: 'Manage your ministry and view signups'
    }
  };

  roles.forEach(function(role) {
    var config = roleConfig[role];
    if (!config) return;

    var btn = document.createElement('button');
    btn.className = 'role-picker-btn';
    btn.innerHTML =
      '<div class="role-picker-icon">' + config.icon + '</div>' +
      '<div><div class="role-picker-label">' + config.label + '</div>' +
      '<div class="role-picker-desc">' + config.desc + '</div></div>';

    btn.addEventListener('click', function() {
      document.getElementById('role-picker-modal').classList.add('hidden');
      handleRoleSelection(role, userData);
    });

    container.appendChild(btn);
  });

  document.getElementById('role-picker-modal').classList.remove('hidden');
}

// Handle the chosen role
function handleRoleSelection(role, userData) {
  if (role === 'setup_admin') {
    // Route to the admin setup wizard
    setupAdminData = {
      email: userData.email,
      firstName: userData.firstName,
      lastName: userData.lastName,
      picture: userData.picture
    };
    showView('start');
    showWizardStep(1);
    document.getElementById('admin-signed-in').classList.remove('hidden');
    document.getElementById('admin-setup-initials').textContent =
      (userData.firstName[0] || '') + (userData.lastName[0] || '');
    document.getElementById('admin-setup-name').textContent =
      userData.firstName + ' ' + userData.lastName;
    document.getElementById('admin-setup-email').textContent = userData.email;
    document.getElementById('step1-next').disabled = false;
    runDomainDetection(userData.email);
  } else if (role === 'admin') {
    // Sign in as admin and go to admin dashboard
    currentSession = {
      email: userData.email,
      firstName: userData.firstName,
      lastName: userData.lastName,
      picture: userData.picture,
      role: 'admin'
    };
    saveSession(currentSession);
    loadMinistries().then(function() {
      showAdminDashboard();
      checkMissingInfo(userData.email);
    });
  } else if (role === 'leader') {
    // Sign in as ministry lead
    currentSession = {
      email: userData.email,
      firstName: userData.firstName,
      lastName: userData.lastName,
      picture: userData.picture,
      role: 'leader'
    };
    saveSession(currentSession);
    loadMinistries().then(function() {
      showAdminDashboard();
      checkMissingInfo(userData.email);
    });
  } else {
    // Parishioner
    continueAsParishioner(userData.firstName, userData.lastName, userData.email, userData.picture);
  }
}

// Check if a ministry lead/admin is missing profile info (e.g. phone number)
// and prompt them to fill it in
function checkMissingInfo(email) {
  if (!MINISTRIES.length) return;
  var normalizedEmail = email.toLowerCase();

  // Find ministries this person leads
  var ledMinistries = MINISTRIES.filter(function(m) {
    return m.organizerEmail && m.organizerEmail.toLowerCase() === normalizedEmail;
  });

  if (ledMinistries.length === 0) return;

  // Check what's missing
  var missingFields = [];
  var firstMinistry = ledMinistries[0];

  if (!firstMinistry.organizerPhone) {
    missingFields.push({
      key: 'phone',
      label: 'Cell Phone',
      type: 'tel',
      placeholder: '(555) 555-1234',
      maxlength: 14
    });
  }
  if (!firstMinistry.organizerName) {
    missingFields.push({
      key: 'name',
      label: 'Your Name',
      type: 'text',
      placeholder: 'Jane Smith'
    });
  }

  if (missingFields.length === 0) return;

  // Build the form fields
  var container = document.getElementById('missing-info-fields');
  container.innerHTML = '';

  missingFields.forEach(function(field) {
    var group = document.createElement('div');
    group.className = 'input-group';
    group.innerHTML =
      '<label class="label">' + field.label + '</label>' +
      '<input type="' + field.type + '" class="input" id="missing-' + field.key + '"' +
      ' placeholder="' + field.placeholder + '"' +
      (field.maxlength ? ' maxlength="' + field.maxlength + '"' : '') + '>';
    container.appendChild(group);
  });

  // Phone formatting
  var phoneInput = document.getElementById('missing-phone');
  if (phoneInput) {
    phoneInput.addEventListener('input', function(e) {
      e.target.value = formatPhoneNumber(e.target.value);
    });
  }

  // Handle form submit
  var form = document.getElementById('missing-info-form');
  form.onsubmit = function(e) {
    e.preventDefault();
    var updates = {};

    var phoneVal = document.getElementById('missing-phone');
    if (phoneVal && phoneVal.value.trim()) updates.organizerPhone = phoneVal.value.trim();

    var nameVal = document.getElementById('missing-name');
    if (nameVal && nameVal.value.trim()) updates.organizerName = nameVal.value.trim();

    // Update each ministry this person leads via the API
    if (Object.keys(updates).length > 0 && appConfig.apiUrl) {
      ledMinistries.forEach(function(ministry) {
        var payload = {
          adminAction: 'updateMinistry',
          adminEmail: email,
          ministryId: ministry.id,
          name: ministry.name,
          description: ministry.description,
          icon: ministry.icon,
          organizerName: updates.organizerName || ministry.organizerName || '',
          organizerEmail: ministry.organizerEmail || '',
          organizerPhone: updates.organizerPhone || ministry.organizerPhone || ''
        };
        fetch(appConfig.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      });
    }

    document.getElementById('missing-info-modal').classList.add('hidden');
  };

  document.getElementById('missing-info-modal').classList.remove('hidden');
}

// Continue with normal parishioner registration flow
function continueAsParishioner(firstName, lastName, email, picture) {
  document.getElementById('firstName').value = firstName;
  document.getElementById('lastName').value = lastName;
  document.getElementById('email').value = email;
  if (picture) {
    document.getElementById('register-form').dataset.photoUrl = picture;
  }
  document.getElementById('phone').focus();
}

// ============================================
// NAV BAR
// ============================================
function updateNavBar() {
  var isAdminUser = currentSession && getUserRole(currentSession.email) === 'admin';

  if (currentSession) {
    var role = getUserRole(currentSession.email);
    document.getElementById('nav-brand-text').textContent = appConfig.appTitle || 'Ministry Fair';
    document.getElementById('nav-user-name').textContent = currentSession.firstName + ' ' + currentSession.lastName;
    document.getElementById('nav-user-email').textContent = currentSession.email;
    var badge = document.getElementById('nav-role-badge');
    badge.textContent = role === 'admin' ? 'Admin' : role === 'leader' ? 'Ministry Lead' : 'Member';
    badge.className = 'role-badge role-' + role;
  } else if (hasSavedProfile()) {
    document.getElementById('nav-brand-text').textContent = appConfig.appTitle || 'Ministry Fair';
    document.getElementById('nav-user-name').textContent = profile.firstName + ' ' + profile.lastName;
    document.getElementById('nav-user-email').textContent = profile.email;
    var badge = document.getElementById('nav-role-badge');
    badge.textContent = 'Member';
    badge.className = 'role-badge role-parishioner';
  } else {
    return;
  }

  // Only show settings gear and dashboard for admins
  document.getElementById('nav-settings-btn').classList.toggle('hidden', !isAdminUser);
  document.getElementById('nav-dashboard-btn').classList.toggle('hidden', !isAdminUser);
  // Show "My Signups" for everyone who has a profile
  document.getElementById('nav-my-signups-btn').classList.toggle('hidden', !hasSavedProfile());
}

document.getElementById('nav-dashboard-btn').addEventListener('click', function() {
  showAdminDashboard();
});

document.getElementById('nav-my-signups-btn').addEventListener('click', function() {
  showMySignups();
});

document.getElementById('nav-settings-btn').addEventListener('click', function() {
  showSettingsView();
});

document.getElementById('nav-brand-text').addEventListener('click', function() {
  if (hasSavedProfile()) {
    showMinistriesList();
  }
});

document.getElementById('nav-logout-btn').addEventListener('click', function() {
  var isAdminUser = currentSession && getUserRole(currentSession.email) === 'admin';
  var msg = isAdminUser
    ? 'Log out of your admin session?'
    : 'Are you sure you want to log out? Your interest selections on this device will be cleared.';
  if (confirm(msg)) {
    if (isAdminUser) {
      currentSession = null;
      saveSession(null);
      document.getElementById('top-nav').classList.add('hidden');
      if (hasSavedProfile()) {
        showMinistriesList();
      } else {
        showView('register');
      }
    } else {
      localStorage.removeItem('ministry-fair-profile');
      localStorage.removeItem('ministry-fair-interests');
      profile = { firstName: '', lastName: '', email: '', phone: '', wantsToJoinParish: false };
      interests = [];
      currentMinistry = null;
      currentSession = null;
      saveSession(null);
      showAll = false;
      searchTerm = '';
      document.getElementById('top-nav').classList.add('hidden');
      showView('register');
    }
  }
});

// ============================================
// SECURITY: HTML ESCAPING
// ============================================
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function isValidEmail(email) {
  if (!email) return false;
  if (/^javascript:/i.test(email.trim())) return false;
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// ============================================
// PHONE FORMATTING
// ============================================
function formatPhoneNumber(value) {
  if (!value) return '';
  var digits = value.replace(/\D/g, '');
  if (digits.length === 11 && digits[0] === '1') digits = digits.slice(1);
  digits = digits.slice(0, 10);
  if (digits.length === 0) return '';
  if (digits.length <= 3) return '(' + digits + ')';
  if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
  return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6);
}

// ============================================
// START WIZARD
// ============================================
function showWizardStep(step) {
  wizardStep = step;

  // Restore API key from sessionStorage into the input field
  if (step === 1) {
    var savedKey = getApiKey();
    var keyInput = document.getElementById('setup-api-key');
    if (savedKey && keyInput && !keyInput.value) {
      keyInput.value = savedKey;
    }
  }

  // Update step dots
  document.querySelectorAll('.step-dot').forEach(function(dot) {
    var s = parseInt(dot.dataset.step);
    dot.className = 'step-dot';
    if (s < step) dot.classList.add('done');
    if (s === step) dot.classList.add('active');
  });
  document.querySelectorAll('.step-line').forEach(function(line) {
    var after = parseInt(line.dataset.after);
    line.className = 'step-line';
    if (after < step) line.classList.add('done');
  });

  // Show/hide steps
  document.querySelectorAll('.wizard-step').forEach(function(ws) {
    var s = parseInt(ws.dataset.wizardStep);
    ws.classList.toggle('active', s === step);
  });

  // Step-specific init
  if (step === 2) initStep2();
  if (step === 4) renderAdminList();
  if (step === 5) renderSummary();
}

// Step 2: Color grid + preview + pre-fill from detection
function initStep2() {
  // Pre-fill from AI detection results
  if (detectedOrg && detectedOrg.organizationName) {
    var orgInput = document.getElementById('setup-org-name');
    if (!orgInput.value) {
      orgInput.value = detectedOrg.organizationName;
    }
  }

  var grid = document.getElementById('color-grid');
  if (grid.children.length > 0) return; // already rendered

  COLOR_OPTIONS.forEach(function(opt) {
    var swatch = document.createElement('div');
    swatch.className = 'color-swatch' + (opt.color === appConfig.primaryColor ? ' selected' : '');
    swatch.style.background = 'linear-gradient(135deg, ' + opt.color + ' 0%, ' + opt.dark + ' 100%)';
    swatch.title = opt.name;
    swatch.dataset.color = opt.color;
    swatch.dataset.dark = opt.dark;
    swatch.addEventListener('click', function() {
      grid.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('selected'); });
      swatch.classList.add('selected');
      appConfig.primaryColor = opt.color;
      appConfig.primaryColorDark = opt.dark;
      updateHeaderPreview();
    });
    grid.appendChild(swatch);
  });

  // Sync inputs to preview
  var titleInput = document.getElementById('setup-app-title');
  var taglineInput = document.getElementById('setup-tagline');
  titleInput.addEventListener('input', updateHeaderPreview);
  taglineInput.addEventListener('input', updateHeaderPreview);
  updateHeaderPreview();
}

function updateHeaderPreview() {
  var preview = document.getElementById('header-preview');
  var title = document.getElementById('setup-app-title').value || 'Ministry Fair';
  var tagline = document.getElementById('setup-tagline').value || 'Find your place to serve';
  preview.style.background = 'linear-gradient(135deg, ' + appConfig.primaryColor + ' 0%, ' + appConfig.primaryColorDark + ' 100%)';
  document.getElementById('preview-title').textContent = title;
  document.getElementById('preview-tagline').textContent = tagline;
}

// ============================================
// STEP 3: FILE UPLOAD + AI SPREADSHEET ANALYSIS
// ============================================

var uploadedFileData = null; // { headers: [], rows: [] }
var aiMappingResult = null;  // result from Claude

// CSV Parser - handles quoted fields, commas in values, newlines in quotes
function parseCSV(text) {
  var rows = [];
  var row = [];
  var field = '';
  var inQuotes = false;
  var i = 0;

  while (i < text.length) {
    var ch = text[i];
    if (inQuotes) {
      if (ch === '"') {
        if (i + 1 < text.length && text[i + 1] === '"') {
          field += '"';
          i += 2;
        } else {
          inQuotes = false;
          i++;
        }
      } else {
        field += ch;
        i++;
      }
    } else {
      if (ch === '"') {
        inQuotes = true;
        i++;
      } else if (ch === ',') {
        row.push(field.trim());
        field = '';
        i++;
      } else if (ch === '\n' || (ch === '\r' && i + 1 < text.length && text[i + 1] === '\n')) {
        row.push(field.trim());
        if (row.some(function(c) { return c !== ''; })) rows.push(row);
        row = [];
        field = '';
        i += (ch === '\r') ? 2 : 1;
      } else if (ch === '\r') {
        row.push(field.trim());
        if (row.some(function(c) { return c !== ''; })) rows.push(row);
        row = [];
        field = '';
        i++;
      } else {
        field += ch;
        i++;
      }
    }
  }
  // Last field
  row.push(field.trim());
  if (row.some(function(c) { return c !== ''; })) rows.push(row);

  return rows;
}

// Tab-separated parser
function parseTSV(text) {
  return text.split(/\r?\n/).filter(function(line) { return line.trim(); }).map(function(line) {
    return line.split('\t').map(function(c) { return c.trim(); });
  });
}

// File upload - drag & drop and click
(function() {
  var area = document.getElementById('upload-area');
  var fileInput = document.getElementById('file-input');

  area.addEventListener('click', function() { fileInput.click(); });

  area.addEventListener('dragover', function(e) {
    e.preventDefault();
    area.classList.add('dragover');
  });
  area.addEventListener('dragleave', function() {
    area.classList.remove('dragover');
  });
  area.addEventListener('drop', function(e) {
    e.preventDefault();
    area.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
  });

  fileInput.addEventListener('change', function() {
    if (fileInput.files.length > 0) handleFile(fileInput.files[0]);
  });

  document.getElementById('remove-file-btn').addEventListener('click', function() {
    uploadedFileData = null;
    aiMappingResult = null;
    fileInput.value = '';
    document.getElementById('upload-area').classList.remove('hidden');
    document.getElementById('upload-filename').classList.add('hidden');
    document.getElementById('analysis-section').classList.add('hidden');
    document.getElementById('mapping-results').classList.add('hidden');
  });
})();

function handleFile(file) {
  document.getElementById('upload-area').classList.add('hidden');
  document.getElementById('upload-filename').classList.remove('hidden');
  document.getElementById('filename-text').textContent = file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)';
  document.getElementById('analysis-section').classList.remove('hidden');

  var reader = new FileReader();
  reader.onload = function(e) {
    var text = e.target.result;
    var parsed;

    // Detect format
    if (file.name.endsWith('.tsv') || file.name.endsWith('.txt')) {
      parsed = parseTSV(text);
    } else {
      // Try CSV first; if first row has only 1 column but has tabs, try TSV
      parsed = parseCSV(text);
      if (parsed.length > 0 && parsed[0].length === 1 && parsed[0][0].includes('\t')) {
        parsed = parseTSV(text);
      }
    }

    if (parsed.length < 2) {
      document.getElementById('analysis-progress').classList.add('hidden');
      document.getElementById('mapping-results').classList.remove('hidden');
      document.getElementById('mapping-summary-box').innerHTML =
        '<div class="mapping-summary warn"><h4>Not enough data</h4><p>The file needs at least a header row and one data row.</p></div>';
      return;
    }

    uploadedFileData = {
      headers: parsed[0],
      rows: parsed.slice(1)
    };

    analyzeWithAI(uploadedFileData);
  };
  reader.readAsText(file);
}

// Call Claude API to analyze the spreadsheet.
// Routes through GAS proxy when available, falls back to direct browser call during setup.
async function analyzeWithAI(data) {
  var apiKey = document.getElementById('setup-api-key').value.trim();
  var progress = document.getElementById('analysis-progress');
  var results = document.getElementById('mapping-results');

  progress.classList.remove('hidden');
  results.classList.add('hidden');

  var hasDirectKey = !!apiKey;
  var hasGasUrl = !!appConfig.apiUrl;

  if (!hasDirectKey && !hasGasUrl) {
    progress.classList.add('hidden');
    results.classList.remove('hidden');
    document.getElementById('mapping-summary-box').innerHTML =
      '<div class="mapping-summary warn"><h4>No API key provided</h4>' +
      '<p>Go back to Step 1 and enter your Claude API key to enable AI-powered spreadsheet analysis.</p></div>';
    return;
  }

  // Build sample data for the prompt (headers + first 5 rows max)
  var sampleRows = data.rows.slice(0, 5);
  var sampleText = 'HEADERS: ' + JSON.stringify(data.headers) + '\n\nSAMPLE ROWS:\n';
  sampleRows.forEach(function(row, i) {
    sampleText += 'Row ' + (i + 1) + ': ' + JSON.stringify(row) + '\n';
  });

  var prompt = 'I have a spreadsheet with ministry/group data from a church or parish. I need to map the columns to this schema:\n\n' +
    'REQUIRED FIELDS:\n' +
    '- name: The ministry or group name (REQUIRED)\n' +
    '- description: What the ministry does\n\n' +
    'OPTIONAL FIELDS:\n' +
    '- id: A short slug/identifier (if not present, we can generate from name)\n' +
    '- icon: An emoji representing the ministry\n' +
    '- organizerName: Contact person name\n' +
    '- organizerEmail: Contact person email\n' +
    '- organizerPhone: Contact person phone\n' +
    '- question1, question2, question3: Questions to ask people who sign up (in format: type|label|options where type is text/select/checkbox)\n\n' +
    'Here is the spreadsheet data:\n\n' + sampleText + '\n\n' +
    'Analyze the headers and data. Return a JSON object with:\n' +
    '1. "mapping": An object where each key is one of my schema fields (name, description, id, icon, organizerName, organizerEmail, organizerPhone, question1, question2, question3) and the value is the 0-based column index that best matches it, or -1 if no column matches.\n' +
    '2. "confidence": "high", "medium", or "low" - overall confidence in the mapping.\n' +
    '3. "found": Number of fields that were successfully mapped.\n' +
    '4. "missing": Array of field names that could not be mapped.\n' +
    '5. "suggestions": Array of human-readable suggestions for improving the data (e.g., "Add a Description column to explain what each ministry does"). Keep this to genuinely useful suggestions only.\n' +
    '6. "columnNotes": Object mapping column index to a note about what we think that column contains (for columns that DO map to something).\n\n' +
    'IMPORTANT: Return ONLY the JSON object, no markdown formatting, no explanation outside the JSON.';

  try {
    var mappingText = null;

    // Try GAS proxy first (key stored server-side)
    if (hasGasUrl) {
      try {
        var proxyResp = await fetch(appConfig.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'ai-analyze', sampleData: sampleText, prompt: prompt })
        });
        var proxyResult = await proxyResp.json();
        if (proxyResult.success && proxyResult.result) {
          aiMappingResult = typeof proxyResult.result === 'string' ? JSON.parse(proxyResult.result) : proxyResult.result;
          mappingText = 'done';
        }
      } catch(proxyErr) {
        console.warn('GAS proxy analysis failed, trying direct:', proxyErr);
      }
    }

    // Fall back to direct browser call
    if (!mappingText && hasDirectKey) {
      var response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-5-20250929',
          max_tokens: 1024,
          messages: [{ role: 'user', content: prompt }]
        })
      });

      if (!response.ok) {
        var errBody = await response.text();
        throw new Error('API error ' + response.status + ': ' + errBody);
      }

      var result = await response.json();
      var text = result.content[0].text;
      text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
      aiMappingResult = JSON.parse(text);
    }

    if (!aiMappingResult) {
      throw new Error('No AI analysis result received');
    }

    progress.classList.add('hidden');
    results.classList.remove('hidden');
    renderMappingResults(aiMappingResult, data);

  } catch(err) {
    progress.classList.add('hidden');
    results.classList.remove('hidden');
    document.getElementById('mapping-summary-box').innerHTML =
      '<div class="mapping-summary warn"><h4>Analysis error</h4>' +
      '<p>' + escapeHtml(err.message) + '</p>' +
      '<p style="margin-top:8px;">Check that your API key is correct and try again.</p></div>';
  }
}

// Render AI mapping results
function renderMappingResults(mapping, data) {
  var FIELD_LABELS = {
    name: { label: 'Ministry Name', required: true },
    description: { label: 'Description', required: false },
    id: { label: 'ID / Slug', required: false },
    icon: { label: 'Icon (emoji)', required: false },
    organizerName: { label: 'Organizer Name', required: false },
    organizerEmail: { label: 'Organizer Email', required: false },
    organizerPhone: { label: 'Organizer Phone', required: false },
    question1: { label: 'Question 1', required: false },
    question2: { label: 'Question 2', required: false },
    question3: { label: 'Question 3', required: false }
  };

  // Summary box
  var summaryClass = mapping.confidence === 'high' ? 'good' : 'warn';
  var summaryIcon = mapping.confidence === 'high' ? '&#10003;' : '&#9888;';
  var summaryText = 'Mapped ' + mapping.found + ' of 10 fields from your spreadsheet (' + data.rows.length + ' ministries found).';
  document.getElementById('mapping-summary-box').innerHTML =
    '<div class="mapping-summary ' + summaryClass + '">' +
    '<h4>' + summaryIcon + ' ' + summaryText + '</h4></div>';

  // Mapping table
  var tbody = document.getElementById('mapping-table-body');
  var fields = Object.keys(FIELD_LABELS);
  tbody.innerHTML = fields.map(function(field) {
    var info = FIELD_LABELS[field];
    var colIdx = mapping.mapping[field];
    var isMapped = colIdx !== undefined && colIdx >= 0 && colIdx < data.headers.length;
    var yourCol = isMapped ? data.headers[colIdx] : '&mdash;';
    var statusClass = isMapped ? 'mapped' : (info.required ? 'missing' : 'optional');
    var statusText = isMapped ? '&#10003; Mapped' : (info.required ? '&#10007; Missing' : 'Not found');
    var note = (mapping.columnNotes && mapping.columnNotes[String(colIdx)]) ? ' <span style="color:#888;font-size:11px;">(' + escapeHtml(mapping.columnNotes[String(colIdx)]) + ')</span>' : '';

    return '<tr>' +
      '<td>' + escapeHtml(info.label) + (info.required ? ' <span style="color:#c53030;">*</span>' : '') + '</td>' +
      '<td>' + escapeHtml(yourCol) + note + '</td>' +
      '<td><span class="mapping-status ' + statusClass + '">' + statusText + '</span></td>' +
      '</tr>';
  }).join('');

  // Suggestions
  var suggestionsDiv = document.getElementById('mapping-suggestions');
  if (mapping.suggestions && mapping.suggestions.length > 0) {
    suggestionsDiv.innerHTML =
      '<div class="mapping-summary warn" style="margin-top: 12px;">' +
      '<h4>Suggestions</h4><ul>' +
      mapping.suggestions.map(function(s) { return '<li>' + escapeHtml(s) + '</li>'; }).join('') +
      '</ul></div>';
  } else {
    suggestionsDiv.innerHTML = '';
  }

  // Data preview (first 3 rows mapped to our fields)
  renderDataPreview(mapping, data);
}

function renderDataPreview(mapping, data) {
  var table = document.getElementById('data-preview-table');
  var ourHeaders = ['ID', 'Name', 'Description', 'Icon', 'Organizer', 'Email', 'Phone'];
  var fieldKeys = ['id', 'name', 'description', 'icon', 'organizerName', 'organizerEmail', 'organizerPhone'];

  var thead = '<thead><tr>' + ourHeaders.map(function(h) { return '<th>' + escapeHtml(h) + '</th>'; }).join('') + '</tr></thead>';

  var previewRows = data.rows.slice(0, 3);
  var tbody = '<tbody>' + previewRows.map(function(row) {
    return '<tr>' + fieldKeys.map(function(key) {
      var idx = mapping.mapping[key];
      if (idx === undefined || idx < 0 || idx >= row.length) return '<td style="color:#ccc;">-</td>';
      var val = row[idx] || '';
      if (val.length > 30) val = val.substring(0, 30) + '...';
      return '<td>' + escapeHtml(val) + '</td>';
    }).join('') + '</tr>';
  }).join('') + '</tbody>';

  table.innerHTML = thead + tbody;
}

// Download formatted CSV using the AI mapping
document.getElementById('download-formatted-btn').addEventListener('click', function() {
  if (!uploadedFileData || !aiMappingResult) return;

  var outHeaders = ['ID', 'Name', 'Description', 'Icon', 'Organizer Name', 'Organizer Email', 'Organizer Phone', 'Question 1', 'Question 2', 'Question 3'];
  var fieldKeys = ['id', 'name', 'description', 'icon', 'organizerName', 'organizerEmail', 'organizerPhone', 'question1', 'question2', 'question3'];
  var m = aiMappingResult.mapping;

  function csvEscape(val) {
    val = String(val || '');
    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
      return '"' + val.replace(/"/g, '""') + '"';
    }
    return val;
  }

  function slugify(text) {
    return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
  }

  var csv = '\uFEFF'; // BOM
  csv += outHeaders.map(csvEscape).join(',') + '\n';

  uploadedFileData.rows.forEach(function(row) {
    var outRow = fieldKeys.map(function(key) {
      var idx = m[key];
      if (idx === undefined || idx < 0 || idx >= row.length) {
        // Auto-generate ID from name if missing
        if (key === 'id' && m.name >= 0 && m.name < row.length) {
          return slugify(row[m.name] || '');
        }
        return '';
      }
      return row[idx] || '';
    });
    csv += outRow.map(csvEscape).join(',') + '\n';
  });

  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'ministries-formatted.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// Test connection
var selectedSheetTab = null; // track which tab the admin picked

document.getElementById('test-connection-btn').addEventListener('click', async function() {
  var url = document.getElementById('setup-api-url').value.trim();
  var statusDiv = document.getElementById('connection-status');
  var pickerDiv = document.getElementById('sheet-tab-picker');

  if (!url) {
    statusDiv.innerHTML = '<div class="connection-status error">Please enter an API URL first.</div>';
    pickerDiv.classList.add('hidden');
    return;
  }

  statusDiv.innerHTML = '<div class="connection-status testing">Scanning your spreadsheet tabs...</div>';
  pickerDiv.classList.add('hidden');

  try {
    // Step 1: Scan all tabs in the sheet
    var controller = new AbortController();
    var timeoutId = setTimeout(function() { controller.abort(); }, 15000);
    var scanUrl = url + (url.includes('?') ? '&' : '?') + 'action=scanSheets';
    var response = await fetch(scanUrl, { signal: controller.signal });
    clearTimeout(timeoutId);
    var scanData = await response.json();

    if (scanData.error) {
      statusDiv.innerHTML = '<div class="connection-status error">&#10007; Error: ' + escapeHtml(scanData.error) + '</div>';
      return;
    }

    if (!scanData.sheets || scanData.sheets.length === 0) {
      statusDiv.innerHTML = '<div class="connection-status error">&#10007; No data sheets found. Make sure your spreadsheet has at least one tab with ministry data.</div>';
      return;
    }

    // Step 2: Show the best candidate and let admin confirm or pick another
    var best = scanData.sheets[0];
    selectedSheetTab = best.name;

    statusDiv.innerHTML =
      '<div class="connection-status success">&#10003; Connected! Found <strong>' + scanData.sheets.length +
      '</strong> tab' + (scanData.sheets.length === 1 ? '' : 's') + ' with data. ' +
      'Best match: <strong>' + escapeHtml(best.name) + '</strong> (' + best.rowCount + ' rows).</div>';

    // Render tab picker
    pickerDiv.classList.remove('hidden');
    renderSheetTabPicker(scanData.sheets, url);

  } catch(err) {
    statusDiv.innerHTML = '<div class="connection-status error">&#10007; Could not connect. Check the URL and try again.</div>';
    pickerDiv.classList.add('hidden');
  }
});

// Render the list of sheet tabs for the admin to choose from
function renderSheetTabPicker(sheets, apiUrl) {
  var listDiv = document.getElementById('sheet-tab-list');
  var previewDiv = document.getElementById('sheet-tab-preview');

  listDiv.innerHTML = '<p style="font-size: 13px; color: #666; margin-bottom: 8px; font-family: \'Inter\', sans-serif;">' +
    'Which tab has your ministry list? Pick one and we\'ll pull it in.</p>';

  sheets.forEach(function(sheet, idx) {
    var btn = document.createElement('button');
    btn.className = 'sheet-tab-btn' + (idx === 0 ? ' selected' : '');
    btn.innerHTML =
      '<div>' +
        '<span class="tab-name">' + escapeHtml(sheet.name) + '</span> ' +
        '<span class="tab-meta">' + sheet.rowCount + ' rows &middot; ' + sheet.colCount + ' columns</span>' +
      '</div>' +
      (idx === 0 ? '<span class="tab-badge">Best match</span>' : '');

    btn.addEventListener('click', function() {
      selectedSheetTab = sheet.name;
      listDiv.querySelectorAll('.sheet-tab-btn').forEach(function(b) { b.classList.remove('selected'); });
      btn.classList.add('selected');
      renderSheetPreview(sheet);
      loadFromTab(apiUrl, sheet.name);
    });

    listDiv.appendChild(btn);
  });

  // Auto-show preview of best match and load its ministries
  renderSheetPreview(sheets[0]);
  loadFromTab(apiUrl, sheets[0].name);
}

// Show a preview of the selected tab's data
function renderSheetPreview(sheet) {
  var previewDiv = document.getElementById('sheet-tab-preview');
  if (!sheet.preview || sheet.preview.length === 0) {
    previewDiv.innerHTML = '<p style="font-size: 13px; color: #888;">No preview available.</p>';
    return;
  }

  var html = '<p style="font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; font-family: \'Inter\', sans-serif;">Preview:</p>';
  html += '<div class="data-preview-scroll"><table class="sheet-preview"><thead><tr>';
  sheet.headers.forEach(function(h) {
    html += '<th>' + escapeHtml(h || '(empty)') + '</th>';
  });
  html += '</tr></thead><tbody>';
  sheet.preview.forEach(function(row) {
    html += '<tr>';
    row.forEach(function(cell) {
      html += '<td>' + escapeHtml(cell) + '</td>';
    });
    html += '</tr>';
  });
  html += '</tbody></table></div>';

  if (sheet.matchedFields && sheet.matchedFields.length > 0) {
    html += '<p style="font-size: 12px; color: #2d6a4f; margin-top: 6px; font-family: \'Inter\', sans-serif;">' +
      '&#10003; Detected fields: ' + sheet.matchedFields.join(', ') + '</p>';
  }

  previewDiv.innerHTML = html;
}

// Load ministries from a specific tab to verify the count
async function loadFromTab(apiUrl, tabName) {
  var statusDiv = document.getElementById('connection-status');
  try {
    var fetchUrl = apiUrl + (apiUrl.includes('?') ? '&' : '?') + 'action=getMinistries&sheet=' + encodeURIComponent(tabName);
    var controller = new AbortController();
    var timeoutId = setTimeout(function() { controller.abort(); }, 10000);
    var response = await fetch(fetchUrl, { signal: controller.signal });
    clearTimeout(timeoutId);
    var data = await response.json();

    if (data.ministries) {
      var count = data.ministries.length;
      statusDiv.innerHTML =
        '<div class="connection-status success">&#10003; Using tab <strong>' + escapeHtml(tabName) +
        '</strong> &mdash; found <strong>' + count + '</strong> ministr' + (count === 1 ? 'y' : 'ies') +
        '.' + (count === 0 ? ' Try picking a different tab below.' : '') + '</div>';
    }
  } catch(err) {
    // Silently fail  the tab picker is still usable
  }
}

// Step 4: Admin management
function renderAdminList() {
  var list = document.getElementById('setup-admin-list');
  var admins = loadAdmins();

  // Make sure setup admin is in the list
  if (setupAdminData && !admins.some(function(a) { return a.email === setupAdminData.email; })) {
    admins.unshift({
      email: setupAdminData.email,
      firstName: setupAdminData.firstName,
      lastName: setupAdminData.lastName,
      picture: setupAdminData.picture,
      role: 'admin'
    });
    saveAdmins(admins);
    appAdmins = admins;
  }

  list.innerHTML = admins.map(function(admin, idx) {
    var initials = escapeHtml((admin.firstName[0] || '') + (admin.lastName[0] || ''));
    var isSetupAdmin = setupAdminData && admin.email === setupAdminData.email;
    return '<div class="admin-item">' +
      '<div class="profile-icon">' + initials + '</div>' +
      '<div class="admin-item-details">' +
        '<div class="admin-item-name">' + escapeHtml(admin.firstName + ' ' + admin.lastName) + '</div>' +
        '<div class="admin-item-email">' + escapeHtml(admin.email) + '</div>' +
      '</div>' +
      (isSetupAdmin ? '<span class="admin-item-tag">You</span>' :
        '<button class="admin-remove-btn" data-idx="' + idx + '" title="Remove">&times;</button>') +
    '</div>';
  }).join('');

  // Remove buttons
  list.querySelectorAll('.admin-remove-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var admins = loadAdmins();
      admins.splice(parseInt(btn.dataset.idx), 1);
      saveAdmins(admins);
      appAdmins = admins;
      renderAdminList();
    });
  });
}

document.getElementById('setup-add-admin-btn').addEventListener('click', function() {
  var input = document.getElementById('setup-new-admin-email');
  var email = input.value.trim().toLowerCase();
  if (!email || !email.includes('@')) return;

  var admins = loadAdmins();
  if (admins.some(function(a) { return a.email.toLowerCase() === email; })) {
    input.value = '';
    return; // already exists
  }

  // Derive a readable name from the email local part
  var localPart = email.split('@')[0]
    .replace(/[._-]+/g, ' ')
    .replace(/\b\w/g, function(c) { return c.toUpperCase(); });
  var nameParts = localPart.split(' ');

  admins.push({
    email: email,
    firstName: nameParts[0] || '',
    lastName: nameParts.slice(1).join(' ') || '',
    picture: '',
    role: 'admin'
  });
  saveAdmins(admins);
  appAdmins = admins;
  input.value = '';
  renderAdminList();
});

// Step 5: Summary
function renderSummary() {
  var orgName = document.getElementById('setup-org-name').value || '(not set)';
  var appTitle = document.getElementById('setup-app-title').value || 'Ministry Fair';
  var tagline = document.getElementById('setup-tagline').value || 'Find your place to serve';
  var apiUrl = document.getElementById('setup-api-url').value || '(not set)';
  var sheetUrl = document.getElementById('setup-sheet-url').value || '(not set)';
  var adminCount = loadAdmins().length;

  document.getElementById('setup-summary').innerHTML =
    '<div class="summary-row"><span class="summary-label">Organization</span><span class="summary-value">' + escapeHtml(orgName) + '</span></div>' +
    '<div class="summary-row"><span class="summary-label">App Title</span><span class="summary-value">' + escapeHtml(appTitle) + '</span></div>' +
    '<div class="summary-row"><span class="summary-label">Tagline</span><span class="summary-value">' + escapeHtml(tagline) + '</span></div>' +
    '<div class="summary-row"><span class="summary-label">Theme</span><span class="summary-value"><span style="display:inline-block;width:20px;height:20px;border-radius:4px;vertical-align:middle;background:' + escapeHtml(appConfig.primaryColor) + '"></span></span></div>' +
    '<div class="summary-row"><span class="summary-label">API URL</span><span class="summary-value">' + escapeHtml(apiUrl.length > 30 ? apiUrl.substring(0, 30) + '...' : apiUrl) + '</span></div>' +
    '<div class="summary-row"><span class="summary-label">Admins</span><span class="summary-value">' + adminCount + '</span></div>';
}

// Wizard navigation
document.getElementById('step1-next').addEventListener('click', function() { showWizardStep(2); });
document.getElementById('step2-back').addEventListener('click', function() { showWizardStep(1); });
document.getElementById('step2-next').addEventListener('click', function() { showWizardStep(3); });
document.getElementById('step3-back').addEventListener('click', function() { showWizardStep(2); });
document.getElementById('step3-next').addEventListener('click', function() { showWizardStep(4); });
document.getElementById('step4-back').addEventListener('click', function() { showWizardStep(3); });
document.getElementById('step4-next').addEventListener('click', function() { showWizardStep(5); });
document.getElementById('step5-back').addEventListener('click', function() { showWizardStep(4); });

// Launch!
document.getElementById('launch-btn').addEventListener('click', function() {
  // 
  // FUTURE: Payment step hook
  // Uncomment and implement when ready to add billing:
  //
  // if (!appConfig.paymentComplete) {
  //   showPaymentStep({
  //     organizationName: document.getElementById('setup-org-name').value,
  //     adminEmail: setupAdminData ? setupAdminData.email : '',
  //     detectedOrg: detectedOrg,
  //     onComplete: function() {
  //       appConfig.paymentComplete = true;
  //       // continue with launch below
  //     }
  //   });
  //   return;
  // }
  // 

  // Save all config
  appConfig.organizationName = document.getElementById('setup-org-name').value || '';
  appConfig.appTitle = document.getElementById('setup-app-title').value || 'Ministry Fair';
  appConfig.tagline = document.getElementById('setup-tagline').value || 'Find your place to serve';
  appConfig.apiUrl = document.getElementById('setup-api-url').value || '';
  appConfig.spreadsheetUrl = document.getElementById('setup-sheet-url').value || '';
  if (selectedSheetTab) appConfig.ministriesSheetTab = selectedSheetTab;
  var enteredKey = document.getElementById('setup-api-key').value || '';
  setApiKey(enteredKey); // session-only backup
  appConfig.orgDomain = setupAdminData ? getDomain(setupAdminData.email) : '';
  appConfig.detectedOrg = detectedOrg || null;
  appConfig.setupComplete = true;
  saveAppConfig(appConfig);

  // Create admin session
  if (setupAdminData) {
    currentSession = {
      email: setupAdminData.email,
      firstName: setupAdminData.firstName,
      lastName: setupAdminData.lastName,
      picture: setupAdminData.picture,
      role: 'admin'
    };
    saveSession(currentSession);
  }

  // Save default notification settings
  saveNotificationSettings(notificationSettings);

  // Send API key to GAS for secure server-side storage
  if (enteredKey && appConfig.apiUrl) {
    fetch(appConfig.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'store-api-key', apiKey: enteredKey })
    }).then(function() {
      // Key stored server-side; clear from session
      setApiKey('');
    }).catch(function(err) {
      console.warn('Could not store API key server-side, keeping in session:', err);
    });
  }

  // Apply config and load the app
  applyConfig();
  loadMinistries().then(function() {
    // After loading, auto-assign icons to ministries that need them
    autoAssignIconsIfNeeded();
    // Check for ministry leads and offer to notify them
    showLeadInviteSummary();
  });
});

// After setup, show a summary of ministry leads who should be invited to sign in
function showLeadInviteSummary() {
  if (!MINISTRIES.length) return;

  var leads = [];
  var seen = {};
  MINISTRIES.forEach(function(m) {
    if (m.organizerEmail && !seen[m.organizerEmail.toLowerCase()]) {
      seen[m.organizerEmail.toLowerCase()] = true;
      leads.push({
        name: m.organizerName || '(no name)',
        email: m.organizerEmail,
        phone: m.organizerPhone || '',
        ministry: m.name
      });
    }
  });

  if (leads.length === 0) return;

  // Build a mailto link for bulk invitation
  var siteUrl = window.location.origin + window.location.pathname;
  var orgName = appConfig.organizationName || 'our organization';
  var subject = encodeURIComponent('You\'re invited to ' + (appConfig.appTitle || 'Ministry Fair'));
  var body = encodeURIComponent(
    'Hi,\n\n' +
    'You\'ve been listed as a ministry lead at ' + orgName + '. ' +
    'Please sign in to review your ministry and complete your profile:\n\n' +
    siteUrl + '\n\n' +
    'Thank you!'
  );
  var emailList = leads.map(function(l) { return l.email; }).join(',');

  var html =
    '<div class="connection-status success" style="flex-direction: column; align-items: flex-start; margin-top: 16px;">' +
    '<h4 style="margin: 0 0 8px 0; font-size: 15px;">&#128233; Ministry Leads Found</h4>' +
    '<p style="font-size: 13px; color: #555; margin: 0 0 10px 0;">' +
    'We found <strong>' + leads.length + '</strong> ministry lead' + (leads.length === 1 ? '' : 's') +
    ' in your data. Encourage them to sign in so they can manage their ministry and complete their profile.</p>' +
    '<div style="max-height: 150px; overflow-y: auto; width: 100%; margin-bottom: 10px;">';

  leads.forEach(function(lead) {
    html += '<div style="font-size: 13px; padding: 4px 0; border-bottom: 1px solid #e8e4de;">' +
      '<strong>' + escapeHtml(lead.name) + '</strong> &mdash; ' +
      escapeHtml(lead.email) +
      (lead.phone ? ' &middot; ' + escapeHtml(lead.phone) : ' <span style="color: #c53030;">(no phone)</span>') +
      ' <span style="color: #888;">(' + escapeHtml(lead.ministry) + ')</span>' +
      '</div>';
  });

  html += '</div>' +
    '<a href="mailto:' + emailList + '?subject=' + subject + '&body=' + body + '" ' +
    'class="btn-secondary" style="font-size: 13px; padding: 8px 16px; text-decoration: none; display: inline-block;">&#9993; Email All Leads</a>' +
    '</div>';

  // Insert into the admin dashboard or show as a banner
  var statusDiv = document.getElementById('connection-status');
  if (statusDiv) {
    statusDiv.insertAdjacentHTML('afterend', html);
  }
}

// ============================================
// SETTINGS VIEW
// ============================================
function showSettingsView() {
  showView('settings');
  var role = currentSession ? getUserRole(currentSession.email) : 'parishioner';

  // Show/hide admin sections
  document.getElementById('settings-admin-sections').classList.toggle('hidden', role !== 'admin');

  // Populate current values
  document.getElementById('settings-org-name-val').textContent = appConfig.organizationName || '(not set)';
  document.getElementById('settings-app-title-val').textContent = appConfig.appTitle || 'Ministry Fair';
  document.getElementById('settings-color-swatch').style.background = appConfig.primaryColor;

  // API/sheet status
  document.getElementById('settings-api-status').textContent = appConfig.apiUrl ? 'Connected' : 'Not configured';
  document.getElementById('settings-sheet-status').textContent = appConfig.spreadsheetUrl ? 'Linked' : 'Not set';
  // Check server-side key status
  var keyStatusEl = document.getElementById('settings-claude-key-status');
  var sessionKey = getApiKey();
  keyStatusEl.textContent = sessionKey ? 'Session key active' : 'Checking server...';
  if (appConfig.apiUrl) {
    fetch(appConfig.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'check-api-key' })
    }).then(function(r) { return r.json(); }).then(function(data) {
      if (data.hasKey) {
        keyStatusEl.textContent = 'Stored securely on server';
        keyStatusEl.style.color = '#4a9c6d';
      } else if (sessionKey) {
        keyStatusEl.textContent = 'Session only (not on server)';
        keyStatusEl.style.color = '#a04000';
      } else {
        keyStatusEl.textContent = 'Not configured';
        keyStatusEl.style.color = '';
      }
    }).catch(function() {
      keyStatusEl.textContent = sessionKey ? 'Session only (server unreachable)' : 'Not configured';
    });
  } else {
    keyStatusEl.textContent = sessionKey ? 'Session only (no API URL)' : 'Not configured';
  }

  // User info
  if (currentSession) {
    document.getElementById('settings-user-name').textContent = currentSession.firstName + ' ' + currentSession.lastName;
    document.getElementById('settings-user-email').textContent = currentSession.email;
  } else if (hasSavedProfile()) {
    document.getElementById('settings-user-name').textContent = profile.firstName + ' ' + profile.lastName;
    document.getElementById('settings-user-email').textContent = profile.email;
  }

  // Admin list
  if (role === 'admin') {
    var adminsCard = document.getElementById('settings-admins-card');
    var admins = loadAdmins();
    adminsCard.innerHTML = admins.map(function(admin) {
      var initials = escapeHtml((admin.firstName[0] || '') + (admin.lastName[0] || ''));
      var isMe = currentSession && admin.email.toLowerCase() === currentSession.email.toLowerCase();
      return '<div class="settings-item">' +
        '<div style="display:flex;align-items:center;gap:10px;">' +
          '<div class="profile-icon" style="width:32px;height:32px;font-size:12px;">' + initials + '</div>' +
          '<div class="settings-item-left">' +
            '<div class="settings-item-label">' + escapeHtml(admin.firstName + ' ' + admin.lastName) + (isMe ? ' (you)' : '') + '</div>' +
            '<div class="settings-item-desc">' + escapeHtml(admin.email) + '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }).join('');

    // Notification toggles
    var ns = loadNotificationSettings();
    document.getElementById('toggle-email').className = 'toggle-switch' + (ns.emailEnabled ? ' on' : '');
    document.getElementById('toggle-text').className = 'toggle-switch' + (ns.textEnabled ? ' on' : '');

    // Email templates
    renderEmailTemplates();
  }
}

// Settings item click handlers (editable fields)
document.getElementById('settings-org-name-item').addEventListener('click', function() {
  var val = prompt('Organization Name:', appConfig.organizationName || '');
  if (val !== null) {
    appConfig.organizationName = val;
    saveAppConfig(appConfig);
    applyConfig();
    showSettingsView();
  }
});

document.getElementById('settings-app-title-item').addEventListener('click', function() {
  var val = prompt('App Title:', appConfig.appTitle || '');
  if (val !== null) {
    appConfig.appTitle = val;
    saveAppConfig(appConfig);
    applyConfig();
    showSettingsView();
  }
});

document.getElementById('settings-api-item').addEventListener('click', function() {
  var val = prompt('Google Apps Script API URL:', appConfig.apiUrl || '');
  if (val !== null) {
    appConfig.apiUrl = val;
    saveAppConfig(appConfig);
    showSettingsView();
  }
});

document.getElementById('settings-sheet-item').addEventListener('click', function() {
  var val = prompt('Google Sheet URL:', appConfig.spreadsheetUrl || '');
  if (val !== null) {
    appConfig.spreadsheetUrl = val;
    saveAppConfig(appConfig);
    showSettingsView();
  }
});

document.getElementById('settings-claude-key-item').addEventListener('click', function() {
  var current = getApiKey();
  var val = prompt('Claude API Key:\n\nIf your API URL is configured, this key will be sent to your server for secure storage. Otherwise it is kept in this browser session only.', current || '');
  if (val !== null && val.trim()) {
    setApiKey(val.trim());
    // Try to store on server
    if (appConfig.apiUrl) {
      fetch(appConfig.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'store-api-key', apiKey: val.trim() })
      }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.success) {
          setApiKey(''); // Clear from session since server has it
          alert('API key stored securely on server.');
        }
        showSettingsView();
      }).catch(function() {
        alert('Could not reach server. Key stored in this session only.');
        showSettingsView();
      });
    } else {
      showSettingsView();
    }
  } else if (val !== null) {
    setApiKey('');
    showSettingsView();
  }
});

function renderEmailTemplates() {
  var ns = loadNotificationSettings();
  var container = document.getElementById('settings-email-templates');
  var html = '';
  var keys = Object.keys(ns.templates);
  keys.forEach(function(key) {
    var t = ns.templates[key];
    html += '<div class="template-card">' +
      '<h4>' + escapeHtml(t.name) + '</h4>' +
      '<p>Subject: ' + escapeHtml(t.subject) + '</p>' +
      '<textarea data-template-key="' + escapeHtml(key) + '">' + escapeHtml(t.body) + '</textarea>' +
    '</div>';
  });
  container.innerHTML = html;

  // Save on change
  container.querySelectorAll('textarea').forEach(function(ta) {
    ta.addEventListener('change', function() {
      var ns = loadNotificationSettings();
      ns.templates[ta.dataset.templateKey].body = ta.value;
      saveNotificationSettings(ns);
    });
  });
}

// Toggle switches
document.querySelectorAll('.toggle-switch').forEach(function(toggle) {
  toggle.addEventListener('click', function() {
    toggle.classList.toggle('on');
    var ns = loadNotificationSettings();
    ns[toggle.dataset.key] = toggle.classList.contains('on');
    saveNotificationSettings(ns);
  });
});

// Settings back button
document.getElementById('settings-back-btn').addEventListener('click', function() {
  showMinistriesList();
});

// Settings logout
document.getElementById('settings-logout-item').addEventListener('click', function() {
  if (confirm('Are you sure you want to log out?')) {
    currentSession = null;
    saveSession(null);
    localStorage.removeItem('ministry-fair-profile');
    localStorage.removeItem('ministry-fair-interests');
    profile = { firstName: '', lastName: '', email: '', phone: '', wantsToJoinParish: false };
    interests = [];
    currentMinistry = null;
    showAll = false;
    searchTerm = '';
    showView('register');
  }
});

// ============================================
// APPLY CONFIGURATION
// ============================================
function applyConfig() {
  document.title = appConfig.appTitle || 'Ministry Fair';

  document.querySelectorAll('.app-title').forEach(function(el) {
    el.textContent = appConfig.appTitle || 'Ministry Fair';
  });
  document.querySelectorAll('.app-tagline').forEach(function(el) {
    el.textContent = appConfig.tagline || 'Find your place to serve';
  });

  var consentText = document.getElementById('consentText');
  if (consentText) {
    consentText.textContent = 'By clicking Continue, you give ' + (appConfig.organizationName || 'us') + ' permission to contact you by email or phone about the ministries you express interest in.';
  }

  var joinLabel = document.getElementById('joinParishLabel');
  if (joinLabel) {
    joinLabel.textContent = "I'm not yet a parishioner but I'd like to join " + (appConfig.organizationName || 'the parish') + '.';
  }

  // Apply theme color to headers
  document.querySelectorAll('.header').forEach(function(h) {
    h.style.background = 'linear-gradient(135deg, ' + appConfig.primaryColor + ' 0%, ' + appConfig.primaryColorDark + ' 100%)';
  });
  // Apply to buttons
  document.querySelectorAll('.btn:not(.btn-green)').forEach(function(b) {
    b.style.background = 'linear-gradient(135deg, ' + appConfig.primaryColor + ' 0%, ' + appConfig.primaryColorDark + ' 100%)';
  });
  document.querySelectorAll('.btn-secondary').forEach(function(b) {
    b.style.color = appConfig.primaryColor;
    b.style.borderColor = appConfig.primaryColor;
  });
}

// ============================================
// FETCH MINISTRIES
// ============================================
async function loadMinistries() {
  var apiUrl = appConfig.apiUrl;
  if (!apiUrl) {
    MINISTRIES = FALLBACK_MINISTRIES;
    initializeApp();
    return;
  }

  try {
    var controller = new AbortController();
    var timeoutId = setTimeout(function() { controller.abort(); }, 10000);
    var fetchUrl = apiUrl;
    if (appConfig.ministriesSheetTab) {
      fetchUrl += (apiUrl.includes('?') ? '&' : '?') + 'action=getMinistries&sheet=' + encodeURIComponent(appConfig.ministriesSheetTab);
    }
    var response = await fetch(fetchUrl, { signal: controller.signal });
    clearTimeout(timeoutId);
    var data = await response.json();
    if (data.ministries && data.ministries.length > 0) {
      MINISTRIES = data.ministries;
    } else {
      MINISTRIES = FALLBACK_MINISTRIES;
    }
  } catch (error) {
    console.error('Error loading ministries:', error);
    MINISTRIES = FALLBACK_MINISTRIES;
  }

  // Clean up stale interests referencing deleted ministries
  var validIds = new Set(MINISTRIES.map(function(m) { return m.id; }));
  var cleanInterests = interests.filter(function(i) { return validIds.has(i.ministryId); });
  if (cleanInterests.length !== interests.length) {
    interests = cleanInterests;
    localStorage.setItem('ministry-fair-interests', JSON.stringify(interests));
  }

  initializeApp();
}

// ============================================
// APP INITIALIZATION
// ============================================
function initializeApp() {
  // Follow-up questionnaire link takes priority (works without registration)
  if (followupParam) {
    showFollowupForm(followupParam);
    return;
  }

  if (hasSavedProfile()) {
    // Check if this user is an admin and auto-create session
    if (isAdmin(profile.email) && !currentSession) {
      currentSession = {
        email: profile.email,
        firstName: profile.firstName,
        lastName: profile.lastName,
        picture: '',
        role: 'admin'
      };
      saveSession(currentSession);
    }

    if (ministryParam) {
      currentMinistry = MINISTRIES.find(function(m) { return m.id === ministryParam; });
      if (currentMinistry) {
        showMinistryDetail(currentMinistry);
      } else {
        showMinistriesList();
      }
    } else {
      showMinistriesList();
    }

    // Prompt ministry leads for missing info (e.g. phone) on first visit
    if (currentSession && isMinistryLead(currentSession.email)) {
      checkMissingInfo(currentSession.email);
    }
  } else {
    showView('register');
  }
}

// ============================================
// THEME (LIGHT / DARK MODE)
// ============================================
function initTheme() {
  var saved = localStorage.getItem('mf-theme');
  // Default to light for parish use
  var theme = saved || 'light';
  applyTheme(theme);
}

function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.classList.add('dark');
  } else {
    document.body.classList.remove('dark');
  }
  // Update toggle icon: sun for dark mode (click to go light), moon for light mode
  var btn = document.getElementById('theme-toggle');
  btn.textContent = theme === 'dark' ? '\u2600' : '\u263D';
  btn.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
  localStorage.setItem('mf-theme', theme);
}

document.getElementById('theme-toggle').addEventListener('click', function() {
  var isDark = document.body.classList.contains('dark');
  applyTheme(isDark ? 'light' : 'dark');
});

// Apply theme immediately (before boot to avoid flash)
initTheme();

// ============================================
// BOOT SEQUENCE
// ============================================
function boot() {
  var hash = window.location.hash;

  // Admins can access wizard directly via #/start
  if (hash === '#/start' && currentSession && getUserRole(currentSession.email) === 'admin') {
    applyConfig();
    showView('start');
    showWizardStep(1);
    return;
  }

  // If #/settings, show settings (if admin)
  if (hash === '#/settings' && currentSession && getUserRole(currentSession.email) === 'admin') {
    applyConfig();
    loadMinistries().then(function() {
      showSettingsView();
    }).catch(function() {
      showSettingsView();
    });
    return;
  }

  // If #/admin, show admin dashboard
  if (hash === '#/admin' && currentSession && getUserRole(currentSession.email) === 'admin') {
    applyConfig();
    loadMinistries().then(function() {
      showAdminDashboard();
    }).catch(function() {
      showAdminDashboard();
    });
    return;
  }

  // Normal boot
  applyConfig();
  loadMinistries();
}

// Apply phone formatting
var phoneInput = document.getElementById('phone');
if (phoneInput) {
  phoneInput.addEventListener('input', function(e) {
    e.target.value = formatPhoneNumber(e.target.value);
  });
}

// Register form
document.getElementById('register-form').addEventListener('submit', function(e) {
  e.preventDefault();
  var photoUrl = document.getElementById('register-form').dataset.photoUrl || '';
  profile = {
    firstName: document.getElementById('firstName').value,
    lastName: document.getElementById('lastName').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    wantsToJoinParish: document.getElementById('joinParish').checked,
    photoURL: photoUrl
  };
  localStorage.setItem('ministry-fair-profile', JSON.stringify(profile));

  // Check roles  same logic as Google sign-in
  var email = profile.email;
  var domain = getDomain(email);
  var roles = ['parishioner'];
  if (isAdmin(email)) roles.push('admin');
  if (isMinistryLead(email)) roles.push('leader');
  if (!appConfig.setupComplete && emailMatchesSiteDomain(email) && !isConsumerDomain(domain)) {
    roles.push('setup_admin');
  }

  if (roles.length > 1) {
    showRolePicker(roles, {
      email: email,
      firstName: profile.firstName,
      lastName: profile.lastName,
      picture: photoUrl
    });
    return;
  }

  // Just a parishioner  continue
  if (ministryParam) {
    currentMinistry = MINISTRIES.find(function(m) { return m.id === ministryParam; });
    if (currentMinistry) {
      showMinistryDetail(currentMinistry);
      return;
    }
  }
  showMinistriesList();
});

// ============================================
// MINISTRY LIST
// ============================================
function showMinistriesList() {
  showView('ministries');

  // Hide parishioner profile badge if admin (they have the nav)
  var profileBadge = document.getElementById('parishioner-profile-badge');
  if (currentSession && getUserRole(currentSession.email) === 'admin') {
    profileBadge.classList.add('hidden');
  } else {
    profileBadge.classList.remove('hidden');
    var initialsEl = document.getElementById('profile-initials');
    var photoEl = document.getElementById('profile-photo');
    if (profile.photoURL) {
      initialsEl.classList.add('hidden');
      photoEl.src = profile.photoURL;
      photoEl.classList.remove('hidden');
    } else {
      initialsEl.textContent = (profile.firstName[0] || '') + (profile.lastName[0] || '');
      initialsEl.classList.remove('hidden');
      photoEl.classList.add('hidden');
    }
    document.getElementById('profile-name').textContent = profile.firstName + ' ' + profile.lastName;
    document.getElementById('profile-email').textContent = profile.email;
    document.getElementById('profile-phone').textContent = formatPhoneNumber(profile.phone);
  }

  var count = interests.length;
  document.getElementById('interest-count').textContent = count > 0
    ? count + ' interest' + (count > 1 ? 's' : '') + ' expressed'
    : 'Tap a ministry to learn more';

  var searchInput = document.getElementById('ministry-search');
  searchInput.value = searchTerm;
  searchInput.oninput = function() {
    searchTerm = this.value.toLowerCase();
    renderMinistryList();
  };

  renderMinistryList();
}

function renderMinistryList() {
  var list = document.getElementById('ministry-list');

  var filtered = MINISTRIES;
  if (searchTerm) {
    filtered = MINISTRIES.filter(function(m) {
      return m.name.toLowerCase().includes(searchTerm) ||
        m.description.toLowerCase().includes(searchTerm) ||
        (m.organizerName && m.organizerName.toLowerCase().includes(searchTerm));
    });
  }

  var sorted = filtered.slice().sort(function(a, b) {
    var aI = interests.some(function(i) { return i.ministryId === a.id; });
    var bI = interests.some(function(i) { return i.ministryId === b.id; });
    if (aI && !bI) return -1;
    if (!aI && bI) return 1;
    return a.name.localeCompare(b.name);
  });

  var displayed = (showAll || searchTerm) ? sorted : sorted.slice(0, 5);

  if (displayed.length === 0) {
    list.innerHTML = '<div class="no-results">No ministries found matching "' + escapeHtml(searchTerm) + '"</div>';
  } else {
    list.innerHTML = displayed.map(function(m) {
      var interested = interests.some(function(i) { return i.ministryId === m.id; });
      return '<div class="ministry-card ' + (interested ? 'interested' : '') + '" data-id="' + escapeHtml(m.id) + '">' +
        '<div class="ministry-icon">' + escapeHtml(m.icon) + '</div>' +
        '<div class="ministry-info">' +
          '<h3 class="ministry-name">' + escapeHtml(m.name) + '</h3>' +
          '<p class="ministry-desc">' + escapeHtml(m.description) + '</p>' +
        '</div>' +
        (interested ? '<span class="badge">Interested</span>' : '') +
      '</div>';
    }).join('');
  }

  var showAllBtn = document.getElementById('show-all-btn');
  if (!showAll && !searchTerm && MINISTRIES.length > 5) {
    showAllBtn.classList.remove('hidden');
    showAllBtn.textContent = 'Show All ' + MINISTRIES.length + ' Ministries';
  } else {
    showAllBtn.classList.add('hidden');
  }

  list.querySelectorAll('.ministry-card').forEach(function(card) {
    card.addEventListener('click', function() {
      var ministry = MINISTRIES.find(function(m) { return m.id === card.dataset.id; });
      showMinistryDetail(ministry);
    });
  });
}

document.getElementById('show-all-btn').addEventListener('click', function() {
  showAll = true;
  renderMinistryList();
});

// ============================================
// MINISTRY DETAIL
// ============================================
function showMinistryDetail(ministry) {
  currentMinistry = ministry;
  showView('detail');

  document.getElementById('detail-name').textContent = ministry.name;
  document.getElementById('detail-icon').textContent = ministry.icon;
  document.getElementById('detail-desc').textContent = ministry.description;

  var questionsDiv = document.getElementById('detail-questions');
  if (ministry.questions && ministry.questions.length > 0) {
    questionsDiv.innerHTML = '<div class="form">' + ministry.questions.map(function(q) {
      if (q.type === 'select') {
        return '<div class="input-group">' +
          '<label class="label">' + escapeHtml(q.label) + '</label>' +
          '<select class="select" data-qid="' + escapeHtml(q.id) + '">' +
            '<option value="">Select...</option>' +
            q.options.map(function(opt) { return '<option value="' + escapeHtml(opt) + '">' + escapeHtml(opt) + '</option>'; }).join('') +
          '</select></div>';
      } else if (q.type === 'checkbox') {
        return '<div class="input-group">' +
          '<label class="label">' + escapeHtml(q.label) + '</label>' +
          '<div class="checkbox-options" data-qid="' + escapeHtml(q.id) + '" data-type="checkbox">' +
            q.options.map(function(opt, idx) {
              return '<div class="checkbox-option">' +
                '<input type="checkbox" id="q-' + escapeHtml(q.id) + '-' + idx + '" value="' + escapeHtml(opt) + '">' +
                '<label for="q-' + escapeHtml(q.id) + '-' + idx + '">' + escapeHtml(opt) + '</label></div>';
            }).join('') +
          '</div></div>';
      } else {
        return '<div class="input-group">' +
          '<label class="label">' + escapeHtml(q.label) + '</label>' +
          '<input type="text" class="input" data-qid="' + escapeHtml(q.id) + '" placeholder="Your answer">' +
        '</div>';
      }
    }).join('') + '</div>';
  } else {
    questionsDiv.innerHTML = '';
  }

  var interestBtn = document.getElementById('interest-btn');
  var removeBtn = document.getElementById('remove-btn');
  var alreadyInterested = interests.some(function(i) { return i.ministryId === ministry.id; });

  interestBtn.textContent = alreadyInterested ? ' Update Interest' : "I'm Interested!";
  interestBtn.className = alreadyInterested ? 'btn btn-green' : 'btn';

  if (alreadyInterested) {
    removeBtn.classList.remove('hidden');
  } else {
    removeBtn.classList.add('hidden');
  }
}

document.getElementById('back-btn').addEventListener('click', function() {
  currentMinistry = null;
  showMinistriesList();
});

// Remove interest
document.getElementById('remove-btn').addEventListener('click', function() {
  document.getElementById('modal-ministry-name').textContent = currentMinistry.name;
  document.getElementById('confirm-modal').classList.remove('hidden');
});

document.getElementById('modal-cancel').addEventListener('click', function() {
  document.getElementById('confirm-modal').classList.add('hidden');
});

document.querySelector('.modal-backdrop').addEventListener('click', function() {
  document.getElementById('confirm-modal').classList.add('hidden');
});

document.getElementById('modal-confirm').addEventListener('click', function() {
  var apiUrl = appConfig.apiUrl;
  if (apiUrl) {
    var payload = {
      firstName: profile.firstName,
      lastName: profile.lastName,
      email: profile.email,
      phone: profile.phone,
      wantsToJoinParish: profile.wantsToJoinParish || false,
      ministry: currentMinistry.name,
      action: 'Removed'
    };
    fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).catch(function(err) { console.error('API error:', err); });
  }

  interests = interests.filter(function(i) { return i.ministryId !== currentMinistry.id; });
  localStorage.setItem('ministry-fair-interests', JSON.stringify(interests));
  document.getElementById('confirm-modal').classList.add('hidden');
  currentMinistry = null;
  showMinistriesList();
});

// Submit interest
document.getElementById('interest-btn').addEventListener('click', async function() {
  var btn = this;
  var originalText = btn.textContent;

  try {
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    var answers = {};
    document.querySelectorAll('#detail-questions [data-qid]:not([data-type="checkbox"])').forEach(function(el) {
      answers[el.dataset.qid] = el.value;
    });
    document.querySelectorAll('#detail-questions [data-type="checkbox"]').forEach(function(group) {
      var qid = group.dataset.qid;
      var checked = [];
      group.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) {
        checked.push(cb.value);
      });
      answers[qid] = checked.join(', ');
    });

    var questions = currentMinistry.questions || [];
    var payload = {
      firstName: profile.firstName,
      lastName: profile.lastName,
      email: profile.email,
      phone: profile.phone,
      wantsToJoinParish: profile.wantsToJoinParish || false,
      ministry: currentMinistry.name,
      action: 'Signup',
      q1: questions[0] ? answers[questions[0].id] || '' : '',
      q2: questions[1] ? answers[questions[1].id] || '' : '',
      q3: questions[2] ? answers[questions[2].id] || '' : ''
    };

    var apiUrl = appConfig.apiUrl;
    if (apiUrl) {
      try {
        var response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        var result = await response.json();
        if (result.success === false) {
          console.warn('Server reported error:', result.error);
        }
      } catch(err) { console.error('API error:', err); }
    }

    var newInterest = {
      ministryId: currentMinistry.id,
      ministryName: currentMinistry.name,
      answers: answers,
      timestamp: new Date().toISOString()
    };

    interests = interests.filter(function(i) { return i.ministryId !== currentMinistry.id; });
    interests.push(newInterest);
    localStorage.setItem('ministry-fair-interests', JSON.stringify(interests));

    btn.disabled = false;
    showConfirmation();

  } catch (error) {
    console.error('Error submitting interest:', error);
    alert('Something went wrong. Please try again.');
    btn.disabled = false;
    btn.textContent = originalText;
  }
});

// ============================================
// CONFIRMATION
// ============================================
function showConfirmation() {
  if (!currentMinistry) {
    showMinistriesList();
    return;
  }

  showView('confirmed');
  document.getElementById('confirmed-ministry').textContent = currentMinistry.name;

  var organizerDiv = document.getElementById('organizer-info');
  if (currentMinistry.organizerName) {
    var contactHtml = '';
    if (currentMinistry.organizerEmail && isValidEmail(currentMinistry.organizerEmail)) {
      contactHtml += '<a href="mailto:' + escapeHtml(currentMinistry.organizerEmail) + '">' + escapeHtml(currentMinistry.organizerEmail) + '</a>';
    } else if (currentMinistry.organizerEmail) {
      contactHtml += escapeHtml(currentMinistry.organizerEmail);
    }
    if (currentMinistry.organizerPhone) {
      if (contactHtml) contactHtml += ' &middot; ';
      var formattedPhone = formatPhoneNumber(currentMinistry.organizerPhone);
      contactHtml += '<a href="tel:' + escapeHtml(currentMinistry.organizerPhone) + '">' + escapeHtml(formattedPhone) + '</a>';
    }

    organizerDiv.innerHTML =
      '<div class="organizer-box">' +
        '<div class="organizer-title">Ministry Contact</div>' +
        '<div class="organizer-name">' + escapeHtml(currentMinistry.organizerName) + '</div>' +
        (contactHtml ? '<div class="organizer-contact">' + contactHtml + '</div>' : '') +
      '</div>';
  } else {
    organizerDiv.innerHTML = '';
  }

  var listDiv = document.getElementById('interests-list');
  if (interests.length > 0) {
    listDiv.innerHTML = '<h3 class="section-title" style="font-size: 18px;">Your Interests Today</h3>' +
      interests.map(function(i) {
        var m = MINISTRIES.find(function(min) { return min.id === i.ministryId; });
        return '<div class="ministry-card" style="cursor: default;">' +
          '<div class="ministry-icon">' + (m ? escapeHtml(m.icon) : '&#128203;') + '</div>' +
          '<div class="ministry-info"><h3 class="ministry-name">' + escapeHtml(i.ministryName) + '</h3></div>' +
          '<span class="badge">&#10003;</span></div>';
      }).join('');
  } else {
    listDiv.innerHTML = '';
  }
}

document.getElementById('explore-btn').addEventListener('click', function() {
  currentMinistry = null;
  showMinistriesList();
});

// Parishioner logout (on ministries view)
document.getElementById('logout-btn').addEventListener('click', function() {
  if (confirm('Are you sure you want to log out? Your interest selections on this device will be cleared.')) {
    localStorage.removeItem('ministry-fair-profile');
    localStorage.removeItem('ministry-fair-interests');
    profile = { firstName: '', lastName: '', email: '', phone: '', wantsToJoinParish: false };
    interests = [];
    currentMinistry = null;
    currentSession = null;
    saveSession(null);
    showAll = false;
    searchTerm = '';
    showView('register');
  }
});

// ============================================
// ADMIN DASHBOARD
// ============================================
var adminSignups = [];
var adminNewParishioners = [];
var adminUsersList = [];
var editingMinistryId = null;

function showAdminDashboard(tab) {
  showView('admin');
  if (tab) switchAdminTab(tab);
  else switchAdminTab('signups');
}

function switchAdminTab(tabName) {
  document.querySelectorAll('.admin-tab').forEach(function(t) {
    t.classList.toggle('active', t.dataset.tab === tabName);
  });
  ['signups','new-parishioners','ministries','users','manual-entry','qr-codes'].forEach(function(t) {
    var el = document.getElementById('admin-tab-' + t);
    if (el) el.classList.toggle('hidden', t !== tabName);
  });

  if (tabName === 'signups') loadAdminSignups();
  if (tabName === 'new-parishioners') loadAdminNewParishioners();
  if (tabName === 'ministries') renderAdminMinistries();
  if (tabName === 'users') loadAdminUsers();
  if (tabName === 'manual-entry') initManualEntryTab();
  if (tabName === 'qr-codes') renderQRCodes();
}

document.getElementById('admin-tabs').addEventListener('click', function(e) {
  if (e.target.classList.contains('admin-tab')) {
    switchAdminTab(e.target.dataset.tab);
  }
});

// Signups tab
async function loadAdminSignups() {
  var email = currentSession ? currentSession.email : '';
  var apiUrl = appConfig.apiUrl;
  if (!apiUrl || !email) return;

  try {
    var resp = await fetch(apiUrl + '?action=getSignups&email=' + encodeURIComponent(email));
    var data = await resp.json();
    adminSignups = data.signups || [];
    renderAdminSignupsTable();
  } catch(e) {
    console.error('Error loading signups:', e);
  }
}

function renderAdminSignupsTable(filter) {
  var filtered = adminSignups;
  if (filter) {
    var term = filter.toLowerCase();
    filtered = adminSignups.filter(function(s) {
      return (s.firstName + ' ' + s.lastName).toLowerCase().includes(term) ||
        (s.email || '').toLowerCase().includes(term) ||
        (s.ministry || '').toLowerCase().includes(term);
    });
  }

  document.getElementById('admin-signups-stat').textContent = filtered.length + ' signup' + (filtered.length !== 1 ? 's' : '');

  if (filtered.length === 0) {
    document.getElementById('admin-signups-table').classList.add('hidden');
    document.getElementById('admin-signups-empty').classList.remove('hidden');
    return;
  }

  document.getElementById('admin-signups-table').classList.remove('hidden');
  document.getElementById('admin-signups-empty').classList.add('hidden');

  document.getElementById('admin-signups-body').innerHTML = filtered.map(function(s) {
    return '<tr>' +
      '<td>' + escapeHtml(s.date) + '</td>' +
      '<td>' + escapeHtml(s.firstName + ' ' + s.lastName) + '</td>' +
      '<td>' + escapeHtml(s.email) + '</td>' +
      '<td>' + escapeHtml(s.phone) + '</td>' +
      '<td>' + escapeHtml(s.ministry) + '</td>' +
      '<td>' + escapeHtml(s.action || 'Signup') + '</td>' +
      '<td>' + escapeHtml(s.newParishioner) + '</td>' +
      '</tr>';
  }).join('');
}

document.getElementById('admin-signups-search').addEventListener('input', function() {
  renderAdminSignupsTable(this.value);
});

document.getElementById('export-signups-btn').addEventListener('click', function() {
  exportToCsv('signups', adminSignups, ['date','time','firstName','lastName','email','phone','ministry','action','newParishioner','q1','q2','q3']);
});

// New Parishioners tab
async function loadAdminNewParishioners() {
  var email = currentSession ? currentSession.email : '';
  var apiUrl = appConfig.apiUrl;
  if (!apiUrl || !email) return;

  try {
    var resp = await fetch(apiUrl + '?action=getNewParishioners&email=' + encodeURIComponent(email));
    var data = await resp.json();
    adminNewParishioners = data.newParishioners || [];
    renderAdminNPTable();
  } catch(e) {
    console.error('Error loading new parishioners:', e);
  }
}

function renderAdminNPTable(filter) {
  var filtered = adminNewParishioners;
  if (filter) {
    var term = filter.toLowerCase();
    filtered = adminNewParishioners.filter(function(p) {
      return (p.firstName + ' ' + p.lastName).toLowerCase().includes(term) ||
        (p.email || '').toLowerCase().includes(term);
    });
  }

  document.getElementById('admin-np-stat').textContent = filtered.length + ' new parishioner' + (filtered.length !== 1 ? 's' : '');

  if (filtered.length === 0) {
    document.getElementById('admin-np-table').classList.add('hidden');
    document.getElementById('admin-np-empty').classList.remove('hidden');
    return;
  }

  document.getElementById('admin-np-table').classList.remove('hidden');
  document.getElementById('admin-np-empty').classList.add('hidden');

  document.getElementById('admin-np-body').innerHTML = filtered.map(function(p) {
    return '<tr>' +
      '<td>' + escapeHtml(p.date) + '</td>' +
      '<td>' + escapeHtml(p.firstName + ' ' + p.lastName) + '</td>' +
      '<td>' + escapeHtml(p.email) + '</td>' +
      '<td>' + escapeHtml(p.phone) + '</td>' +
      '</tr>';
  }).join('');
}

document.getElementById('admin-np-search').addEventListener('input', function() {
  renderAdminNPTable(this.value);
});

document.getElementById('export-np-btn').addEventListener('click', function() {
  exportToCsv('new-parishioners', adminNewParishioners, ['date','time','firstName','lastName','email','phone']);
});

// CSV Export
function exportToCsv(filename, data, fields) {
  if (!data || data.length === 0) return;
  var csv = '\uFEFF' + fields.join(',') + '\n';
  data.forEach(function(row) {
    csv += fields.map(function(f) {
      var val = String(row[f] || '');
      if (val.includes(',') || val.includes('"') || val.includes('\n')) {
        return '"' + val.replace(/"/g, '""') + '"';
      }
      return val;
    }).join(',') + '\n';
  });
  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = filename + '-' + new Date().toISOString().slice(0,10) + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Ministries tab (CRUD)
function renderAdminMinistries() {
  var list = document.getElementById('admin-ministries-list');
  if (MINISTRIES.length === 0) {
    list.innerHTML = '<div class="admin-empty">No ministries found. Add one to get started!</div>';
    return;
  }

  list.innerHTML = MINISTRIES.map(function(m) {
    return '<div class="admin-ministry-card" data-id="' + escapeHtml(m.id) + '">' +
      '<div class="ministry-icon">' + escapeHtml(m.icon) + '</div>' +
      '<div class="ministry-info">' +
        '<h3 class="ministry-name">' + escapeHtml(m.name) + '</h3>' +
        '<p class="ministry-desc">' + escapeHtml(m.description) + '</p>' +
        (m.organizerName ? '<p style="font-size:12px;color:#888;margin-top:4px;">' + escapeHtml(m.organizerName) + '</p>' : '') +
      '</div>' +
      '<div class="admin-ministry-actions">' +
        '<button class="btn-followup followup-ministry-btn" data-id="' + escapeHtml(m.id) + '" title="Follow-Up Questions">Follow-Up</button>' +
        '<button class="btn-icon edit-ministry-btn" data-id="' + escapeHtml(m.id) + '" title="Edit">&#9998;</button>' +
        '<button class="btn-icon danger delete-ministry-btn" data-id="' + escapeHtml(m.id) + '" title="Delete">&#128465;</button>' +
      '</div>' +
    '</div>';
  }).join('');

  list.querySelectorAll('.edit-ministry-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      openMinistryEditor(btn.dataset.id);
    });
  });

  list.querySelectorAll('.delete-ministry-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      deleteMinistryFromDashboard(btn.dataset.id);
    });
  });

  list.querySelectorAll('.followup-ministry-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      openFollowupEditor(btn.dataset.id);
    });
  });
}

// ============================================
// AUTO-ASSIGN MINISTRY ICONS
// ============================================

// Assign emoji icons to ministries that have the default  or no icon
async function autoAssignIcons(ministriesToUpdate) {
  if (!ministriesToUpdate || ministriesToUpdate.length === 0) return;
  if (!appConfig.apiUrl) return;

  var ministryList = ministriesToUpdate.map(function(m) {
    return { id: m.id, name: m.name, description: (m.description || '').substring(0, 100) };
  });

  var prompt = 'I need you to assign a single appropriate emoji icon to each of these church/parish ministries. ' +
    'Choose emojis that visually represent what each ministry does. Be creative but appropriate  no obscene or offensive emojis.\n\n' +
    'Guidelines:\n' +
    '- Music/choir   or \n' +
    '- Youth   or \n' +
    '- Prayer  \n' +
    '- Food/meals   or \n' +
    '- Hospitality/greeting   or \n' +
    '- Teaching/education   or \n' +
    '- Service/outreach   or \n' +
    '- Liturgy/altar   or \n' +
    '- Technology/media   or \n' +
    '- Maintenance/facilities   or \n' +
    '- Finance  \n' +
    '- Health/wellness   or \n' +
    'Use your judgment for other types.\n\n' +
    'MINISTRIES:\n' +
    JSON.stringify(ministryList) + '\n\n' +
    'Return ONLY a JSON object mapping ministry id to a single emoji character:\n' +
    '{"ministry-id": "", "another-id": ""}\n' +
    'No markdown, no explanation  just the JSON.';

  try {
    var resp = await fetch(appConfig.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'ai-analyze', sampleData: 'icons', prompt: prompt })
    });
    var result = await resp.json();

    if (result.success && result.result) {
      var iconMap = typeof result.result === 'string' ? JSON.parse(result.result) : result.result;
      return iconMap;
    }
  } catch(err) {
    console.error('Icon generation error:', err);
  }
  return null;
}

// Apply generated icons to ministries via the API
async function applyIcons(iconMap) {
  if (!iconMap) return 0;
  var count = 0;

  for (var i = 0; i < MINISTRIES.length; i++) {
    var m = MINISTRIES[i];
    var newIcon = iconMap[m.id];
    if (!newIcon) continue;

    // Only update if the ministry has the default icon or no icon
    if (m.icon && m.icon !== '' && m.icon !== '&#128203;') continue;

    try {
      await fetch(appConfig.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          adminAction: 'updateMinistry',
          adminEmail: currentSession ? currentSession.email : '',
          id: m.id,
          name: m.name,
          description: m.description || '',
          icon: newIcon,
          organizerName: m.organizerName || '',
          organizerEmail: m.organizerEmail || '',
          organizerPhone: m.organizerPhone || ''
        })
      });
      m.icon = newIcon; // update local state immediately
      count++;
    } catch(err) {
      console.error('Error updating icon for', m.id, err);
    }
  }
  return count;
}

// Button handler: generate icons for all ministries with default icon
document.getElementById('generate-icons-btn').addEventListener('click', async function() {
  var btn = document.getElementById('generate-icons-btn');
  var needsIcons = MINISTRIES.filter(function(m) {
    return !m.icon || m.icon === '' || m.icon === '&#128203;';
  });

  if (needsIcons.length === 0) {
    alert('All ministries already have custom icons!');
    return;
  }

  btn.disabled = true;
  btn.textContent = ' Generating...';

  var iconMap = await autoAssignIcons(needsIcons);
  if (iconMap) {
    var count = await applyIcons(iconMap);
    await loadMinistries();
    renderAdminMinistries();
    alert('Assigned icons to ' + count + ' ministr' + (count === 1 ? 'y' : 'ies') + '!');
  } else {
    alert('Could not generate icons. Check that your Claude API key is configured.');
  }

  btn.disabled = false;
  btn.textContent = ' Generate Icons';
});

// Auto-assign icons after initial ministry import (runs once after first load with default icons)
async function autoAssignIconsIfNeeded() {
  var needsIcons = MINISTRIES.filter(function(m) {
    return !m.icon || m.icon === '' || m.icon === '&#128203;';
  });

  // Only auto-run if most ministries need icons (looks like a fresh import)
  if (needsIcons.length >= 3 && needsIcons.length >= MINISTRIES.length * 0.5) {
    var iconMap = await autoAssignIcons(needsIcons);
    if (iconMap) {
      await applyIcons(iconMap);
      await loadMinistries();
      // Re-render if we're on the admin dashboard
      if (!document.getElementById('view-admin').classList.contains('hidden')) {
        renderAdminMinistries();
      }
    }
  }
}

// ============================================
// ENRICH MINISTRIES (Booklet + Spreadsheet)
// ============================================
var enrichSourceType = null; // 'booklet' or 'spreadsheet'
var enrichResults = null;    // parsed AI results

document.getElementById('enrich-booklet-btn').addEventListener('click', function() {
  enrichSourceType = 'booklet';
  document.getElementById('enrich-panel-title').textContent = 'Import Ministry Booklet';
  document.getElementById('enrich-panel-desc').textContent =
    'Upload a ministry booklet (PDF) or document. AI will extract descriptions, meeting times, contacts, and more to enrich your existing ministry data.';
  document.getElementById('enrich-upload-hint').textContent = 'PDF or image files';
  document.getElementById('enrich-file-input').accept = '.pdf,.jpg,.jpeg,.png';
  resetEnrichPanel();
  document.getElementById('enrich-panel').classList.remove('hidden');
});

document.getElementById('enrich-spreadsheet-btn').addEventListener('click', function() {
  enrichSourceType = 'spreadsheet';
  document.getElementById('enrich-panel-title').textContent = 'Add Supplementary Spreadsheet';
  document.getElementById('enrich-panel-desc').textContent =
    'Upload an additional spreadsheet with extra details like meeting times, locations, requirements, etc. AI will match it to your existing ministries and pull in the new data.';
  document.getElementById('enrich-upload-hint').textContent = 'CSV, Excel, or any spreadsheet format';
  document.getElementById('enrich-file-input').accept = '.csv,.tsv,.xlsx,.xls,.txt';
  resetEnrichPanel();
  document.getElementById('enrich-panel').classList.remove('hidden');
});

document.getElementById('enrich-panel-close').addEventListener('click', function() {
  document.getElementById('enrich-panel').classList.add('hidden');
});

function resetEnrichPanel() {
  document.getElementById('enrich-upload-area').classList.remove('hidden');
  document.getElementById('enrich-filename').classList.add('hidden');
  document.getElementById('enrich-progress').classList.add('hidden');
  document.getElementById('enrich-results').classList.add('hidden');
  document.getElementById('enrich-file-input').value = '';
  enrichResults = null;
}

// File upload for enrichment
(function() {
  var area = document.getElementById('enrich-upload-area');
  var fileInput = document.getElementById('enrich-file-input');

  area.addEventListener('click', function() { fileInput.click(); });
  area.addEventListener('dragover', function(e) {
    e.preventDefault();
    area.classList.add('dragover');
  });
  area.addEventListener('dragleave', function() { area.classList.remove('dragover'); });
  area.addEventListener('drop', function(e) {
    e.preventDefault();
    area.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) handleEnrichFile(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener('change', function() {
    if (fileInput.files.length > 0) handleEnrichFile(fileInput.files[0]);
  });
  document.getElementById('enrich-remove-file-btn').addEventListener('click', resetEnrichPanel);
})();

async function handleEnrichFile(file) {
  document.getElementById('enrich-upload-area').classList.add('hidden');
  document.getElementById('enrich-filename').classList.remove('hidden');
  document.getElementById('enrich-filename-text').textContent = file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)';

  var ext = file.name.split('.').pop().toLowerCase();
  var isBooklet = ['pdf', 'jpg', 'jpeg', 'png'].includes(ext);
  var isSpreadsheet = ['csv', 'tsv', 'xlsx', 'xls', 'txt'].includes(ext);

  if (isBooklet) {
    enrichSourceType = 'booklet';
    await analyzeBooklet(file, ext);
  } else if (isSpreadsheet) {
    enrichSourceType = 'spreadsheet';
    await analyzeEnrichSpreadsheet(file);
  } else {
    alert('Unsupported file type.');
    resetEnrichPanel();
  }
}

async function analyzeBooklet(file, ext) {
  var progress = document.getElementById('enrich-progress');
  var statusText = document.getElementById('enrich-status-text');
  progress.classList.remove('hidden');
  statusText.textContent = 'Reading booklet with AI... This may take a moment.';

  var reader = new FileReader();
  reader.onload = async function(e) {
    var base64Data = e.target.result.split(',')[1];
    var mediaType = ext === 'pdf' ? 'application/pdf' : (ext === 'png' ? 'image/png' : 'image/jpeg');

    var existingMinistries = MINISTRIES.map(function(m) {
      return { id: m.id, name: m.name, description: m.description || '' };
    });

    try {
      var resp = await fetch(appConfig.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'ai-enrich',
          sourceType: 'booklet',
          fileData: base64Data,
          mediaType: mediaType,
          existingMinistries: existingMinistries
        })
      });
      var result = await resp.json();
      progress.classList.add('hidden');

      if (result.success && result.result) {
        enrichResults = result.result;
        renderEnrichResults(enrichResults);
      } else {
        document.getElementById('enrich-results').classList.remove('hidden');
        document.getElementById('enrich-summary').innerHTML =
          '<div class="mapping-summary warn"><h4>Analysis Error</h4><p>' +
          escapeHtml(result.error || 'Could not analyze the booklet.') + '</p></div>';
      }
    } catch(err) {
      progress.classList.add('hidden');
      document.getElementById('enrich-results').classList.remove('hidden');
      document.getElementById('enrich-summary').innerHTML =
        '<div class="mapping-summary warn"><h4>Error</h4><p>' + escapeHtml(err.message) + '</p></div>';
    }
  };
  reader.readAsDataURL(file);
}

async function analyzeEnrichSpreadsheet(file) {
  var progress = document.getElementById('enrich-progress');
  var statusText = document.getElementById('enrich-status-text');
  progress.classList.remove('hidden');
  statusText.textContent = 'Reading spreadsheet with AI...';

  var reader = new FileReader();
  reader.onload = async function(e) {
    var text = e.target.result;
    var parsed;
    if (file.name.endsWith('.tsv') || file.name.endsWith('.txt')) {
      parsed = parseTSV(text);
    } else {
      parsed = parseCSV(text);
      if (parsed.length > 0 && parsed[0].length === 1 && parsed[0][0].includes('\t')) {
        parsed = parseTSV(text);
      }
    }

    if (parsed.length < 2) {
      progress.classList.add('hidden');
      document.getElementById('enrich-results').classList.remove('hidden');
      document.getElementById('enrich-summary').innerHTML =
        '<div class="mapping-summary warn"><h4>Not enough data</h4><p>Need at least a header row and one data row.</p></div>';
      return;
    }

    var headers = parsed[0];
    var rows = parsed.slice(1, 20); // sample up to 20 rows
    var sampleText = 'HEADERS: ' + JSON.stringify(headers) + '\n\nROWS:\n';
    rows.forEach(function(row, i) {
      sampleText += 'Row ' + (i + 1) + ': ' + JSON.stringify(row) + '\n';
    });

    var existingMinistries = MINISTRIES.map(function(m) {
      return { id: m.id, name: m.name, description: m.description || '' };
    });

    try {
      var resp = await fetch(appConfig.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'ai-enrich',
          sourceType: 'spreadsheet',
          sampleData: sampleText,
          existingMinistries: existingMinistries
        })
      });
      var result = await resp.json();
      progress.classList.add('hidden');

      if (result.success && result.result) {
        enrichResults = result.result;
        renderEnrichResults(enrichResults);
      } else {
        document.getElementById('enrich-results').classList.remove('hidden');
        document.getElementById('enrich-summary').innerHTML =
          '<div class="mapping-summary warn"><h4>Analysis Error</h4><p>' +
          escapeHtml(result.error || 'Could not analyze the spreadsheet.') + '</p></div>';
      }
    } catch(err) {
      progress.classList.add('hidden');
      document.getElementById('enrich-results').classList.remove('hidden');
      document.getElementById('enrich-summary').innerHTML =
        '<div class="mapping-summary warn"><h4>Error</h4><p>' + escapeHtml(err.message) + '</p></div>';
    }
  };
  reader.readAsText(file);
}

function renderEnrichResults(data) {
  var resultsDiv = document.getElementById('enrich-results');
  var summaryDiv = document.getElementById('enrich-summary');
  var itemsDiv = document.getElementById('enrich-items');
  resultsDiv.classList.remove('hidden');

  var enrichments = data.enrichments || [];
  var newMinistries = data.newMinistries || [];
  var summary = data.summary || '';

  summaryDiv.innerHTML =
    '<div class="mapping-summary ' + (enrichments.length > 0 ? 'good' : 'warn') + '">' +
    '<h4>' + (enrichments.length > 0 ? '&#10003; ' : '&#9888; ') + 'Analysis Complete</h4>' +
    '<p>' + escapeHtml(summary) + '</p>' +
    '<p style="margin-top: 6px; font-size: 13px;">' +
    '<strong>' + enrichments.length + '</strong> enrichment' + (enrichments.length !== 1 ? 's' : '') + ' found' +
    (newMinistries.length > 0 ? ', <strong>' + newMinistries.length + '</strong> new ministr' + (newMinistries.length !== 1 ? 'ies' : 'y') + ' discovered' : '') +
    '</p></div>';

  var html = '';
  enrichments.forEach(function(item, idx) {
    var isMatched = item.existingId || item.existingName;
    var displayName = item.bookletName || item.sheetName || item.existingName || 'Unknown';

    html += '<div class="enrich-item">';
    html += '<div class="enrich-item-header">';
    html += '<input type="checkbox" checked id="enrich-check-' + idx + '" data-enrich-idx="' + idx + '">';
    html += '<span class="enrich-item-name">' + escapeHtml(displayName) + '</span>';
    if (isMatched) {
      html += '<span class="enrich-item-match">Matches: ' + escapeHtml(item.existingName || item.existingId) + '</span>';
    } else {
      html += '<span class="enrich-item-new">New Ministry</span>';
    }
    html += '</div>';

    // Show each enrichment field
    var fields = [
      { key: 'description', label: 'Description' },
      { key: 'meetingTime', label: 'Meeting Time' },
      { key: 'location', label: 'Location' },
      { key: 'requirements', label: 'Requirements' },
      { key: 'contactName', label: 'Contact' },
      { key: 'contactEmail', label: 'Email' },
      { key: 'contactPhone', label: 'Phone' },
      { key: 'organizerName', label: 'Organizer' },
      { key: 'organizerEmail', label: 'Email' },
      { key: 'organizerPhone', label: 'Phone' },
      { key: 'additionalNotes', label: 'Notes' }
    ];

    fields.forEach(function(f) {
      if (item[f.key]) {
        html += '<div class="enrich-field"><span class="enrich-field-label">' + f.label + ':</span> ' +
          '<span class="enrich-field-new">' + escapeHtml(item[f.key]) + '</span></div>';
      }
    });

    html += '</div>';
  });

  // Show new ministries that don't match existing ones
  if (newMinistries.length > 0) {
    html += '<div style="margin-top: 16px; padding: 12px; background: #fff5f5; border-radius: 10px; border: 1px solid #feb2b2;">';
    html += '<p style="font-size: 14px; font-weight: 600; color: #c53030; margin-bottom: 8px;">New Ministries Not Yet in Your List:</p>';
    newMinistries.forEach(function(name) {
      html += '<div style="font-size: 13px; color: #555; padding: 2px 0;">&bull; ' + escapeHtml(name) + '</div>';
    });
    html += '<p style="font-size: 12px; color: #888; margin-top: 8px;">You can add these manually from the "+ Add Ministry" button.</p>';
    html += '</div>';
  }

  itemsDiv.innerHTML = html;
}

// Apply selected enrichments
document.getElementById('enrich-apply-btn').addEventListener('click', async function() {
  if (!enrichResults || !enrichResults.enrichments) return;

  var btn = document.getElementById('enrich-apply-btn');
  btn.disabled = true;
  btn.textContent = 'Applying...';

  var enrichments = enrichResults.enrichments;
  var applied = 0;

  for (var i = 0; i < enrichments.length; i++) {
    var checkbox = document.getElementById('enrich-check-' + i);
    if (!checkbox || !checkbox.checked) continue;

    var item = enrichments[i];
    if (!item.existingId && !item.existingName) continue; // skip new ministries

    // Find the matching existing ministry
    var ministry = null;
    if (item.existingId) {
      ministry = MINISTRIES.find(function(m) { return m.id === item.existingId; });
    }
    if (!ministry && item.existingName) {
      ministry = MINISTRIES.find(function(m) {
        return m.name.toLowerCase() === item.existingName.toLowerCase();
      });
    }
    if (!ministry) continue;

    // Build update payload  merge new data with existing
    var enrichedDesc = item.description || '';
    var notes = [];
    if (item.meetingTime) notes.push('Meeting: ' + item.meetingTime);
    if (item.location) notes.push('Location: ' + item.location);
    if (item.requirements) notes.push('Requirements: ' + item.requirements);
    if (item.additionalNotes) notes.push(item.additionalNotes);

    // Append notes to description if there are any
    var newDescription = ministry.description || '';
    if (enrichedDesc && enrichedDesc.length > (newDescription.length || 0)) {
      newDescription = enrichedDesc;
    }
    if (notes.length > 0) {
      newDescription += (newDescription ? '\n\n' : '') + notes.join('\n');
    }

    var payload = {
      adminAction: 'updateMinistry',
      adminEmail: currentSession ? currentSession.email : '',
      id: ministry.id,
      name: ministry.name,
      description: newDescription,
      icon: ministry.icon || '',
      organizerName: item.contactName || item.organizerName || ministry.organizerName || '',
      organizerEmail: item.contactEmail || item.organizerEmail || ministry.organizerEmail || '',
      organizerPhone: item.contactPhone || item.organizerPhone || ministry.organizerPhone || ''
    };

    try {
      await fetch(appConfig.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      applied++;
    } catch(err) {
      console.error('Error updating ministry:', ministry.id, err);
    }
  }

  // Reload ministries and close
  await loadMinistries();
  renderAdminMinistries();
  document.getElementById('enrich-panel').classList.add('hidden');
  btn.disabled = false;
  btn.textContent = 'Apply Selected Changes';
  alert('Updated ' + applied + ' ministr' + (applied === 1 ? 'y' : 'ies') + ' with enriched data.');
});

document.getElementById('enrich-cancel-btn').addEventListener('click', function() {
  document.getElementById('enrich-panel').classList.add('hidden');
});

document.getElementById('add-ministry-btn').addEventListener('click', function() {
  openMinistryEditor(null);
});

function openMinistryEditor(ministryId) {
  editingMinistryId = ministryId;
  var modal = document.getElementById('ministry-edit-modal');
  modal.classList.remove('hidden');

  if (ministryId) {
    var m = MINISTRIES.find(function(min) { return min.id === ministryId; });
    if (!m) return;
    document.getElementById('edit-modal-title').textContent = 'Edit Ministry';
    document.getElementById('edit-ministry-id').value = m.id;
    document.getElementById('edit-ministry-id').disabled = true;
    document.getElementById('edit-ministry-name').value = m.name || '';
    document.getElementById('edit-ministry-desc').value = m.description || '';
    document.getElementById('edit-ministry-icon').value = m.icon || '';
    document.getElementById('edit-ministry-org-name').value = m.organizerName || '';
    document.getElementById('edit-ministry-org-email').value = m.organizerEmail || '';
    document.getElementById('edit-ministry-org-phone').value = m.organizerPhone || '';
    document.getElementById('edit-ministry-tags').value = (m.tags || []).join(', ');
  } else {
    document.getElementById('edit-modal-title').textContent = 'Add Ministry';
    document.getElementById('edit-ministry-id').value = '';
    document.getElementById('edit-ministry-id').disabled = false;
    document.getElementById('edit-ministry-name').value = '';
    document.getElementById('edit-ministry-desc').value = '';
    document.getElementById('edit-ministry-icon').value = '';
    document.getElementById('edit-ministry-org-name').value = '';
    document.getElementById('edit-ministry-org-email').value = '';
    document.getElementById('edit-ministry-org-phone').value = '';
    document.getElementById('edit-ministry-tags').value = '';
  }
}

document.getElementById('edit-modal-cancel').addEventListener('click', function() {
  document.getElementById('ministry-edit-modal').classList.add('hidden');
});

document.getElementById('edit-modal-backdrop').addEventListener('click', function() {
  document.getElementById('ministry-edit-modal').classList.add('hidden');
});

document.getElementById('edit-modal-save').addEventListener('click', async function() {
  var btn = this;
  btn.disabled = true;
  btn.textContent = 'Saving...';

  var payload = {
    adminEmail: currentSession ? currentSession.email : '',
    adminAction: editingMinistryId ? 'updateMinistry' : 'addMinistry',
    id: document.getElementById('edit-ministry-id').value.trim() ||
        document.getElementById('edit-ministry-name').value.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-'),
    name: document.getElementById('edit-ministry-name').value.trim(),
    description: document.getElementById('edit-ministry-desc').value.trim(),
    icon: document.getElementById('edit-ministry-icon').value.trim() || '',
    organizerName: document.getElementById('edit-ministry-org-name').value.trim(),
    organizerEmail: document.getElementById('edit-ministry-org-email').value.trim(),
    organizerPhone: document.getElementById('edit-ministry-org-phone').value.trim(),
    tags: document.getElementById('edit-ministry-tags').value.trim()
  };

  try {
    var resp = await fetch(appConfig.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    var result = await resp.json();
    if (result.success) {
      document.getElementById('ministry-edit-modal').classList.add('hidden');
      await loadMinistries();
      renderAdminMinistries();
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
    }
  } catch(e) {
    alert('Network error. Please try again.');
  }
  btn.disabled = false;
  btn.textContent = 'Save';
});

async function deleteMinistryFromDashboard(id) {
  var m = MINISTRIES.find(function(min) { return min.id === id; });
  if (!m) return;
  if (!confirm('Delete "' + m.name + '"? This cannot be undone.')) return;

  try {
    var resp = await fetch(appConfig.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        adminEmail: currentSession ? currentSession.email : '',
        adminAction: 'deleteMinistry',
        id: id
      })
    });
    var result = await resp.json();
    if (result.success) {
      await loadMinistries();
      renderAdminMinistries();
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
    }
  } catch(e) {
    alert('Network error. Please try again.');
  }
}

// Manage Users tab
async function loadAdminUsers() {
  var email = currentSession ? currentSession.email : '';
  var apiUrl = appConfig.apiUrl;
  if (!apiUrl || !email) {
    renderAdminUsersFromLocal();
    return;
  }

  try {
    var resp = await fetch(apiUrl + '?action=getAdmins&email=' + encodeURIComponent(email));
    var data = await resp.json();
    if (data.admins) {
      adminUsersList = data.admins;
      renderAdminUsersServer();
    } else {
      renderAdminUsersFromLocal();
    }
  } catch(e) {
    renderAdminUsersFromLocal();
  }
}

function renderAdminUsersFromLocal() {
  var admins = loadAdmins();
  var list = document.getElementById('admin-users-list');
  list.innerHTML = admins.map(function(a) {
    var initials = escapeHtml((a.firstName ? a.firstName[0] : '') + (a.lastName ? a.lastName[0] : ''));
    var isMe = currentSession && a.email.toLowerCase() === currentSession.email.toLowerCase();
    return '<div class="admin-item">' +
      '<div class="profile-icon">' + initials + '</div>' +
      '<div class="admin-item-details">' +
        '<div class="admin-item-name">' + escapeHtml((a.firstName || '') + ' ' + (a.lastName || '')) + '</div>' +
        '<div class="admin-item-email">' + escapeHtml(a.email) + '</div>' +
      '</div>' +
      (isMe ? '<span class="admin-item-tag">You</span>' : '') +
    '</div>';
  }).join('');
}

function renderAdminUsersServer() {
  var list = document.getElementById('admin-users-list');
  var isMe = function(email) { return currentSession && email.toLowerCase() === currentSession.email.toLowerCase(); };
  list.innerHTML = adminUsersList.map(function(a) {
    var initials = escapeHtml((a.name || a.email || '').substring(0, 2).toUpperCase());
    return '<div class="admin-item">' +
      '<div class="profile-icon">' + initials + '</div>' +
      '<div class="admin-item-details">' +
        '<div class="admin-item-name">' + escapeHtml(a.name || a.email) + '</div>' +
        '<div class="admin-item-email">' + escapeHtml(a.email) + '</div>' +
      '</div>' +
      (isMe(a.email) ? '<span class="admin-item-tag">You</span>' :
        '<button class="admin-remove-btn server-remove" data-email="' + escapeHtml(a.email) + '" title="Remove">&times;</button>') +
    '</div>';
  }).join('');

  list.querySelectorAll('.server-remove').forEach(function(btn) {
    btn.addEventListener('click', async function() {
      if (!confirm('Remove ' + btn.dataset.email + ' as admin?')) return;
      try {
        var resp = await fetch(appConfig.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminEmail: currentSession.email,
            adminAction: 'removeAdmin',
            email: btn.dataset.email
          })
        });
        var result = await resp.json();
        if (result.success) loadAdminUsers();
        else alert('Error: ' + (result.error || 'Unknown'));
      } catch(e) { alert('Network error.'); }
    });
  });
}

document.getElementById('admin-add-user-btn').addEventListener('click', async function() {
  var emailInput = document.getElementById('admin-new-user-email');
  var nameInput = document.getElementById('admin-new-user-name');
  var email = emailInput.value.trim().toLowerCase();
  var name = nameInput.value.trim();
  if (!email || !email.includes('@')) return;

  if (appConfig.apiUrl && currentSession) {
    try {
      var resp = await fetch(appConfig.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          adminEmail: currentSession.email,
          adminAction: 'addAdmin',
          email: email,
          name: name
        })
      });
      var result = await resp.json();
      if (result.success) {
        emailInput.value = '';
        nameInput.value = '';
        loadAdminUsers();
      } else {
        alert('Error: ' + (result.error || 'Unknown'));
      }
    } catch(e) { alert('Network error.'); }
  } else {
    // Fallback to local
    var admins = loadAdmins();
    if (admins.some(function(a) { return a.email.toLowerCase() === email; })) return;
    var parts = name.split(' ');
    admins.push({ email: email, firstName: parts[0] || '', lastName: parts.slice(1).join(' ') || '', picture: '', role: 'admin' });
    saveAdmins(admins);
    appAdmins = admins;
    emailInput.value = '';
    nameInput.value = '';
    renderAdminUsersFromLocal();
  }
});

// ============================================
// QR CODE GENERATION
// ============================================
function renderQRCodes() {
  var grid = document.getElementById('qr-grid');
  grid.innerHTML = '';

  if (typeof QRCode === 'undefined') {
    grid.innerHTML = '<div class="admin-empty">QR Code library loading... please try again in a moment.</div>';
    return;
  }

  var baseUrl = window.location.origin + window.location.pathname;

  MINISTRIES.forEach(function(m) {
    var card = document.createElement('div');
    card.className = 'qr-card';

    var qrDiv = document.createElement('div');
    qrDiv.style.display = 'flex';
    qrDiv.style.justifyContent = 'center';
    card.appendChild(qrDiv);

    var url = baseUrl + '?m=' + encodeURIComponent(m.id);

    new QRCode(qrDiv, {
      text: url,
      width: 160,
      height: 160,
      colorDark: '#333333',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });

    var nameEl = document.createElement('div');
    nameEl.className = 'qr-card-name';
    nameEl.textContent = m.icon + ' ' + m.name;
    card.appendChild(nameEl);

    var urlEl = document.createElement('div');
    urlEl.className = 'qr-card-url';
    urlEl.textContent = url;
    card.appendChild(urlEl);

    grid.appendChild(card);
  });
}

document.getElementById('print-qr-btn').addEventListener('click', function() {
  window.print();
});

// ============================================
// MY SIGNUPS VIEW
// ============================================
function showMySignups() {
  showView('mySignups');

  var listDiv = document.getElementById('my-signups-list');
  var emptyDiv = document.getElementById('my-signups-empty');

  if (interests.length === 0) {
    listDiv.innerHTML = '';
    emptyDiv.classList.remove('hidden');
    return;
  }

  emptyDiv.classList.add('hidden');
  listDiv.innerHTML = interests.map(function(i) {
    var m = MINISTRIES.find(function(min) { return min.id === i.ministryId; });
    var dateStr = i.timestamp ? new Date(i.timestamp).toLocaleDateString() : '';
    return '<div class="signup-card">' +
      '<div class="signup-card-header">' +
        '<div class="ministry-icon" style="width:36px;height:36px;font-size:20px;border-radius:8px;">' + (m ? escapeHtml(m.icon) : '') + '</div>' +
        '<div>' +
          '<div class="signup-card-ministry">' + escapeHtml(i.ministryName) + '</div>' +
          '<div class="signup-card-date">' + escapeHtml(dateStr) + '</div>' +
        '</div>' +
        '<span class="signup-card-status active">Active</span>' +
      '</div>' +
    '</div>';
  }).join('');
}

document.getElementById('my-signups-back').addEventListener('click', function() {
  showMinistriesList();
});

// ============================================
// MANUAL ENTRY (Admin Tab)
// ============================================
var parsedUploadEntries = [];

function initManualEntryTab() {
  // Populate ministry dropdowns
  var selects = [document.getElementById('manual-ministry'), document.getElementById('upload-default-ministry')];
  selects.forEach(function(select) {
    if (!select) return;
    select.innerHTML = '<option value="">Select a ministry...</option>';
    MINISTRIES.forEach(function(m) {
      select.innerHTML += '<option value="' + escapeHtml(m.id) + '">' + escapeHtml(m.name) + '</option>';
    });
  });

  // Phone formatting
  var manualPhone = document.getElementById('manual-phone');
  manualPhone.removeEventListener('input', manualPhoneFormat);
  manualPhone.addEventListener('input', manualPhoneFormat);

  // Reset upload state
  document.getElementById('manual-upload-filename').classList.add('hidden');
  document.getElementById('manual-parse-progress').classList.add('hidden');
  document.getElementById('manual-review-container').classList.add('hidden');
  parsedUploadEntries = [];
}

function manualPhoneFormat(e) {
  e.target.value = formatPhoneNumber(e.target.value);
}

// Mode toggle
document.getElementById('mode-upload-btn').addEventListener('click', function() {
  document.getElementById('mode-upload-btn').classList.add('active');
  document.getElementById('mode-manual-btn').classList.remove('active');
  document.getElementById('manual-upload-mode').classList.remove('hidden');
  document.getElementById('manual-single-mode').classList.add('hidden');
});
document.getElementById('mode-manual-btn').addEventListener('click', function() {
  document.getElementById('mode-manual-btn').classList.add('active');
  document.getElementById('mode-upload-btn').classList.remove('active');
  document.getElementById('manual-single-mode').classList.remove('hidden');
  document.getElementById('manual-upload-mode').classList.add('hidden');
});

// Upload area interactions
document.getElementById('manual-upload-area').addEventListener('click', function() {
  document.getElementById('manual-upload-input').click();
});
document.getElementById('manual-upload-area').addEventListener('dragover', function(e) {
  e.preventDefault();
  this.classList.add('dragover');
});
document.getElementById('manual-upload-area').addEventListener('dragleave', function() {
  this.classList.remove('dragover');
});
document.getElementById('manual-upload-area').addEventListener('drop', function(e) {
  e.preventDefault();
  this.classList.remove('dragover');
  if (e.dataTransfer.files.length > 0) {
    handleManualFileSelect(e.dataTransfer.files[0]);
  }
});
document.getElementById('manual-upload-input').addEventListener('change', function() {
  if (this.files.length > 0) handleManualFileSelect(this.files[0]);
});
document.getElementById('manual-upload-remove').addEventListener('click', function() {
  document.getElementById('manual-upload-filename').classList.add('hidden');
  document.getElementById('manual-upload-input').value = '';
  document.getElementById('manual-review-container').classList.add('hidden');
  parsedUploadEntries = [];
});

function handleManualFileSelect(file) {
  document.getElementById('manual-upload-fname').textContent = file.name;
  document.getElementById('manual-upload-filename').classList.remove('hidden');

  var ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'csv') {
    parseCSVFile(file);
  } else if (['jpg', 'jpeg', 'png', 'pdf'].includes(ext)) {
    parseImageFile(file, ext);
  } else {
    alert('Unsupported file type. Please use CSV, JPG, PNG, or PDF.');
  }
}

function parseCSVFile(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    var text = e.target.result;
    var lines = text.split(/\r?\n/).filter(function(l) { return l.trim(); });
    if (lines.length < 2) {
      alert('CSV file appears empty or has no data rows.');
      return;
    }

    var headers = lines[0].split(',').map(function(h) { return h.trim().toLowerCase().replace(/['"]/g, ''); });

    // Auto-map columns
    var map = { first: -1, last: -1, email: -1, phone: -1, ministry: -1 };
    headers.forEach(function(h, i) {
      if (h.includes('first') && h.includes('name') || h === 'first' || h === 'firstname') map.first = i;
      else if (h.includes('last') && h.includes('name') || h === 'last' || h === 'lastname') map.last = i;
      else if (h.includes('email') || h.includes('e-mail')) map.email = i;
      else if (h.includes('phone') || h.includes('tel') || h.includes('cell') || h.includes('mobile')) map.phone = i;
      else if (h.includes('ministry') || h.includes('group') || h.includes('interest')) map.ministry = i;
    });
    // Fallback: if we have a "name" column, use it for first+last
    if (map.first === -1) {
      headers.forEach(function(h, i) {
        if (h === 'name' || h === 'full name' || h === 'fullname') map.first = i;
      });
    }

    var defaultMinistry = document.getElementById('upload-default-ministry').value;
    var defaultMinistryName = '';
    if (defaultMinistry) {
      var dm = MINISTRIES.find(function(m) { return m.id === defaultMinistry; });
      defaultMinistryName = dm ? dm.name : '';
    }

    parsedUploadEntries = [];
    for (var i = 1; i < lines.length; i++) {
      var cols = lines[i].split(',').map(function(c) { return c.trim().replace(/^["']|["']$/g, ''); });
      var entry = { firstName: '', lastName: '', email: '', phone: '', ministry: defaultMinistryName };

      if (map.first >= 0) {
        var nameVal = cols[map.first] || '';
        if (map.last === -1 && nameVal.includes(' ')) {
          var parts = nameVal.split(' ');
          entry.firstName = parts[0];
          entry.lastName = parts.slice(1).join(' ');
        } else {
          entry.firstName = nameVal;
        }
      }
      if (map.last >= 0) entry.lastName = cols[map.last] || '';
      if (map.email >= 0) entry.email = cols[map.email] || '';
      if (map.phone >= 0) entry.phone = cols[map.phone] || '';
      if (map.ministry >= 0 && cols[map.ministry]) entry.ministry = cols[map.ministry];

      if (entry.firstName || entry.lastName) {
        parsedUploadEntries.push(entry);
      }
    }

    renderReviewTable();
  };
  reader.readAsText(file);
}

async function parseImageFile(file, ext) {
  var progress = document.getElementById('manual-parse-progress');
  var statusText = document.getElementById('manual-parse-status');
  progress.classList.remove('hidden');
  statusText.textContent = 'Reading file...';

  var reader = new FileReader();
  reader.onload = async function(e) {
    var base64Data = e.target.result.split(',')[1];
    var mediaType = ext === 'pdf' ? 'application/pdf' : (ext === 'png' ? 'image/png' : 'image/jpeg');

    statusText.textContent = 'AI is extracting signup data...';

    var defaultMinistry = document.getElementById('upload-default-ministry').value;
    var defaultMinistryName = '';
    if (defaultMinistry) {
      var dm = MINISTRIES.find(function(m) { return m.id === defaultMinistry; });
      defaultMinistryName = dm ? dm.name : '';
    }

    try {
      var apiUrl = appConfig.apiUrl;
      var resp = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'ai-parse-signups',
          imageData: base64Data,
          mediaType: mediaType,
          defaultMinistry: defaultMinistryName,
          ministryNames: MINISTRIES.map(function(m) { return m.name; })
        })
      });
      var result = await resp.json();
      progress.classList.add('hidden');

      if (result.success && result.result && result.result.entries) {
        parsedUploadEntries = result.result.entries.map(function(e) {
          return {
            firstName: e.firstName || '',
            lastName: e.lastName || '',
            email: e.email || '',
            phone: e.phone || '',
            ministry: e.ministry || defaultMinistryName
          };
        });
        renderReviewTable();
      } else {
        alert('Could not parse the file. Error: ' + (result.error || 'Unknown'));
      }
    } catch(err) {
      progress.classList.add('hidden');
      alert('Error communicating with AI service: ' + err.message);
    }
  };
  reader.readAsDataURL(file);
}

function renderReviewTable() {
  var container = document.getElementById('manual-review-container');
  container.classList.remove('hidden');
  var tbody = document.getElementById('manual-review-body');

  // Build ministry options
  var ministryOpts = '<option value="">--</option>' + MINISTRIES.map(function(m) {
    return '<option value="' + escapeHtml(m.name) + '">' + escapeHtml(m.name) + '</option>';
  }).join('');

  tbody.innerHTML = parsedUploadEntries.map(function(entry, idx) {
    return '<tr data-idx="' + idx + '">' +
      '<td><button class="review-row-remove" data-idx="' + idx + '">&times;</button></td>' +
      '<td><input type="text" value="' + escapeHtml(entry.firstName) + '" data-field="firstName"></td>' +
      '<td><input type="text" value="' + escapeHtml(entry.lastName) + '" data-field="lastName"></td>' +
      '<td><input type="text" value="' + escapeHtml(entry.email) + '" data-field="email"></td>' +
      '<td><input type="text" value="' + escapeHtml(entry.phone) + '" data-field="phone"></td>' +
      '<td><select data-field="ministry">' + ministryOpts.replace('value="' + escapeHtml(entry.ministry) + '"', 'value="' + escapeHtml(entry.ministry) + '" selected') + '</select></td>' +
    '</tr>';
  }).join('');

  document.getElementById('manual-review-count').textContent = parsedUploadEntries.length + ' entries';

  // Remove row handlers
  tbody.querySelectorAll('.review-row-remove').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var row = btn.closest('tr');
      row.remove();
      document.getElementById('manual-review-count').textContent =
        tbody.querySelectorAll('tr').length + ' entries';
    });
  });
}

document.getElementById('manual-review-clear').addEventListener('click', function() {
  parsedUploadEntries = [];
  document.getElementById('manual-review-container').classList.add('hidden');
  document.getElementById('manual-upload-filename').classList.add('hidden');
  document.getElementById('manual-upload-input').value = '';
});

document.getElementById('manual-review-submit').addEventListener('click', async function() {
  var btn = this;
  var rows = document.querySelectorAll('#manual-review-body tr');
  if (rows.length === 0) {
    alert('No entries to submit.');
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Submitting...';
  var apiUrl = appConfig.apiUrl;
  var count = 0;

  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var firstName = row.querySelector('[data-field="firstName"]').value.trim();
    var lastName = row.querySelector('[data-field="lastName"]').value.trim();
    if (!firstName && !lastName) continue;

    var payload = {
      firstName: firstName,
      lastName: lastName,
      email: row.querySelector('[data-field="email"]').value.trim(),
      phone: row.querySelector('[data-field="phone"]').value.trim(),
      wantsToJoinParish: false,
      ministry: row.querySelector('[data-field="ministry"]').value,
      action: 'Manual Entry'
    };

    try {
      if (apiUrl) {
        await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }
      count++;
    } catch(e) { /* continue with other entries */ }
  }

  var successEl = document.getElementById('manual-entry-success');
  successEl.textContent = count + ' signup' + (count !== 1 ? 's' : '') + ' recorded successfully!';
  successEl.classList.add('visible');
  setTimeout(function() { successEl.classList.remove('visible'); }, 5000);

  // Clear
  parsedUploadEntries = [];
  document.getElementById('manual-review-container').classList.add('hidden');
  document.getElementById('manual-upload-filename').classList.add('hidden');
  document.getElementById('manual-upload-input').value = '';

  btn.disabled = false;
  btn.textContent = 'Submit All';
});

// Single manual entry form
document.getElementById('manual-ministry').addEventListener('change', function() {
  var ministryId = this.value;
  var questionsDiv = document.getElementById('manual-questions');
  if (!ministryId) {
    questionsDiv.innerHTML = '';
    return;
  }
  var ministry = MINISTRIES.find(function(m) { return m.id === ministryId; });
  if (!ministry || !ministry.questions || ministry.questions.length === 0) {
    questionsDiv.innerHTML = '';
    return;
  }
  questionsDiv.innerHTML = '<div class="form" style="margin-top:0;">' + ministry.questions.map(function(q) {
    if (q.type === 'select') {
      return '<div class="input-group">' +
        '<label class="label">' + escapeHtml(q.label) + '</label>' +
        '<select class="select" data-qid="' + escapeHtml(q.id) + '">' +
          '<option value="">Select...</option>' +
          q.options.map(function(opt) { return '<option value="' + escapeHtml(opt) + '">' + escapeHtml(opt) + '</option>'; }).join('') +
        '</select></div>';
    } else if (q.type === 'checkbox') {
      return '<div class="input-group">' +
        '<label class="label">' + escapeHtml(q.label) + '</label>' +
        '<div class="checkbox-options" data-qid="' + escapeHtml(q.id) + '" data-type="checkbox">' +
          q.options.map(function(opt, idx) {
            return '<div class="checkbox-option">' +
              '<input type="checkbox" id="mq-' + escapeHtml(q.id) + '-' + idx + '" value="' + escapeHtml(opt) + '">' +
              '<label for="mq-' + escapeHtml(q.id) + '-' + idx + '">' + escapeHtml(opt) + '</label></div>';
          }).join('') +
        '</div></div>';
    } else {
      return '<div class="input-group">' +
        '<label class="label">' + escapeHtml(q.label) + '</label>' +
        '<input type="text" class="input" data-qid="' + escapeHtml(q.id) + '" placeholder="Answer">' +
      '</div>';
    }
  }).join('') + '</div>';
});

document.getElementById('manual-submit-btn').addEventListener('click', async function() {
  var btn = this;
  var firstName = document.getElementById('manual-firstName').value.trim();
  var lastName = document.getElementById('manual-lastName').value.trim();
  var email = document.getElementById('manual-email').value.trim();
  var phone = document.getElementById('manual-phone').value.trim();
  var ministryId = document.getElementById('manual-ministry').value;
  var newParishioner = document.getElementById('manual-newParishioner').checked;

  if (!firstName || !lastName) { alert('First and last name are required.'); return; }
  if (!ministryId) { alert('Please select a ministry.'); return; }

  var ministry = MINISTRIES.find(function(m) { return m.id === ministryId; });
  if (!ministry) return;

  var answers = {};
  document.querySelectorAll('#manual-questions [data-qid]:not([data-type="checkbox"])').forEach(function(el) {
    answers[el.dataset.qid] = el.value;
  });
  document.querySelectorAll('#manual-questions [data-type="checkbox"]').forEach(function(group) {
    var checked = [];
    group.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { checked.push(cb.value); });
    answers[group.dataset.qid] = checked.join(', ');
  });

  var questions = ministry.questions || [];
  var payload = {
    firstName: firstName, lastName: lastName, email: email, phone: phone,
    wantsToJoinParish: newParishioner, ministry: ministry.name, action: 'Manual Entry',
    q1: questions[0] ? answers[questions[0].id] || '' : '',
    q2: questions[1] ? answers[questions[1].id] || '' : '',
    q3: questions[2] ? answers[questions[2].id] || '' : ''
  };

  btn.disabled = true;
  btn.textContent = 'Recording...';
  try {
    if (appConfig.apiUrl) {
      await fetch(appConfig.apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    }
    var successEl = document.getElementById('manual-entry-success');
    successEl.textContent = 'Signup recorded for ' + firstName + ' ' + lastName + ' (' + ministry.name + ')';
    successEl.classList.add('visible');
    setTimeout(function() { successEl.classList.remove('visible'); }, 4000);
    document.getElementById('manual-firstName').value = '';
    document.getElementById('manual-lastName').value = '';
    document.getElementById('manual-email').value = '';
    document.getElementById('manual-phone').value = '';
    document.getElementById('manual-ministry').value = '';
    document.getElementById('manual-newParishioner').checked = false;
    document.getElementById('manual-questions').innerHTML = '';
  } catch(e) { alert('Error recording signup. Please try again.'); }
  btn.disabled = false;
  btn.textContent = 'Record Signup';
});

// ============================================
// FOLLOW-UP QUESTIONNAIRE SYSTEM (Rounds)
// ============================================
var followupQuestionsCache = {}; // Cache: ministryId -> { rounds: [[q1,q2,q3], [q1,q2,q3], ...] }

async function loadFollowupQuestions(ministryId, round) {
  var cacheKey = ministryId;
  if (!followupQuestionsCache[cacheKey]) {
    var apiUrl = appConfig.apiUrl;
    if (!apiUrl) return [];
    try {
      var resp = await fetch(apiUrl + '?action=getFollowupQuestions&ministryId=' + encodeURIComponent(ministryId));
      var data = await resp.json();
      followupQuestionsCache[cacheKey] = data.rounds || [];
    } catch(e) {
      console.error('Error loading follow-up questions:', e);
      return [];
    }
  }
  var rounds = followupQuestionsCache[cacheKey];
  if (round !== undefined) {
    return rounds[round - 1] || [];
  }
  return rounds;
}

function openFollowupEditor(ministryId) {
  var m = MINISTRIES.find(function(min) { return min.id === ministryId; });
  if (!m) return;

  var modal = document.getElementById('followup-editor-modal');
  modal.classList.remove('hidden');
  modal.dataset.ministryId = ministryId;
  document.getElementById('followup-editor-title').textContent = 'Follow-Up Questions: ' + m.name;

  // Load existing questions
  delete followupQuestionsCache[ministryId]; // Force reload
  loadFollowupQuestions(ministryId).then(function(rounds) {
    renderFollowupRoundsEditor(ministryId, rounds);
  });
}

function renderFollowupRoundsEditor(ministryId, rounds) {
  var container = document.getElementById('followup-rounds-container');
  container.innerHTML = '';

  if (!rounds || rounds.length === 0) {
    rounds = [[]]; // Start with one empty round
  }

  var baseUrl = window.location.origin + window.location.pathname;

  rounds.forEach(function(roundQs, roundIdx) {
    var roundNum = roundIdx + 1;
    var roundDiv = document.createElement('div');
    roundDiv.className = 'followup-round';
    roundDiv.dataset.round = roundNum;

    var linkUrl = baseUrl + '?followup=' + encodeURIComponent(ministryId) + (roundNum > 1 ? '&round=' + roundNum : '');

    var headerHtml = '<div class="followup-round-header">' +
      '<span class="followup-round-title">Round ' + roundNum + '</span>' +
      '<span class="followup-round-link" data-url="' + escapeHtml(linkUrl) + '" title="Click to copy link">&#128279; Copy Link</span>' +
    '</div>';
    roundDiv.innerHTML = headerHtml;

    var questionsContainer = document.createElement('div');
    questionsContainer.className = 'followup-editor-questions';

    for (var qi = 0; qi < 3; qi++) {
      addFollowupEditorRow(questionsContainer, roundQs[qi] || '', qi + 1, false);
    }

    roundDiv.appendChild(questionsContainer);

    // Remove round button (can't remove the first round)
    if (roundNum > 1) {
      var removeBtn = document.createElement('button');
      removeBtn.className = 'btn-remove-q';
      removeBtn.textContent = 'Remove Round ' + roundNum;
      removeBtn.style.cssText = 'display:block;margin-top:8px;font-size:13px;color:#c53030;background:none;border:none;cursor:pointer;font-family:Inter,sans-serif;';
      removeBtn.addEventListener('click', function() {
        roundDiv.remove();
        renumberRounds();
      });
      roundDiv.appendChild(removeBtn);
    }

    // Copy link handler
    roundDiv.querySelector('.followup-round-link').addEventListener('click', function() {
      var url = this.dataset.url;
      navigator.clipboard.writeText(url).then(function() {
        alert('Link copied!');
      });
    });

    container.appendChild(roundDiv);
  });
}

function renumberRounds() {
  var container = document.getElementById('followup-rounds-container');
  var roundDivs = container.querySelectorAll('.followup-round');
  var baseUrl = window.location.origin + window.location.pathname;
  var modal = document.getElementById('followup-editor-modal');
  var ministryId = modal.dataset.ministryId;

  roundDivs.forEach(function(div, idx) {
    var roundNum = idx + 1;
    div.dataset.round = roundNum;
    div.querySelector('.followup-round-title').textContent = 'Round ' + roundNum;
    var linkUrl = baseUrl + '?followup=' + encodeURIComponent(ministryId) + (roundNum > 1 ? '&round=' + roundNum : '');
    div.querySelector('.followup-round-link').dataset.url = linkUrl;
  });
}

function addFollowupEditorRow(container, qStr, num, removable) {
  var parts = (qStr || 'text|').split('|');
  var type = parts[0] || 'text';
  var label = parts[1] || '';
  var options = parts[2] || '';

  var row = document.createElement('div');
  row.className = 'followup-q-row';
  row.innerHTML =
    '<span class="followup-q-num">Q' + num + '</span>' +
    '<div class="input-group" style="max-width:100px;">' +
      '<select class="select followup-q-type" style="font-size:13px;padding:8px;">' +
        '<option value="text"' + (type === 'text' ? ' selected' : '') + '>Text</option>' +
        '<option value="select"' + (type === 'select' ? ' selected' : '') + '>Dropdown</option>' +
        '<option value="checkbox"' + (type === 'checkbox' ? ' selected' : '') + '>Checkbox</option>' +
      '</select>' +
    '</div>' +
    '<div class="input-group">' +
      '<input type="text" class="input followup-q-label" placeholder="Question text" value="' + escapeHtml(label) + '">' +
      '<input type="text" class="input followup-q-options" placeholder="Options (comma-separated)" value="' + escapeHtml(options) + '" style="margin-top:6px;' + (type === 'text' ? 'display:none;' : '') + '">' +
    '</div>';

  row.querySelector('.followup-q-type').addEventListener('change', function() {
    row.querySelector('.followup-q-options').style.display = this.value === 'text' ? 'none' : '';
  });

  container.appendChild(row);
}

document.getElementById('followup-add-round-btn').addEventListener('click', function() {
  var container = document.getElementById('followup-rounds-container');
  var existingRounds = container.querySelectorAll('.followup-round').length;
  var modal = document.getElementById('followup-editor-modal');
  var ministryId = modal.dataset.ministryId;
  var baseUrl = window.location.origin + window.location.pathname;
  var roundNum = existingRounds + 1;
  var linkUrl = baseUrl + '?followup=' + encodeURIComponent(ministryId) + '&round=' + roundNum;

  var roundDiv = document.createElement('div');
  roundDiv.className = 'followup-round';
  roundDiv.dataset.round = roundNum;
  roundDiv.innerHTML = '<div class="followup-round-header">' +
    '<span class="followup-round-title">Round ' + roundNum + '</span>' +
    '<span class="followup-round-link" data-url="' + escapeHtml(linkUrl) + '" title="Click to copy link">&#128279; Copy Link</span>' +
  '</div>';

  var questionsContainer = document.createElement('div');
  questionsContainer.className = 'followup-editor-questions';
  for (var qi = 0; qi < 3; qi++) {
    addFollowupEditorRow(questionsContainer, '', qi + 1, false);
  }
  roundDiv.appendChild(questionsContainer);

  var removeBtn = document.createElement('button');
  removeBtn.textContent = 'Remove Round ' + roundNum;
  removeBtn.style.cssText = 'display:block;margin-top:8px;font-size:13px;color:#c53030;background:none;border:none;cursor:pointer;font-family:Inter,sans-serif;';
  removeBtn.addEventListener('click', function() {
    roundDiv.remove();
    renumberRounds();
  });
  roundDiv.appendChild(removeBtn);

  roundDiv.querySelector('.followup-round-link').addEventListener('click', function() {
    navigator.clipboard.writeText(this.dataset.url).then(function() { alert('Link copied!'); });
  });

  container.appendChild(roundDiv);
});

document.getElementById('followup-editor-cancel').addEventListener('click', function() {
  document.getElementById('followup-editor-modal').classList.add('hidden');
});

document.getElementById('followup-editor-backdrop').addEventListener('click', function() {
  document.getElementById('followup-editor-modal').classList.add('hidden');
});

document.getElementById('followup-editor-save').addEventListener('click', async function() {
  var btn = this;
  var modal = document.getElementById('followup-editor-modal');
  var ministryId = modal.dataset.ministryId;
  btn.disabled = true;
  btn.textContent = 'Saving...';

  // Collect all rounds
  var roundDivs = document.querySelectorAll('#followup-rounds-container .followup-round');
  var allRounds = [];
  roundDivs.forEach(function(roundDiv) {
    var rows = roundDiv.querySelectorAll('.followup-q-row');
    var roundQs = [];
    rows.forEach(function(row) {
      var type = row.querySelector('.followup-q-type').value;
      var label = row.querySelector('.followup-q-label').value.trim();
      var options = row.querySelector('.followup-q-options').value.trim();
      if (label) {
        var qStr = type + '|' + label;
        if (type !== 'text' && options) qStr += '|' + options;
        roundQs.push(qStr);
      }
    });
    allRounds.push(roundQs);
  });

  try {
    var apiUrl = appConfig.apiUrl;
    if (apiUrl) {
      var resp = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          adminEmail: currentSession ? currentSession.email : '',
          adminAction: 'saveFollowupQuestions',
          ministryId: ministryId,
          rounds: allRounds
        })
      });
      var result = await resp.json();
      if (result.success) {
        followupQuestionsCache[ministryId] = allRounds;
        modal.classList.add('hidden');
      } else {
        alert('Error: ' + (result.error || 'Unknown error'));
      }
    }
  } catch(e) {
    alert('Network error. Please try again.');
  }

  btn.disabled = false;
  btn.textContent = 'Save All Rounds';
});

// ============================================
// FOLLOW-UP PUBLIC FORM
// ============================================
var _currentFollowupRound = 1;

async function showFollowupForm(ministryId, round) {
  round = round || followupRoundParam || 1;
  _currentFollowupRound = round;
  showView('followup');
  var formCard = document.getElementById('followup-form-card');
  var successCard = document.getElementById('followup-success-card');
  formCard.classList.remove('hidden');
  successCard.classList.add('hidden');

  var ministry = MINISTRIES.find(function(m) { return m.id === ministryId; });
  currentMinistry = ministry || { id: ministryId, name: ministryId, description: '' };

  document.getElementById('followup-ministry-name').textContent = (ministry ? ministry.name : ministryId) + (round > 1 ? ' (Round ' + round + ')' : '');
  if (ministry && ministry.description) {
    document.getElementById('followup-ministry-desc').textContent = ministry.description;
  } else {
    document.getElementById('followup-ministry-desc').textContent = 'Please answer the following questions so we can better serve you.';
  }

  if (hasSavedProfile()) {
    document.getElementById('followup-firstName').value = profile.firstName || '';
    document.getElementById('followup-lastName').value = profile.lastName || '';
    document.getElementById('followup-email').value = profile.email || '';
    document.getElementById('followup-phone').value = formatPhoneNumber(profile.phone || '');
  }

  var fPhone = document.getElementById('followup-phone');
  fPhone.removeEventListener('input', followupPhoneFormat);
  fPhone.addEventListener('input', followupPhoneFormat);

  var questions = await loadFollowupQuestions(ministryId, round);
  var questionsDiv = document.getElementById('followup-questions');

  if (questions && questions.length > 0) {
    questionsDiv.innerHTML = '<div class="form">' + questions.map(function(qStr, idx) {
      var parts = qStr.split('|');
      var type = parts[0] || 'text';
      var label = parts[1] || '';
      var options = parts[2] ? parts[2].split(',').map(function(s) { return s.trim(); }) : [];

      if (type === 'select') {
        return '<div class="input-group">' +
          '<label class="label">' + escapeHtml(label) + '</label>' +
          '<select class="select" data-fqid="fq' + idx + '">' +
            '<option value="">Select...</option>' +
            options.map(function(opt) { return '<option value="' + escapeHtml(opt) + '">' + escapeHtml(opt) + '</option>'; }).join('') +
          '</select></div>';
      } else if (type === 'checkbox') {
        return '<div class="input-group">' +
          '<label class="label">' + escapeHtml(label) + '</label>' +
          '<div class="checkbox-options" data-fqid="fq' + idx + '" data-type="checkbox">' +
            options.map(function(opt, i) {
              return '<div class="checkbox-option">' +
                '<input type="checkbox" id="fq' + idx + '-' + i + '" value="' + escapeHtml(opt) + '">' +
                '<label for="fq' + idx + '-' + i + '">' + escapeHtml(opt) + '</label></div>';
            }).join('') +
          '</div></div>';
      } else {
        return '<div class="input-group">' +
          '<label class="label">' + escapeHtml(label) + '</label>' +
          '<input type="text" class="input" data-fqid="fq' + idx + '" placeholder="Your answer">' +
        '</div>';
      }
    }).join('') + '</div>';
  } else {
    questionsDiv.innerHTML = '<p style="text-align:center;color:#666;font-size:14px;font-family:Inter,sans-serif;">No follow-up questions have been configured for this ministry yet.</p>';
  }
}

function followupPhoneFormat(e) {
  e.target.value = formatPhoneNumber(e.target.value);
}

document.getElementById('followup-submit-btn').addEventListener('click', async function() {
  var btn = this;
  var firstName = document.getElementById('followup-firstName').value.trim();
  var lastName = document.getElementById('followup-lastName').value.trim();
  var email = document.getElementById('followup-email').value.trim();
  var phone = document.getElementById('followup-phone').value.trim();

  if (!firstName || !lastName || !email) {
    alert('First name, last name, and email are required.');
    return;
  }

  var answers = {};
  document.querySelectorAll('#followup-questions [data-fqid]:not([data-type="checkbox"])').forEach(function(el) {
    answers[el.dataset.fqid] = el.value;
  });
  document.querySelectorAll('#followup-questions [data-type="checkbox"]').forEach(function(group) {
    var checked = [];
    group.querySelectorAll('input[type="checkbox"]:checked').forEach(function(cb) { checked.push(cb.value); });
    answers[group.dataset.fqid] = checked.join(', ');
  });

  var answerValues = [];
  for (var i = 0; i < 3; i++) {
    answerValues.push(answers['fq' + i] || '');
  }

  var ministryId = currentMinistry ? currentMinistry.id : followupParam;
  var ministryName = currentMinistry ? currentMinistry.name : ministryId;

  btn.disabled = true;
  btn.textContent = 'Submitting...';

  try {
    var apiUrl = appConfig.apiUrl;
    if (apiUrl) {
      await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'submitFollowupResponse',
          firstName: firstName, lastName: lastName, email: email, phone: phone,
          ministryId: ministryId, ministryName: ministryName,
          round: _currentFollowupRound,
          answers: answerValues
        })
      });
    }

    document.getElementById('followup-form-card').classList.add('hidden');
    var successCard = document.getElementById('followup-success-card');
    successCard.classList.remove('hidden');

    var orgDiv = document.getElementById('followup-organizer-info');
    if (currentMinistry && currentMinistry.organizerName) {
      var contactHtml = '';
      if (currentMinistry.organizerEmail && isValidEmail(currentMinistry.organizerEmail)) {
        contactHtml += '<a href="mailto:' + escapeHtml(currentMinistry.organizerEmail) + '">' + escapeHtml(currentMinistry.organizerEmail) + '</a>';
      }
      if (currentMinistry.organizerPhone) {
        if (contactHtml) contactHtml += ' &middot; ';
        contactHtml += '<a href="tel:' + escapeHtml(currentMinistry.organizerPhone) + '">' + escapeHtml(formatPhoneNumber(currentMinistry.organizerPhone)) + '</a>';
      }
      orgDiv.innerHTML =
        '<div class="organizer-box">' +
          '<div class="organizer-title">Ministry Contact</div>' +
          '<div class="organizer-name">' + escapeHtml(currentMinistry.organizerName) + '</div>' +
          (contactHtml ? '<div class="organizer-contact">' + contactHtml + '</div>' : '') +
        '</div>';
    } else {
      orgDiv.innerHTML = '';
    }
  } catch(e) {
    alert('Error submitting. Please try again.');
  }

  btn.disabled = false;
  btn.textContent = 'Submit';
});

// Hash change routing
window.addEventListener('hashchange', function() {
  var hash = window.location.hash;
  if (hash === '#/start' && !appConfig.setupComplete) {
    showView('start');
    showWizardStep(1);
  } else if (hash === '#/settings' && currentSession && getUserRole(currentSession.email) === 'admin') {
    showSettingsView();
  } else if (hash === '#/admin' && currentSession && getUserRole(currentSession.email) === 'admin') {
    showAdminDashboard();
  } else if (hash === '#/my-signups') {
    showMySignups();
  }
});

// ============================================
// BOOT
// ============================================
boot();
</script>

</body>
</html>
